var tent=tent||{};tent.global=window;
tent.Namespace=function(c,a){if(!a)if(c){a=c;c=tent.global}else throw"must specify namespace path";if(a===".."){if(c===tent.global)throw"cannot use '..' at top level";return c.parent}var b=a.indexOf(".");b<0||a.indexOf(".",b+1);var e=c===tent.global?"":c.fullname+"";if(e)e+=".";e+=a;if(b<0)if(typeof c[a]=="undefined"){this.fullname=e;this.name=a;this.parent=c;c[a]=this}else if(!c[a]instanceof tent.Namespace)throw'error creating namespace: "'+e+'" is not a Namespace object';else return c[a];else return new tent.Namespace(new tent.Namespace(c,
a.slice(0,b)),a.slice(b+1));return this};tent.__tentTmp=new tent.Namespace("__tentTmp");tent.__tentTmp.Namespace=tent.Namespace;tent.__tentTmp.fullname="tent";tent.__tentTmp.name="tent";tent.__tentTmp.parent=tent.global;tent.__tentTmp.global=tent.global;tent.global.tent=tent.__tentTmp;delete tent.__tentTmp;try{delete tent.global.__tentTmp}catch(ex){}tent.Namespace.prototype.expand=function(c){c(this);return this};
tent.declare=function(){for(var c,a=0;a<arguments.length;a++){var b=arguments[a];if(b instanceof tent.Namespace)c=b;else if(typeof b=="string")c=c?new tent.Namespace(c,b):new tent.Namespace(b);else if(b instanceof Function){if(!c)throw"no namespace provided";c.expand(b)}else throw"invalid argument type at index "+a+", expected Namespace, string, Function";}return c};
tent.isDOMObject=function(c){if(typeof Node!="undefined"&&c instanceof Node||typeof Element!="undefined"&&c instanceof Element||typeof NodeList!="undefined"&&c instanceof NodeList||c===window||c===document)return true;if(typeof o==="object"&&typeof o.nodeType==="number"&&typeof o.nodeName==="string")return true;return false};
tent.DOMPropertyNames=["nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate","dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter",
"id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin","isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove",
"title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue","onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout",
"aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart","aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all",
"onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name","nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate",
"dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter","id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin",
"isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove","title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue",
"onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout","aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart",
"aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all","onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name"];tent.isDOMProperty=function(c){if(!tent.DOMPropertyNames.indexOf)tent.DOMPropertyNames.indexOf=tent.arrays.functions.indexOf;return tent.DOMPropertyNames.indexOf(c)>=0};
tent.domClone=function(c,a){if(c===null)return null;else if(typeof c=="undefined")return;else if(typeof c=="object"){if(a&&a.onlyForTracking&&tent.changes.getPropertyInterceptMode()!=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM)return c;if(a){if(a.deep&&!a.deepStack)a.deepStack=tent.arrays.addFunctions([])}else a={};if(c instanceof Array)for(var b=[],e=0;e<c.length;e++)if(a.deep){a.deepStack.push(c);a.deepStack.lastIndexOf(c[e])<0&&b.push(tent.domClone(c[e],a));a.deepStack.pop()}else b.push(c[e]);
else{b=document.createElement("span");for(var g in c)if(!a.clonePrivates&&g.substr(0,1)=="_")b[g]=c[g];else if(a.deep&&typeof c[g]=="object"){a.deepStack.push(c);if(a.deepStack.indexOf(c[e])<0)b[g]=tent.domClone(c[g],a);a.deepStack.pop()}else b[g]=c[g]}return b}return c};tent.declare("tent.arrays",function(c){c.addFunctions=function(a,b){for(var e in c.functions)if(b||!(a[e]instanceof Function))a[e]=c.functions[e];return a};c.functions={indexOf:function(a){for(var b=0,e=this.length;b<e;b++)if(this[b]===a)return b;return-1},lastIndexOf:function(a){for(var b=this.length-1;b>0;b--)if(this[b]===a)return b;return-1},filter:function(a){for(var b=[],e=0,g=this.length;e<g;e++)a(this[e])&&b.push(this[e]);return b},remove:function(){for(var a,b=0,e=this.length;b<e;b++)for(var g=
0,i=arguments.length;g<i;g++)if(this[b]==arguments[g]){this.splice(b,1);a=true;b--;e--;break}if(a)return true},set:function(a,b){this.splice(a,1,b)},pushUnique:function(){if(arguments.length==1){for(var a=false,b=0,e=this.length;b<e;b++)if(this[b]==arguments[0]){a=true;break}a||this.push(arguments[0])}else{a=[];b=0;for(e=this.length;b<e;b++)for(var g=0,i=arguments.length;g<i;g++)if(this[b]==arguments[g])a[g]=true;g=0;for(i=arguments.length;g<i;g++)a[g]||this.push(arguments[g])}return this.length},
clone:function(){var a=[];Array.prototype.push.apply(a,this);return a},isCloneOf:function(a){if(!a)return false;if(this.length!=a.length)return false;if(this===a)return false;for(var b=this.length;b>=0;b--)if(this[b]!=a[b])return false;return true}};return c});tent.declare("tent.coreTypes",function(c){c.Enum=function(){this.__names__=[];this.__values__={};this.__flags__=false;this.__enum=true;arguments.length>0&&this.add.apply(this,arguments)};c.Enum.prototype.getName=function(e){if(this.__names__)if(this.__names__[e])return this.__names__[e];else if(this.__flags__){e=e;var g="",i;for(i in this.__values__)if(this.__values__[i]&&(this.__values__[i]&e)===this.__values__[i]){e-=this.__values__[i];if(g)g+="|";g+=i}if(g&&e===0)return g;else if(g)return g+"|"+
e}};c.Enum.prototype.__freeValue__=function(){var e=typeof this.__maxValue__=="undefined"?1:this.__maxValue__+1;if(this.__values__&&typeof this.__values__[e]!="undefined")for(var g in this.__values__)if(this.__values__[g]>=e){this.__maxValue__=this.__values__[g];e=this.__values__[g]+1}if(this.__flags__)e=e<1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)));return e};c.Enum.prototype.useFlags=function(e){this.__flags__=e;return this};var a=function(e,g,i){e[g]=i;e.__values__[g]=i;if(typeof e.__names__[i]==
"undefined")e.__names__[i]=g;if(typeof e.__maxValue__=="undefined"||e.__maxValue__<i)e.__maxValue__=i};c.Enum.prototype.add=function(){if(arguments.length<1)return this;for(var e,g,i=0,l=arguments.length;i<l;i++){e=arguments[i];if(e instanceof Array)this.add.apply(this,e);else if(typeof e=="object")for(g in e)if(e.hasOwnProperty(g)){var d=this.__values__[g];if(!d instanceof Number||typeof this.__names__[d]!="undefined")d=this.__freeValue__();a(this,g,d)}if(typeof e=="string")if(e){e=e.split(",");
d=0;for(var f=e.length;d<f;d++){g=e[d].replace(/^\s+/g,"").replace(/\s+$/g,"");if(g=="_FLAGS")this.useFlags(true);else{if(typeof this.__values__[g]!="undefined")if(this.__values__[g]instanceof Number)throw"Enum duplicate name found: "+g;else throw"Enum invalid name (reserved): "+g;if(d==f-1&&i<l-1&&typeof arguments[i+1]=="number"){a(this,g,arguments[i+1]);i++}else a(this,g,this.__freeValue__())}}}}return this};var b=function(){var e=this._name+(this._count>1?"("+this._count+")":"");if(this._childrenCount){e+=
"{";var g=0,i;for(i in this)if(i.substr(0,1)!="_"&&typeof this[i]=="object"){if(g>0)e+=", ";e+=this[i];g++}e+="}"}return e};c.NameCounter=function(e){this.root={_name:e||"",_count:0,toString:b}};c.NameCounter.prototype.__nodeAdd__=function(e,g){e._count=(e._count||0)+g;if(e._parent){if(e._count==0&&!e._childrenCount){e._parent._childrenCount&&e._parent._childrenCount--;delete e._parent[e._name]}this.__nodeAdd__(e._parent,g)}};c.NameCounter.prototype.add=function(e,g){if(typeof g!="number")g=1;for(var i=
e.split("."),l=this.root,d=0;d<i.length;d++){if(typeof l[i[d]]=="undefined"){l._childrenCount=(l._childrenCount||0)+1;l[i[d]]={_parent:l,_name:i[d],_count:0,toString:b}}l=l[i[d]]}this.__nodeAdd__(l,g)};c.NameCounter.prototype.reset=function(){this.root={_name:this.root._name,_count:0,toString:b}};c.NameCounter.prototype.toString=function(){return b.apply(this.root)};return c});tent.declare("tent.logging",function(c){c.Levels=new tent.coreTypes.Enum("TRACE,DEBUG,INFO,WARN,ERROR,FATAL");c.Log=function(){arguments.length>0&&this.add.apply(this,arguments);if(typeof console!="undefined")this.out={TRACE:function(a){console.trace?console.trace(a):console.info(a)},DEBUG:function(a){console.debug?console.debug(a):console.info(a)},INFO:function(a){console.info(a)},WARN:function(a){console.warn(a)},ERROR:function(a){console.error(a)},FATAL:function(a){console.error(a)}};this.listeners=
[]};tent.log=new c.Log;c.Log.prototype.bind=function(a,b){if(!a instanceof Function)throw"a callback Function must be provided";var e=b;if(typeof e!="number")e=typeof e=="undefined"?c.Levels.TRACE:c.Levels[e]||c.Levels.TRACE;this.listeners.push({callback:a,level:e})};c.Log.prototype.unbind=function(a){if(!a instanceof Function)throw"a callback Function must be provided";for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback===a&&this.listeners.splice(b,1)};c.Log.prototype.notify=function(a,
b){var e=b;if(typeof e!="number")e=e?c.Levels[e]||c.Levels.INFO:c.Levels.INFO;for(var g=0,i=this.listeners.length;g<i;g++){var l=this.listeners[g];if(l.callback)if(typeof l.level=="undefined"||l.level<=e)l.callback(a,b)}};c.Log.prototype.__log__=function(a,b){b=b||c.Levels.INFO;var e=c.Levels.getName(b);this.out&&this.out[e]&&this.out[e](c.Levels.getName(b)+" "+a);this.notify(a,b)};c.Log.prototype.trace=function(){this.__log__(this.stringOrStringify.apply(this,arguments),c.Levels.TRACE)};c.Log.prototype.debug=
function(){this.__log__(this.stringOrStringify.apply(this,arguments),c.Levels.DEBUG)};c.Log.prototype.info=function(){this.__log__(this.stringOrStringify.apply(this,arguments),c.Levels.INFO)};c.Log.prototype.warn=function(){this.__log__(this.stringOrStringify.apply(this,arguments),c.Levels.WARN)};c.Log.prototype.error=function(){this.__log__(this.stringOrStringify.apply(this,arguments),c.Levels.ERROR)};c.Log.prototype.fatal=function(){this.__log__(this.stringOrStringify.apply(this,arguments),c.Levels.FATAL)};
c.Log.prototype.stringify=function(){var a="";try{var b=arguments.length>0&&arguments[arguments.length-1]&&arguments[arguments.length-1]._options?arguments[arguments.length-1]:{_options:true};if(!b.deepStack){b.deepStack=[];tent.arrays.addFunctions(b.deepStack)}for(var e=0,g=arguments.length;e<g;e++)if(!(arguments[e]&&typeof arguments[e]=="object"&&arguments[e]._options))if(!(arguments[e]instanceof Function)){if(a)a+=", ";if(b.deepStack.length>3||b.deepStack.lastIndexOf(arguments[e])>=0)a+="#";else if(typeof arguments[e]==
"undefined")a+="undefined";else if(arguments[e]==null)a+="null";else if(arguments[e]instanceof Array){var i=tent.arrays.functions.clone.apply(arguments[e]).filter(function(h){if(h instanceof Function)return false;if(b.deepStack.lastIndexOf(h>=0))return false;return true});i.push(b);b.deepStack.push(arguments[e]);a+="[";if(b.deepStack.length<4)a+=this.stringify.apply(this,i);b.deepStack.pop();a+="]"}else if(typeof arguments[e]=="string")a+='"'+arguments[e]+'"';else if(arguments[e]instanceof Date)a+=
'"'+arguments[e]+'"';else if(typeof arguments[e]=="object"){var l="";b.deepStack.push(arguments[e]);if(b.deepStack.length<4)for(var d in arguments[e])if(!(arguments[e][d]instanceof Function))if(!(b.deepStack.lastIndexOf(arguments[e][d])>=0)){if(l)l+=", ";l+='"'+d+'": '+this.stringify.apply(this,[arguments[e][d],b])}b.deepStack.pop();a+="{"+l+"}"}else a+=arguments[e]}}catch(f){return"#err#"}return a};c.Log.prototype.stringOrStringify=function(){return arguments.length==1&&typeof arguments[0]=="string"?
arguments[0]:this.stringify.apply(this,arguments)};return c});tent.declare("tent.changes",function(c){c.EventTypes=new tent.coreTypes.Enum("ANY,MANYCHANGES,CHANGING,CHANGED,ADDING,ADDED,REMOVING,REMOVED");c.InterceptorTypes=new tent.coreTypes.Enum("PROPERTY,FUNCTION");c.PropertyInterceptModes=new tent.coreTypes.Enum("NONE,DEFINESETTER,DEFINEPROPERTY,DEFINEPROPERTYONLYDOM");var a;c.getPropertyInterceptMode=function(){if(typeof a=="undefined"){var d={};if(Object.defineProperty)try{Object.defineProperty(d,"myproperty",{get:function(){return this._myproperty},set:function(k){this._myproperty=
k}});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=c.PropertyInterceptModes.DEFINEPROPERTY}catch(f){if(document&&document.createElement){d=document.createElement("span");try{Object.defineProperty(d,"myproperty",{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=c.PropertyInterceptModes.DEFINEPROPERTYONLYDOM}catch(h){}}}if(typeof a=="undefined"){d={};if(d.__defineSetter__)try{d.__defineGetter__("myproperty",
function(){return this._myproperty});d.__defineSetter__("myproperty",function(k){this._myproperty=k});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=c.PropertyInterceptModes.DEFINESETTER}catch(j){}}if(typeof a=="undefined")a=c.PropertyInterceptModes.NONE}return a};c.getPropertyInterceptModeName=function(){return c.PropertyInterceptModes.getName(c.getPropertyInterceptMode())};c.Change=function(d,f,h){this.subject=d;this.eventType=f;this.data=h};c.ChangeStringifiers=
[];c.Change.prototype.toString=function(){if(typeof c.ChangeStringifiers[this.eventType]!="undefined")c.ChangeStringifiers[this.eventType](this);else{var d=c.EventTypes.getName(this.eventType);if(this.eventType==c.EventTypes.MANYCHANGES){d+=": ";if(this.data.length<=3)for(var f=0,h=this.data.length;f<h;f++)d+=this.data[f].toString()+",";else{var j={};f=0;for(h=this.data.length;f<h;f++)j[this.data[f].eventType]=(j[this.data[f].eventType]||0)+1;for(var k in j)d+=c.EventTypes.getName(k)+"("+j[k]+"),"}}else{if(this.data.propertyName){d+=
" "+this.data.propertyName;if(this.eventType==c.EventTypes.CHANGING)d+=" from "+this.data.current+" to "+this.data.newValue;else if(this.eventType==c.EventTypes.CHANGED)d+=" from "+this.data.oldValue+" to "+this.data.current;d+=" (on "+this.subject+")"}if(this.data.items){f=this.data.items;d+=" "+f.length+(f.length>1?" items":" item");if(typeof this.data.index!="undefined")d+=" at index "+this.data.index;d+=this.data.propertyName?" ("+this.subject.__parent__+"."+this.data.propertyName+")":" (["+f+
"])"}}return"[Change: "+d+"]"}};c.Observable=function(d){this.subject=d;this.handlers={};this.interceptors={};this.suspended=false};c.Observable.prototype.interceptFunction=function(d,f){if(!this.interceptors[d]){var h="_"+d,j={name:d,_name:h,type:c.InterceptorTypes.FUNCTION};this.subject[h]=this.subject[d];this.subject[d]=f;this.interceptors[d]=j}};c.parent.pset=function(d,f,h){if(d.__observable__&&d.__observable__.interceptors&&d.__observable__.interceptors[f])d.__observable__.interceptors[f].newsetter.call(d,
h);else d[f]=h};c.parent.pget=function(d,f){return d.__observable__&&d.__observable__.interceptors&&d.__observable__.interceptors[f]?d.__observable__.interceptors[f].newgetter.call(d):d[f]};c.Observable.prototype.interceptProperty=function(d,f,h,j){if(!this.interceptors[d]){var k={name:d,type:c.InterceptorTypes.PROPERTY,newsetter:j,newgetter:h};if(f){f="_"+d;try{this.subject[f]=this.subject[d]}catch(n){this.subject[f]=null}k._name=f}f=c.getPropertyInterceptMode();if(f==c.PropertyInterceptModes.DEFINEPROPERTY||
f==c.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject)){try{k.descriptor=Object.getOwnPropertyDescriptor(this.subject,d)}catch(m){}f={};if(h)f.get=h;if(j)f.set=j;try{Object.defineProperty(this.subject,d,f)}catch(p){tent.log.warn("Object.defineProperty for property '"+d+"' failed: "+p)}}else if(f==c.PropertyInterceptModes.DEFINESETTER){try{k.getter=this.subject.__lookupGetter__(d);k.setter=this.subject.__lookupSetter__(d)}catch(q){}if(h)try{this.subject.__defineGetter__(d,
h)}catch(r){tent.log.warn("Object.__defineGetter__ for property '"+d+"' failed: "+r)}if(j)try{this.subject.__defineSetter__(d,j)}catch(s){tent.log.warn("Object.__defineSetter__ for property '"+d+"' failed: "+s)}}if(k)this.interceptors[d]=k}};var b=function(d,f){return function(h){var j=this[f];if(j!=h){this.__observable__.notifyChange(c.EventTypes.CHANGING,{propertyName:d,current:j,newValue:h});this[f]=h;this.__observable__.notifyChange(c.EventTypes.CHANGED,{propertyName:d,current:h,oldValue:j})}}},
e=function(d,f){return function(){return this[f]}},g=function(d,f){return f.substr(0,1)!="_"};c.Observable.prototype.interceptProperties=function(d){d||(d={});var f=d.propertyFilter||g,h=d.backPropertyPrefix||"_";!d.trackDomProperties&&this.isDOMObject();for(var j in this.subject)if(!tent.isDOMProperty(j))try{if(typeof this.subject[j]!="function"&&f(this.subject,j)){d=h+j;this.interceptProperty(j,d,e(j,d),b(j,d))}}catch(k){tent.log.warn("Error intercepting property '"+j+"': "+k)}};c.Observable.prototype.isDOMObject=
function(){if(typeof this._isDomObject=="undefined")this._isDOMObject=tent.isDOMObject(this.subject);return this._isDOMObject};c.Observable.prototype.interceptArrayModifiers=function(){var d=this.subject;if(!d instanceof Array)return false;this.interceptFunction("push",function(){var f=this.length,h=h=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(c.EventTypes.ADDING,{items:h,index:f,propertyName:this.__propertyName__});this._push.apply(this,arguments);this.__observable__.notifyChange(c.EventTypes.ADDED,
{items:h,index:f,propertyName:this.__propertyName__})});this.interceptFunction("unshift",function(){var f=f=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(c.EventTypes.ADDING,{items:f,index:0,propertyName:this.__propertyName__});this._unshift.apply(this,arguments);this.__observable__.notifyChange(c.EventTypes.ADDED,{items:f,index:0,propertyName:this.__propertyName__})});this.interceptFunction("pop",function(){var f=this.length-1;this.__observable__.notifyChange(c.EventTypes.REMOVING,
{items:[this[f]],index:f,propertyName:this.__propertyName__});var h=this._pop();this.__observable__.notifyChange(c.EventTypes.REMOVED,{items:[h],index:f,propertyName:this.__propertyName__});return h});this.interceptFunction("shift",function(){this.__observable__.notifyChange(c.EventTypes.REMOVING,{items:[this[0]],index:0,propertyName:this.__propertyName__});var f=this._shift();this.__observable__.notifyChange(c.EventTypes.REMOVED,{items:[f],index:0,propertyName:this.__propertyName__});return f});
this.interceptFunction("splice",function(f,h){var j;h&&h>0&&this.__observable__.notifyChange(c.EventTypes.REMOVING,{items:this.slice(f,f+h),index:f,propertyName:this.__propertyName__});if(arguments.length>2){j=Array.prototype.slice.call(arguments,2);this.__observable__.notifyChange(c.EventTypes.ADDING,{items:j,index:f,propertyName:this.__propertyName__})}if(j&&j.length>0){var k=j.slice(0);k.unshift(f,h);k=this._splice.apply(this,k)}else k=this._splice(f,h);k&&k.length>0&&this.__observable__.notifyChange(c.EventTypes.REMOVED,
{items:k,index:f,propertyName:this.__propertyName__});arguments.length>2&&this.__observable__.notifyChange(c.EventTypes.ADDED,{items:j,index:f,propertyName:this.__propertyName__});return k});d.setLength=function(f){if(this.length>f)this.splice(f,this.length-f);else this.lengh=f};d.remove=tent.arrays.functions.remove;d.set=tent.arrays.functions.set;if(!d.indexOf)d.indexOf=tent.arrays.functions.indexOf;if(!d.lastIndexOf)d.lastIndexOf=tent.arrays.functions.lastIndexOf;return true};c.Observable.prototype.removeInterceptor=
function(d){var f=this.interceptors[d];if(f._name){if(f.type!=c.InterceptorTypes.FUNCTION){try{delete this.subject[f.name]}catch(h){tent.log.warn("Error deleting property interceptor '"+f.name+"': "+h)}var j=c.getPropertyInterceptMode();if(j==c.PropertyInterceptModes.DEFINEPROPERTY||j==c.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject))f.descriptor&&f.descriptor.name&&Object.defineProperty(this.subject,d,f.descriptor);else if(j==c.PropertyInterceptModes.DEFINESETTER){f.getter&&
this.subject.__defineGetter__(d,f.getter);f.setter&&this.subject.__defineSetter__(d,f.setter)}}try{this.subject[f.name]=this.subject[f._name]}catch(k){(j=tent.isDOMObject(this.subject))||tent.log.warn("Error restoring property '"+f.name+"' value: "+k)}try{delete this.subject[f._name]}catch(n){tent.log.warn("Error deleting back storage property '"+f._name+"': "+n)}}else if(f.type!=c.InterceptorTypes.FUNCTION){j=this.subject[f.name];delete this.subject[f.name];this.subject[f.name]=j}delete f[d]};c.Observable.prototype.removeInterceptors=
function(){for(var d in this.interceptors)try{this.removeInterceptor(d)}catch(f){tent.log.warn("Error removing interceptor from property '"+d+"': "+f)}this.interceptors={}};c.Observable.prototype.suspend=function(){this.suspended=true};c.Observable.prototype.resume=function(){this.suspended=false;if(this.changesWhileSuspended){if(this.changesWhileSuspended.length<5)for(var d=0,f=this.changesWhileSuspended.length;d<f;d++)this.notifyChange(this.changesWhileSuspended[d]);else this.changesWhileSuspended.length>
1&&this.notifyChange(c.EventTypes.MANYCHANGES,this.changesWhileSuspended);delete this.changesWhileSuspended}};c.Observable.prototype.isValidHandler=function(d){if(!d)return false;if(typeof d=="function"||typeof d=="object"&&typeof d.handle=="function")return true;return false};c.Observable.prototype.bind=function(d,f){if(!f)if(this.isValidHandler(d)){f=d;d=c.EventTypes.ANY}else throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!this.isValidHandler(f))throw"must specify a handler: function (Change) or and object with a handle(Change) function";
if(!d)d=c.EventTypes.ANY;var h=this.handlers[d];h||(h=this.handlers[d]=[]);for(var j=0;j<h.length;j++)if(h[j]==f)return false;this.handlers[d].push(f);return true};c.Observable.prototype.unbind=function(d,f){if(!f)if(this.isValidHandler(d)){f=d;d=c.EventTypes.ANY}else throw"must specify a handler to remove";if(!this.isValidHandler(f))throw"must specify a handler to remove";if(!d)d=c.EventTypes.ANY;var h=this.handlers[d],j=false;if(h)for(var k=0,n=h.length;k<n;k++)if(h[k]==f){h.splice(k,1);k--;n--;
j=true}return j};c.Observable.prototype.unbindWhere=function(d){var f=false,h;for(h in this.handlers)for(var j=this.handlers[h],k=0,n=j.length;k<n;k++)if(d(j[k])){j.splice(k,1);k--;n--;f=true}return f};c.Observable.prototype.notifyHandler=function(d,f){try{return typeof f=="function"?f.call(this.subject,d):f.handle(d)}catch(h){var j="";if(h.stack)j+=h.stack;else if(h.message)j+=h.message;tent.log.error("Change Handler Error: "+h+(j?"\n"+j:""));return h}};c.Observable.prototype.notifyChange=function(d,
f){if(this.suspended){if(!this.changesWhileSuspended){this.changesWhileSuspended=[];if(!this.changesWhileSuspended.filter)this.changesWhileSuspended.filter=tent.arrays.functions.filter;this.changesWhileSuspended.findByEventType=function(){for(var m=0,p=this.length;m<p;m++)for(var q=0,r=arguments.length;q<r;q++)if(this[m].eventType==arguments[q])return this[m]};this.changesWhileSuspended.findPropertyChanged=function(m,p){for(var q=0,r=this.length;q<r;q++)if(this[q].subject==m&&this[q].eventType==c.EventTypes.CHANGED&&
this[q].data.propertyName==p)return this[q]};this.changesWhileSuspended.findArrayChanged=function(){for(var m=0,p=this.length;m<p;m++)if(this[m].subject==subject&&(this[m].eventType==c.EventTypes.ADDED||this[m].eventType==c.EventTypes.REMOVED))return this[m]}}this.changesWhileSuspended.push(new c.Change(this.subject,d,f))}else{var h;h=d instanceof c.Change?d:new c.Change(this.subject,d,f);var j=this.handlers[d];if(j)for(var k=0,n=j.length;k<n;k++)this.notifyHandler(h,j[k]);if(j=this.handlers[c.EventTypes.ANY]){k=
0;for(n=j.length;k<n;k++)this.notifyHandler(h,j[k])}}};var i;c.Observable.prototype.log=function(d){if(d){i||(i=c.LogHandler());return this.bind(i)}else if(i)return this.unbind(i);return false};c.LogHandler=function(d){if(typeof d=="undefined")d="";else if(d&&d[d.length-1]!=" ")d+=" ";return function(f){tent.log.info(d+f.toString())}};var l=function(d){var f={};for(opName in d)if(opName!="deepStack"&&opName!="liveHandler")f[opName]=d[opName];d=function(h){if(h.eventType==c.EventTypes.CHANGED){if(typeof h.data.current==
"object")if(f.deepOverDOM||!tent.isDOMObject(h.data.current)){f.deepStack=[h.data.subject];c.track(h.data.current,f);delete f.deepStack}}else if(h.eventType==c.EventTypes.ADDED)for(var j=0,k=h.data.items.length;j<k;j++)if(typeof h.data.items[j]=="object")if(f.deepOverDOM||!tent.isDOMObject(h.data.current)){f.deepStack=[h.data.subject];c.track(h.data.items[j],f);delete f.deepStack}};d.isLivePropagator=true;return d};c.track=function(d,f){f||(f={});if(typeof d!="object"){if(!f.deepStack)throw"Cannot track changes of "+
typeof d;return false}else if(d==null){if(!f.deepStack)throw"Cannot track changes of null";return false}var h=d instanceof Array,j=false;if(!f.remove&&!f.removeAll&&!d.__observable__){if(f.observable&&(!f.observable.subject||f.observable.subject==d)){d.__observable__=f.observable;d.__observable__.subject=d}else d.__observable__=new c.Observable(d);j=true;d.getObservable=function(){return this.__observable__};if(!f.interceptOptions)f.interceptOptions={};h?d.__observable__.interceptArrayModifiers(f.interceptOptions):
d.__observable__.interceptProperties(f.interceptOptions)}if(f.bindings)for(var k=0,n=f.bindings.length;k<n;k++){var m=f.bindings[k];if(h&&m.bindArrays!=false||!h&&m.bindObjects!=false)if(f.remove){if(d.__observable__&&d.__observable__.unbind(m.eventType,m.handler))j=true}else if(d.__observable__.bind(m.eventType,m.handler))j=true}if(f.log)if(d.__observable__&&d.__observable__.log(!f.remove))j=true;if(f.reverseProperties)if(f.remove){if(d.__observable__&&d.__observable__.unbind(tent.changes.reverseProperties.getHandler()))j=
true}else if(d.__observable__.bind(tent.changes.reverseProperties.getHandler()))j=true;if(f.removeAll&&d.__observable__){d.__observable__.removeInterceptors();delete d.__observable__.subject;delete d.__observable__;j=true}if(f.deep&&f.live&&!f.remove)if(f.remove){if(d.__observable__.unbindWhere(function(q){return q.isLivePropagator}))j=true}else{if(!f.liveHandler)f.liveHandler=l(f);if(d.__observable__.bind(f.liveHandler))j=true}if(f.deep){if(f.deepStack)f.deepStack.push(d);else{f.deepStack=[d];if(!f.deepStack.lastIndexOf)f.deepStack.lastIndexOf=
tent.arrays.functions.lastIndexOf}if(h){k=0;for(n=d.length;k<n;k++)if((h=d[k])&&typeof h=="object"&&f.deepStack.lastIndexOf(h)<0)if(c.track(h,f))j=true}else{k=f.propertyFilter||g;for(var p in d)if(typeof d[p]!="function"&&k(d,p)){h=d[p];if(f.deepOverDOM||!tent.isDOMObject(subject))if(typeof h=="object"&&f.deepStack.lastIndexOf(h)<0)if(c.track(h,f))j=true}}f.deepStack.pop()}return j};c.untrack=function(d,f){if(f){if(!f.removeAll)f.removeAll=true}else f={removeAll:true};return c.track(d,f)};c.isTracked=
function(d){return d.__observable__&&d.__observable__ instanceof c.Observable};c.bind=function(d,f){var h;if(typeof f=="string"){h=f;f={bindings:[]}}else if(typeof f=="function")f={bindings:[{handler:f}]};else if(typeof f=="object"&&typeof f.handle=="function")f={bindings:[{handler:f}]};if(arguments.length>2){if(f){if(!f.bindings)f.bindings=[]}else f={bindings:[]};for(var j=2;j<arguments.length;j++)f.bindings.push({eventType:h,handler:arguments[j]})}return c.track(d,f)};c.unbind=function(d,f){var h;
if(typeof f=="string"){h=f;f={bindings:[]}}else if(typeof f=="function")f={bindings:[{handler:f}]};else if(typeof f=="object"&&typeof f.handle=="function")f={bindings:[{handler:f}]};if(arguments.length>2){if(f){if(!f.bindings)f.bindings=[]}else f={bindings:[]};for(var j=2;j<arguments.length;j++)f.bindings.push({eventType:h,handler:arguments[j]})}if(f){if(!f.remove)f.remove=true}else f={remove:true};return c.track(d,f)};return c});tent.declare("tent.databinding",function(c){var a=function(e,g,i,l,d){var f={};f.handle=function(h){var j=false;if(h.eventType==tent.changes.EventTypes.ADDED||h.eventType==tent.changes.EventTypes.REMOVED||h.eventType==tent.changes.EventTypes.CHANGED)if(d.deep)j=true;else{var k=e;if(h.subject==e)j=true;else for(var n=g.split("."),m=0;m<n.length;m++){var p=n[m];k=k[p];if(k==h.subject){j=true;break}}}else if(h.eventType==tent.changes.EventTypes.MANYCHANGES)j=true;if(j){h=e;k=null;if(g){n=g.split(".");
for(m=0;m<n.length;m++){p=n[m];k=h;h=h[p];if(h==null||typeof h=="undefined")break;else tent.changes.bind(h,{live:d.live,log:d.log,deepStack:[k],bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:this}]})}}n=i;if(p=l){k=l.split(".");for(m=0;m<k.length;m++){p=k[m];tgtParent=n;n=n[p];if(n==null||typeof n=="undefined"){if(m<k.length-1)j=false;break}}n=tgtParent}if(j)if(d.template)c.parseTemplate(d.template,h,n,p);else{if(typeof d.format=="function")h=d.format(h);if(n[p]!=h)n[p]=h}}};return f};
c.bind=function(e,g,i,l,d){d||(d={});var f=a(e,g,i,l,d);if(d.deep){if(d.bidirectional)throw"cannot use bidirectional databinding when using a deep tracking";tent.changes.bind(e,{deep:true,live:d.live,log:d.log,bindings:[{handler:f}]})}else{if(d.bidirectional){if(d.template)throw"cannot use bidirectional databinding when using a template";var h=a(i,l,e,g,d);tent.changes.bind(i,{live:d.live,log:d.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:h}]})}tent.changes.bind(e,{live:d.live,
log:d.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:f}]})}e=!g?e:e[g];if(d.template)c.parseTemplate(d.template,e,i,l);else if(i[l]!=e)i[l]=e};var b={};c.parseTemplate=function(e,g,i,l){var d;try{var f=b[e];if(!f){var h="var p=[],print=function (){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").replace(/'(?=[^#]*#>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<#=(.+?)#>/g,"',$1,'").split("<#").join("');").split("#>").join("p.push('")+
"');}return p.join('');";f=new Function("obj",h);b[e]=f}d=f(g)}catch(j){d="< # ERROR: "+j.message+" # >"}if(i)if(l)i[l]=d;else i.innerHTML=d;return d};return c});tent.declare("tent.changes.reverseProperties",function(c){c.setReverseProperty=function(b,e,g){g||(g={});g.cardinality=g.cardinality?g.cardinality.toLowerCase():"11";if(!g.reverse)g.reverse=e+"Of";var i={name:g.reverse,cardinality:g.cardinality};if(g.cardinality.substr(0,1)==="n"||g.cardinality.substr(0,1)==="m")i.isArray=true;if(!b.__reverseProperties__)b.__reverseProperties__={};if(g.cardinality.substr(1,1)==="n"||g.cardinality.substr(1,1)==="m"){if(typeof b[e]=="undefined"||!(b[e]instanceof Array))b[e]=
[];b.__reverseProperties__[e]=i;b[e].__parent__=b;b[e].__reverseProperty__=i}else{if(typeof b[e]=="undefined")b[e]=null;b.__reverseProperties__[e]=i}};c.setReverseProperties=function(b,e){if(e)for(var g in e)e[g].reverse&&c.setReverseProperty(b,g,e[g])};c.Set=function(b){this.properties=b};c.Set.prototype.create=function(){var b={};c.setReverseProperties(b,this.properties);return b};c.Set.prototype.applyTo=function(){var b=[];b.bind=function(g){g||(g={});g.reverseProperties=true;for(var i=0;i<this.length;i++){var l=
this[i];if(l.__reverseProperties__){tent.changes.bind(l,g);var d=l.__reverseProperties__,f;for(f in d)if(d.hasOwnProperty(f))if(d[f].cardinality&&(d[f].cardinality[1]=="n"||d[f].cardinality[1]=="m")){if(!(l[f]instanceof Array)){l[f]=[];l[f].__parent__=l;l[f].__reverseProperty__=l.__reverseProperties__[f]}tent.changes.bind(l[f],g)}}}};if(this.properties){for(var e=0;e<arguments.length;e++)c.setReverseProperties(arguments[e],this.properties);b.push.apply(b,arguments)}return b};c.Set.prototype.applyToAndBind=
function(){if(this.properties&&this.properties.length>0)for(var b=0;b<arguments.length;b++){c.setReverseProperties(arguments[b],this.properties);tent.changes.bind(arguments[b],{deep:true,reverseProperties:true})}};var a;c.getHandler=function(){a||(a=function(b){if(b.eventType==tent.changes.EventTypes.ADDED){var e=b.data.items;if(e&&b.subject&&b.subject.__reverseProperty__){var g=b.subject.__reverseProperty__;b=b.subject.__parent__;for(var i=0,l=e.length;i<l;i++){var d=e[i];if(g.isArray){d[g.name]||
(d[g.name]=[]);d[g.name].indexOf(b)<0&&d[g.name].push(b)}else if(d[g.name]!=b){if(typeof d[g.name]!="undefined"&&d[g.name]!=null)throw Error("this."+g.name+" is set. Remove this from its current array before adding it to this array");d[g.name]=b}}}}else if(b.eventType==tent.changes.EventTypes.REMOVED){if((e=b.data.items)&&b.subject&&b.subject.__reverseProperty__){g=b.subject.__reverseProperty__;b=b.subject.__parent__;i=0;for(l=e.length;i<l;i++){d=e[i];if(g.isArray){if(d=d[g.name])for(var f=0,h=d.length;f<
h;f++)if(d[f]===b){d.splice(f,1);f--;h--}}else if(d[g.name]===b)d[g.name]=null}}}else if(b.eventType==tent.changes.EventTypes.CHANGED)if(b.data.propertyName&&b.subject&&b.subject.__reverseProperties__)if(g=b.subject.__reverseProperties__[b.data.propertyName])if(g.isArray){if(d=b.data.oldValue){d=d[g.name];if(d instanceof Array){i=0;for(l=d.length;i<l;i++)if(d[i]===b.subject){d.splice(i,1);i--;l--}}}if(d=b.data.current){d[g.name]||(d[g.name]=[]);d[g.name]instanceof Array&&d[g.name].indexOf(b.subject)<
0&&d[g.name].push(b.subject)}}else{if(d=b.data.oldValue)if(d[g.name]==b.subject)d[g.name]=null;if(d=b.data.current)if(d[g.name]!=b.subject)d[g.name]=b.subject}});return a};return c});tent.declare("tent.entities",function(c){c.ChangeStates=new tent.coreTypes.Enum("DETACHED,UNCHANGED,ADDED,MODIFIED,DELETED");c.Type=function(a,b){this.name=a;this.properties=b;if(b instanceof tent.changes.reverseProperties.Set)this.reversePropertySet=b;else if(typeof b=="object")this.reversePropertySet=new tent.changes.reverseProperties.Set(b);else throw"cannot create a Type without properties";};c.Type.prototype.toString=function(){return"EntityType("+this.name+")"};c.Type.prototype.applyTo=function(){this.reversePropertySet.applyTo.apply(this.reversePropertySet,
arguments);for(var a=0;a<arguments.length;a++){if(arguments[a].__entityType__!=this)arguments[a].__entityType__=this;for(var b in this.properties){var e=this.properties[b];if(typeof arguments[a][b]=="undefined")arguments[a][b]=!e.cardinality||e.cardinality.substr(1,1)==="1"?null:[]}}};c.Collection=function(a,b,e){this.context=a;this.type=b;this.name=e||b.name;this.items=[];tent.arrays.addFunctions(this.items)};c.Collection.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof
Array)this.push.apply(this,arguments[a]);else if(arguments[a].__collection__){if(arguments[a].__collection__!=this)throw"cannot add this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;this.items.push(arguments[a]);
this.context.changeHandler&&this.context.changeHandler.itemAdded(arguments[a]);this.type&&this.context.__cascadePush__(arguments[a])}}return this.items.length};c.Collection.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays to a Collection";else if(arguments[a].__collection__){if(arguments[a].__collection__!=this)throw"cannot attach this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=
this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;arguments[a].__changeState__!=c.ChangeStates.DELETED&&this.items.push(arguments[a]);this.context.changeHandler&&this.context.changeHandler.itemAttached(arguments[a]);this.type&&this.context.__cascadeAttach__(arguments[a])}}return this.items.length};c.Collection.prototype.remove=
function(){for(var a=false,b=0,e=arguments.length;b<e;b++){var g=arguments[b];if(this.items.remove(g)){a=true;this.context.changeHandler&&this.context.changeHandler.itemRemoved(arguments[b]);this.type&&this.context.__cascadeRemove__(g)}}return a};c.Collection.prototype.detach=function(){for(var a=false,b=0,e=arguments.length;b<e;b++){var g=arguments[b];if(this.items.remove(g)||g.__changeState__==c.ChangeStates.DELETED){a=true;this.context.changeHandler&&this.context.changeHandler.itemDetached(g);
delete g.__collection__;g.__entityType__&&this.context.__cascadeDetach__(g)}}return a};c.Collection.prototype.detachAll=function(){if(this.items.length<1)return false;for(var a=this.items.pop();typeof a!="undefined";){this.context.changeHandler&&this.context.changeHandler.itemDetached(a);delete a.__collection__;a.__entityType__&&this.context.__cascadeDetach__(a);a=this.items.pop()}this.items.length=0;return true};c.Context=function(a){this.__collections__={};this.__types__={};a===true&&this.trackChanges()};
c.MyContext=new c.Context;c.Context.prototype.all=function(){var a=[],b;for(b in this.__collections__)a.push.apply(a,this.__collections__[b].items);return a};c.Context.prototype.filter=function(a){var b=[],e;for(e in this.__collections__)b.push.apply(b,this.__collections__[e].items.filter(a));return b};c.Context.prototype.contains=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b)if(b.__collection__){if(this.__collections__[b.__collection__.name]!=b.__collection__)return false}else if(b instanceof
c.Type){if(this.__types__[b.name]!=b)return false}else if(b instanceof c.Collection){if(this!=b.context)return false}else return false;else return false}return true};c.Context.prototype.createCollection=function(a,b){if(b){if(a&&!a instanceof c.Type)throw"provided type is not a Type instance";}else if(a)if(a instanceof c.Type)b=a.name;else if(typeof a=="string"){b=a;a=null}else throw"provide a Type or name to create a Collection";else b="_Object";if(!this.__collections__[b]){this.__collections__[b]=
new c.Collection(this,a,b);for(var e=b;this[e];)e+="_";this[e]=this.__collections__[b]}return this.__collections__[b]};c.Context.prototype.pushModel=function(a){if(a)if(a.types)for(var b in a.types)this.push(new c.Type(b,a.types[b]))};c.Context.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot push arrays into a Context";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot push this item, it belongs to another Context";
}else if(arguments[a]instanceof c.Type){if(!arguments[a].name)throw"cannot add an EntityType without name";if(this.__types__[arguments[a].name])if(this.__types__[arguments[a].name]==arguments[a])continue;else throw'EntityType "'+arguments[a].name+'" already exists';this.__types__[arguments[a].name]=arguments[a];this.createCollection(arguments[a])}else if(arguments[a]instanceof c.Context)throw"cannot add an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;
if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.createCollection(b).push(arguments[a])}};c.Context.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays";else if(!(arguments[a].__collection__&&arguments[a].__collection__.context==this))if(arguments[a]instanceof c.Type)throw"cannot attach EntityTypes";else if(arguments[a]instanceof
c.Context)throw"cannot attach an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.createCollection(b).attach(arguments[a])}};c.Context.prototype.remove=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof c.Type)throw"cannot remove EntityTypes";else if(arguments[a]instanceof
c.Context)throw"cannot remove an EntityContext from an EntityContext";else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.remove(arguments[a])};c.Context.prototype.detach=function(){for(var a=0;a<arguments.length;a++){if(arguments[a]instanceof Array)throw"cannot detach arrays";if(arguments[a]instanceof c.Type)throw"cannot detach EntityTypes";else if(arguments[a]instanceof c.Context)throw"cannot detach an EntityContext from an EntityContext";else typeof arguments[a]==
"object"&&arguments[a].__collection__&&arguments[a].__collection__.detach(arguments[a])}};c.Context.prototype.detachAll=function(){for(var a=false,b=0;b<this.__collections__.length;b++)if(this.__collections__[b].detachAll())a=true;return a};c.Context.prototype.touch=function(){if(this.changeHandler)return this.changeHandler.touch.apply(this.changeHandler,arguments)};c.Context.prototype.__cascadePush__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var e in b.__entityType__.properties)if(b[e]!==
null&&typeof b[e]=="object"){var g=b.__entityType__.properties[e];if(g.cascadePush){var i=null;if(g.collection)i=this.__collections__[g.collection]||this.createCollection(g.collection);if(b[e]instanceof Array){if(g.cardinality&&g.cardinality[1]!="1")i?i.push.apply(i,b[e]):this.push.apply(this,b[e])}else i?i.push(b[e]):this.push(b[e])}}}};c.Context.prototype.__cascadeAttach__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var e in b.__entityType__.properties)if(b[e]!==
null&&typeof b[e]=="object"){var g=b.__entityType__.properties[e];if(g.cascadeAttach){var i=null;if(g.collection)i=this.__collections__[g.collection]||this.createCollection(g.collection);if(b[e]instanceof Array){if(g.cardinality&&g.cardinality[1]!="1")i?i.attach.apply(i,b[e]):this.attach.apply(this,b[e])}else i?i.attach(b[e]):this.attach(b[e])}}}};c.Context.prototype.__cascadeRemove__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var e in b.__entityType__.properties)if(b[e]!==
null&&typeof b[e]=="object"){var g=b.__entityType__.properties[e];if(g.cascadeRemove)if(b[e]instanceof Array)g.cardinality&&g.cardinality[1]!="1"&&this.remove.apply(this,b[e]);else this.remove(b[e])}}};c.Context.prototype.__cascadeDetach__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var e in b.__entityType__.properties)if(b[e]!==null&&typeof b[e]=="object"){var g=b.__entityType__.properties[e];if(g.cascadeDetach)if(b[e]instanceof Array)g.cardinality&&
g.cardinality[1]!="1"&&this.detach.apply(this,b[e]);else this.detach(b[e])}}};c.Context.prototype.trackChanges=function(){if(!this.changeHandler){this.changeHandler=new c.ContextChangeHandler(this);this.changeHandler.init()}};c.Context.prototype.hasChanges=function(){return!!(this.changes&&this.changes.items.length>0)};c.Context.prototype.acceptChanges=function(){this.changeHandler&&this.changeHandler.acceptChanges()};c.EntityLink=function(a,b,e,g){this.from=a;this.to=b;this.propertyName=e;this.__changeState__=
g||c.ChangeStates.DETACHED};c.ContextChanges=function(a){this.context=a;this.items=[];tent.arrays.addFunctions(this.items)};c.ContextChanges.prototype.toString=function(){for(var a=new tent.coreTypes.NameCounter,b=0,e=this.items.length;b<e;b++)a.add(c.ChangeStates.getName(this.items[b].__changeState__)+"."+this.items[b].__collection__.name);return a.toString()};c.ContextChangeHandler=function(a){this.context=a};c.ContextChangeHandler.prototype.isDetached=function(a){return!a.__changeState__||a.__changeState__==
c.ChangeStates.DETACHED};c.ContextChangeHandler.prototype.bindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var e=a.__entityType__.properties[b];if(e.cardinality&&e.cardinality[1]!="1"&&a[b]instanceof Array){a[b].__parent__=a;a[b].__propertyName__=b;tent.changes.bind(a[b],this)}}};c.ContextChangeHandler.prototype.unbindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var e=a.__entityType__.properties[b];e.cardinality&&
e.cardinality[1]!="1"&&a[b]instanceof Array&&tent.changes.unbind(a[b],this)}};c.ContextChangeHandler.prototype.setAdded=function(a){if(a.__changeState__!=c.ChangeStates.ADDED)if(a.__collection__)if(a.__collection__.context==this.context){a.__changeState__=c.ChangeStates.ADDED;if(!this.context.changes)this.context.changes=new c.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else throw"cannot set this item as ADDED, it belongs to another Context";else a.__changeState__=c.ChangeStates.ADDED};
c.ContextChangeHandler.prototype.setRemoved=function(a){if(!(this.isDetached(a)||a.__changeState__==c.ChangeStates.DELETED))if(a.__collection__)if(a.__collection__.context==this.context)if(a.__changeState__==c.ChangeStates.UNCHANGED||a.__changeState__==c.ChangeStates.MODIFIED){a.__changeState__=c.ChangeStates.DELETED;if(!this.context.changes)this.context.changes=new c.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else{if(a.__changeState__==c.ChangeStates.ADDED){a.__changeState__=
c.ChangeStates.DETACHED;delete a.__collection__;if(!this.context.changes)this.context.changes=new c.ContextChanges(this.context);this.context.changes.items.remove(a)}}else throw"cannot set this item as DELETED, it belongs to another Context";else a.__changeState__=c.ChangeStates.DELETED};c.ContextChangeHandler.prototype.touch=function(){for(var a=0,b=arguments.length;a<b;a++)if(arguments[a]&&arguments[a].__changeState__==c.ChangeStates.UNCHANGED&&arguments[a].__collection__&&arguments[a].__collection__.context==
this.context){if(!this.context.changes)this.context.changes=new c.ContextChanges(this);arguments[a].__changeState__=c.ChangeStates.MODIFIED;this.context.changes.items.pushUnique(arguments[a])}};c.ContextChangeHandler.prototype.itemAdded=function(a){if(this.isDetached(a))this.setAdded(a);else if(a.__changeState__!=c.ChangeStates.UNCHANGED){if(!this.context.changes)this.context.changes=new c.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}if(a.__changeState__!=c.ChangeStates.DELETED){tent.changes.bind(a,
this);this.bindArrayProperties(a)}};c.ContextChangeHandler.prototype.itemAttached=function(a){if(this.isDetached(a))a.__changeState__=c.ChangeStates.UNCHANGED;this.itemAdded(a)};c.ContextChangeHandler.prototype.itemRemoved=function(a){this.setRemoved(a);tent.changes.unbind(a,this);this.unbindArrayProperties(a)};c.ContextChangeHandler.prototype.itemDetached=function(a){var b=this.context.changes;a.__changeState__!=c.ChangeStates.UNCHANGED&&b&&b.items.remove(a);delete a.__changeState__;tent.changes.unbind(a,
this);this.unbindArrayProperties(a)};c.ContextChangeHandler.prototype.objectLinked=function(a,b,e,g){if(typeof g=="object")if(g instanceof Array){if(g.__parent__!=a){if(g.__parent__)throw"this array already has another parent object";g.__parent__=a}if(g.__propertyName__!=b)g.__propertyName__=b;tent.changes.bind(g,this);e.onLinkPush&&this.context.attach.push(this.context,g)}else if(g!==null&&typeof g!="undefined"){if(g.__changeState__==c.ChangeStates.DELETED)throw'cannot link a DELETED object to property "'+
e+'"';if(g.__collection__){if(g.__collection__.context!=this.context)throw"cannot link this object, it belongs to another Context";if(e.collection&&g.__collection__.name!=e.collection)throw"cannot link an object of collection "+e.collection+' to property "'+e+'"';}if(!g.__collection__&&e.onLinkPush){g.__entityType__&&this.context.push(g.__entityType__);if(e.collection){if(!this.context.__collections__[e.collection])throw Error('Collection "'+e.collection+'" not found in this Context');this.context.__collections__[e.collection].push(g)}else this.context.push(g)}if(e.trackLinks){e=
null;for(var i=this.context.changes.items.length-1;i>=0;i--){var l=this.context.changes.items[i];if(l instanceof c.EntityLink&&l.from===a&&l.to===g&&l.propertyName==b){e=l;break}}if(e){if(e.__changeState__==c.ChangeStates.DELETED)e.__changeState__=c.ChangeStates.UNCHANGED}else{e=new c.EntityLink(a,g,b,c.ChangeStates.ADDED);this.context.changes.items.push(e)}}}};c.ContextChangeHandler.prototype.objectUnlinked=function(a,b,e,g){if(typeof g=="object")if(g instanceof Array){delete g.__parent__;delete g.__propertyName__;
tent.changes.unbind(g,this);e.onUnlinkRemove&&this.context.remove.apply(this.context,g)}else if(g!==null&&typeof g!="undefined"){e.onUnlinkRemove&&g.__collection__&&g.__collection__.remove(g);if(e.trackLinks){e=null;for(var i=-1,l=this.context.changes.items.length-1;l>=0;l--){var d=this.context.changes.items[l];if(d instanceof c.EntityLink&&d.from===a&&d.to===g&&d.propertyName==b){e=d;i=l;break}}if(e)if(e.__changeState__==c.ChangeStates.ADDED)this.context.changes.items.splice(i,1);else{if(e.__changeState__!=
c.ChangeStates.DELETED)e.__changeState__=c.ChangeStates.DELETED}else{e=new c.EntityLink(a,g,b,c.ChangeStates.DELETED);this.context.changes.items.push(e)}}}};c.ContextChangeHandler.prototype.getTrackedProperty=function(a,b){var e;if(a.__entityType__&&a.__changeState__&&a.__changeState__!=c.ChangeStates.DELETED&&a.__changeState__!=c.ChangeStates.DETACHED&&a.__collection__&&a.__collection__.context==this.context&&(e=a.__entityType__.properties[b]))return e};c.ContextChangeHandler.prototype.handle=function(a){if(a.subject){var b;
if(a.eventType==tent.changes.EventTypes.CHANGED)if(a.subject.__entityType__){if(b=this.getTrackedProperty(a.subject,a.data.propertyName)){this.context.touch(a.subject);this.objectUnlinked(a.subject,a.data.propertyName,b,a.data.oldValue);this.objectLinked(a.subject,a.data.propertyName,b,a.data.current)}}else this.context.touch(a.subject);else if(a.eventType==tent.changes.EventTypes.ADDED){var e=a.subject.__parent__;if(e&&(b=this.getTrackedProperty(e,a.data.propertyName)))for(var g=0,i=a.data.items.length;g<
i;g++)this.objectLinked(e,a.data.propertyName,b,a.data.items[g])}else if(a.eventType==tent.changes.EventTypes.REMOVED)if((e=a.subject.__parent__)&&(b=this.getTrackedProperty(e,a.data.propertyName))){g=0;for(i=a.data.items.length;g<i;g++)this.objectUnlinked(e,a.data.propertyName,b,a.data.items[g])}tent.changes.reverseProperties.getHandler()(a)}};c.ContextChangeHandler.prototype.init=function(){if(this.context.log)var a=new tent.coreTypes.NameCounter;for(var b in this.context.__collections__){for(var e=
this.context.__collections__[b],g=0,i=e.items.length;g<i;g++)this.itemAttached(e.items[g]);a&&a.add(b,e.items.length)}if(this.context.log)a&&a.root._count>0?tent.log.debug("Context: initialized with "+a):tent.log.debug("Context: initialized empty")};c.ContextChangeHandler.prototype.acceptChanges=function(){if(this.context.hasChanges()){this.context.log&&tent.log.debug("Context: accepting changes, "+this.context.changes);for(var a=this.context.changes.items,b=0,e=a.length;b<e;b++)a[b].__changeState__=
c.ChangeStates.UNCHANGED;a.length=0;this.context.log&&tent.log.debug("Context: all changes accepted")}};return c});
