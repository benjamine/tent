var tent=tent||{};tent.global=typeof window=="undefined"?this:window;
tent.Namespace=function(a,b){if(!b)if(a){b=a;a=tent.global}else throw"must specify namespace path";if(b===".."){if(a===tent.global)throw"cannot use '..' at top level";return a.parent}var c=b.indexOf(".");c<0||b.indexOf(".",c+1);var d=a===tent.global?"":a.fullname+"";if(d)d+=".";d+=b;if(c<0)if(typeof a[b]=="undefined"){this.fullname=d;this.name=b;this.parent=a;a[b]=this}else if(!a[b]instanceof tent.Namespace)throw'error creating namespace: "'+d+'" is not a Namespace object';else return a[b];else return new tent.Namespace(new tent.Namespace(a,
b.slice(0,c)),b.slice(c+1));return this};tent.__tentTmp=new tent.Namespace("__tentTmp");tent.__tentTmp.Namespace=tent.Namespace;tent.__tentTmp.fullname="tent";tent.__tentTmp.name="tent";tent.__tentTmp.parent=tent.global;tent.__tentTmp.global=tent.global;tent.global.tent=tent.__tentTmp;delete tent.__tentTmp;try{delete tent.global.__tentTmp}catch(ex){}
tent.Namespace.prototype.expand=function(a){if(a instanceof Function)a(this);else if(typeof a=="object")for(var b in a)if(a.hasOwnProperty(b)){if(typeof this[b]!="undefined")throw this.fullname+"."+b+" already exists";this[b]=a[b]}return this};
tent.declare=function(){for(var a,b=0;b<arguments.length;b++){var c=arguments[b];if(c instanceof tent.Namespace)a=c;else if(typeof c=="string")a=a?new tent.Namespace(a,c):new tent.Namespace(c);else if(c instanceof Function||typeof c=="object"){if(!a)throw"no namespace provided";a.expand(c)}else throw"invalid argument type at index "+b+", expected Namespace, string, Function";}return a};
tent.mixin=function(a,b){for(var c in b.prototype)if(b.prototype.hasOwnProperty(c))a.prototype[c]=b.prototype[c];return a};tent.combineOptions=function(){for(var a={},b=0,c=arguments.length;b<c;b++){var d=arguments[b],g;for(g in d)if(d.hasOwnProperty(g))a[g]=tent.clone(d[g],{deep:true,ignoreCircularReferences:true})}return a};
tent.isDOMObject=function(a){if(typeof Node!="undefined"&&a instanceof Node||typeof Element!="undefined"&&a instanceof Element||typeof NodeList!="undefined"&&a instanceof NodeList||a===window||a===document)return true;if(typeof o==="object"&&typeof o.nodeType==="number"&&typeof o.nodeName==="string")return true;return false};
tent.DOMPropertyNames=["nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate","dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter",
"id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin","isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove",
"title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue","onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout",
"aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart","aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all",
"onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name","nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate",
"dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter","id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin",
"isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove","title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue",
"onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout","aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart",
"aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all","onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name"];tent.isDOMProperty=function(a){if(!tent.DOMPropertyNames.indexOf)tent.DOMPropertyNames.indexOf=tent.arrays.functions.indexOf;return tent.DOMPropertyNames.indexOf(a)>=0};
tent.clone=function(a,b){if(a===null)return null;else if(typeof a=="undefined")return;else if(typeof a=="object"){if(b&&b.onlyForTracking&&tent.changes.getPropertyInterceptMode()!=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM)return a;if(b){if(b.deep&&!b.deepStack)b.deepStack=tent.arrays.extend([])}else b={};if(a instanceof Array)for(var c=[],d=0;d<a.length;d++)if(typeof a[d]=="object"&&b.deep){b.deepStack.push(a);if(b.deepStack.lastIndexOf(a[d])<0)if(b.attachedObjectsIds&&a[d].__collection__)c.push(tent.entities.getId(a[d]));
else{if(b.attachedObjects!==false||!a[d].__collection__)c.push(tent.clone(a[d],b))}else if(!b.ignoreCircularReferences)throw"Circular reference when cloning array";b.deepStack.pop()}else c.push(a[d]);else{c=b.dom?document.createElement("span"):{};for(d in a)if(!(b.onlyOwnProperties&&!a.hasOwnProperty(d))){var g=d.substr(0,1)=="_";if(!(b.skipPrivates&&g))if(!b.clonePrivates&&g){g=a.__observable__?tent.pget(a,d):a[d];if(typeof g=="object"&&b.attachedObjectsIds&&g.__collection__)c[d]=tent.entities.getId(g);
else typeof g=="object"&&b.attachedObjects===false&&g.__collection__||(c[d]=g)}else{g=a.__observable__?tent.pget(a,d):a[d];if(b.deep&&typeof g=="object")if(b.attachedObjectsIds&&g.__collection__)c[d]=tent.entities.getId(g);else{if(!(b.attachedObjects===false&&g.__collection__)){b.deepStack.push(a);if(b.deepStack.indexOf(g)<0)c[d]=tent.clone(g,b);else if(!b.ignoreCircularReferences)throw"Circular reference when cloning object";b.deepStack.pop()}}else c[d]=g}}}return c}return a};tent.declare("tent.arrays",function(){tent.arrays.extend=function(a,b){for(var c in tent.arrays.functions)if(b||!(a[c]instanceof Function))a[c]=tent.arrays.functions[c];return a};tent.arrays.functions={findByProperty:function(a,b){for(var c=0,d=this.length;c<d;c++)if(this[c][a]===b)return this[c];return null},first:function(a){for(var b=0,c=this.length;b<c;b++)if(a(this[b]))return this[b];return null},indexByProperty:function(a,b){for(var c=0,d=this.length;c<d;c++)if(this[c][a]===b)return c;return-1},
indexOf:function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1},lastIndexOf:function(a){for(var b=this.length-1;b>0;b--)if(this[b]===a)return b;return-1},filter:function(a){for(var b=[],c=0,d=this.length;c<d;c++)a(this[c])&&b.push(this[c]);return b},remove:function(){for(var a,b=0,c=this.length;b<c;b++)for(var d=0,g=arguments.length;d<g;d++)if(this[b]==arguments[d]){this.splice(b,1);a=true;b--;c--;break}if(a)return true;return false},set:function(a,b){this.splice(a,1,b)},pushUnique:function(){if(arguments.length==
1){for(var a=false,b=0,c=this.length;b<c;b++)if(this[b]==arguments[0]){a=true;break}a||this.push(arguments[0])}else{a=[];b=0;for(c=this.length;b<c;b++)for(var d=0,g=arguments.length;d<g;d++)if(this[b]==arguments[d])a[d]=true;d=0;for(g=arguments.length;d<g;d++)a[d]||this.push(arguments[d])}return this.length},clone:function(){var a=[];Array.prototype.push.apply(a,this);return a},isCloneOf:function(a){if(!a)return false;if(this.length!=a.length)return false;if(this===a)return false;for(var b=this.length;b>=
0;b--)if(this[b]!==a[b])return false;return true}}});tent.declare("tent.coreTypes",function(){tent.coreTypes.Enum=function(){this.__names__=[];this.__values__={};this.__flags__=false;this.__enum=true;arguments.length>0&&this.add.apply(this,arguments)};tent.coreTypes.Enum.prototype.getName=function(c){if(this.__names__)if(this.__names__[c])return this.__names__[c];else if(this.__flags__){c=c;var d="",g;for(g in this.__values__)if(this.__values__[g]&&(this.__values__[g]&c)===this.__values__[g]){c-=this.__values__[g];if(d)d+="|";d+=g}if(d&&c===0)return d;
else if(d)return d+"|"+c}};tent.coreTypes.Enum.prototype.__freeValue__=function(){var c=typeof this.__maxValue__=="undefined"?1:this.__maxValue__+1;if(this.__values__&&typeof this.__values__[c]!="undefined")for(var d in this.__values__)if(this.__values__[d]>=c){this.__maxValue__=this.__values__[d];c=this.__values__[d]+1}if(this.__flags__)c=c<1?1:Math.pow(2,Math.ceil(Math.log(c)/Math.log(2)));return c};tent.coreTypes.Enum.prototype.useFlags=function(c){this.__flags__=c;return this};var a=function(c,
d,g){c[d]=g;c.__values__[d]=g;if(typeof c.__names__[g]=="undefined")c.__names__[g]=d;if(typeof c.__maxValue__=="undefined"||c.__maxValue__<g)c.__maxValue__=g};tent.coreTypes.Enum.prototype.add=function(){if(arguments.length<1)return this;for(var c,d,g=0,j=arguments.length;g<j;g++){c=arguments[g];if(c instanceof Array)this.add.apply(this,c);else if(typeof c=="object")for(d in c)if(c.hasOwnProperty(d)){var e=this.__values__[d];if(!e instanceof Number||typeof this.__names__[e]!="undefined")e=this.__freeValue__();
a(this,d,e)}if(typeof c=="string")if(c){c=c.split(",");e=0;for(var f=c.length;e<f;e++){d=c[e].replace(/^\s+/g,"").replace(/\s+$/g,"");if(d=="_FLAGS")this.useFlags(true);else{if(typeof this.__values__[d]!="undefined")if(this.__values__[d]instanceof Number)throw"Enum duplicate name found: "+d;else throw"Enum invalid name (reserved): "+d;if(e==f-1&&g<j-1&&typeof arguments[g+1]=="number"){a(this,d,arguments[g+1]);g++}else a(this,d,this.__freeValue__())}}}}return this};var b=function(){var c=this._name+
(this._count>1?"("+this._count+")":"");if(this._childrenCount){c+="{";var d=0,g;for(g in this)if(g.substr(0,1)!="_"&&typeof this[g]=="object"){if(d>0)c+=", ";c+=this[g];d++}c+="}"}return c};tent.coreTypes.NameCounter=function(c){this.root={_name:c||"",_count:0,toString:b}};tent.coreTypes.NameCounter.prototype.__nodeAdd__=function(c,d){c._count=(c._count||0)+d;if(c._parent){if(c._count==0&&!c._childrenCount){c._parent._childrenCount&&c._parent._childrenCount--;delete c._parent[c._name]}this.__nodeAdd__(c._parent,
d)}};tent.coreTypes.NameCounter.prototype.add=function(c,d){if(typeof d!="number")d=1;for(var g=c.split("."),j=this.root,e=0;e<g.length;e++){if(typeof j[g[e]]=="undefined"){j._childrenCount=(j._childrenCount||0)+1;j[g[e]]={_parent:j,_name:g[e],_count:0,toString:b}}j=j[g[e]]}this.__nodeAdd__(j,d)};tent.coreTypes.NameCounter.prototype.reset=function(){this.root={_name:this.root._name,_count:0,toString:b}};tent.coreTypes.NameCounter.prototype.toString=function(){return b.apply(this.root)}});tent.declare("tent.logging",function(){tent.logging.Levels=new tent.coreTypes.Enum("TRACE,DEBUG,INFO,WARN,ERROR,FATAL");tent.logging.Log=function(){this.listeners=[]};tent.logging.Log.prototype.bindToConsole=function(a){typeof console!="undefined"&&this.bind(tent.logging.consoleLogger,a);return this};tent.logging.Log.prototype.bindToAlert=function(a){this.bind(tent.logging.alertLogger,a);return this};tent.logging.Log.prototype.bindToHtml=function(a,b){this.bind(tent.logging.createHtmlAppendLogger(a),
b);return this};tent.logging.Log.prototype.unbindConsole=function(){typeof console!="undefined"&&this.unbind(tent.logging.consoleLogger);return this};tent.logging.Log.prototype.unbindAlert=function(){this.unbind(tent.logging.alertLogger,level);return this};tent.logging.Log.prototype.unbindHtml=function(a){for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback.outputElement===a&&this.listeners.splice(b,1);return this};tent.logging.Log.prototype.bind=function(a,b){if(!a instanceof Function)throw"a callback Function must be provided";
var c=b;if(typeof c!="number")c=typeof c=="undefined"?tent.logging.Levels.TRACE:tent.logging.Levels[c]||tent.logging.Levels.TRACE;for(var d=false,g=this.listeners.length-1;g>=0;g--){var j=this.listeners[g];if(j.callback===a){j.level=c;d=true}}d||this.listeners.push({callback:a,level:c});return this};tent.logging.Log.prototype.unbind=function(a){if(!a instanceof Function)throw"a callback Function must be provided";for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback===a&&this.listeners.splice(b,
1);return this};tent.logging.Log.prototype.notify=function(a,b){var c=b;if(typeof c!="number")c=c?tent.logging.Levels[c]||tent.logging.Levels.INFO:tent.logging.Levels.INFO;for(var d=0,g=this.listeners.length;d<g;d++){var j=this.listeners[d];if(j.callback)if(typeof j.level=="undefined"||j.level<=c)j.callback(a,b)}};tent.logging.Log.prototype.trace=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.TRACE)};tent.logging.Log.prototype.debug=function(){this.notify(this.stringOrStringify.apply(this,
arguments),tent.logging.Levels.DEBUG)};tent.logging.Log.prototype.info=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.INFO)};tent.logging.Log.prototype.warn=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.WARN)};tent.logging.Log.prototype.error=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.ERROR)};tent.logging.Log.prototype.fatal=function(){this.notify(this.stringOrStringify.apply(this,
arguments),tent.logging.Levels.FATAL)};tent.logging.Log.prototype.stringify=function(){var a="";try{var b=arguments.length>0&&arguments[arguments.length-1]&&arguments[arguments.length-1]._options?arguments[arguments.length-1]:{_options:true};if(!b.deepStack){b.deepStack=[];tent.arrays.extend(b.deepStack)}for(var c=0,d=arguments.length;c<d;c++)if(!(arguments[c]&&typeof arguments[c]=="object"&&arguments[c]._options))if(!(arguments[c]instanceof Function)){if(a)a+=", ";if(b.deepStack.length>3||b.deepStack.lastIndexOf(arguments[c])>=
0)a+="#";else if(typeof arguments[c]=="undefined")a+="undefined";else if(arguments[c]==null)a+="null";else if(arguments[c]instanceof Array){var g=tent.arrays.functions.clone.apply(arguments[c]).filter(function(h){if(h instanceof Function)return false;if(b.deepStack.lastIndexOf(h>=0))return false;return true});g.push(b);b.deepStack.push(arguments[c]);a+="[";if(b.deepStack.length<4)a+=this.stringify.apply(this,g);b.deepStack.pop();a+="]"}else if(typeof arguments[c]=="string")a+='"'+arguments[c]+'"';
else if(arguments[c]instanceof Date)a+='"'+arguments[c]+'"';else if(typeof arguments[c]=="object"){var j="";b.deepStack.push(arguments[c]);if(b.deepStack.length<4)for(var e in arguments[c])if(!(arguments[c][e]instanceof Function))if(!(b.deepStack.lastIndexOf(arguments[c][e])>=0)){if(j)j+=", ";j+='"'+e+'": '+this.stringify.apply(this,[arguments[c][e],b])}b.deepStack.pop();a+="{"+j+"}"}else a+=arguments[c]}}catch(f){return"#err#"}return a};tent.logging.Log.prototype.stringOrStringify=function(){return arguments.length==
1&&typeof arguments[0]=="string"?arguments[0]:this.stringify.apply(this,arguments)};tent.logging.consoleLogger=function(a,b){if(b==tent.logging.Levels.TRACE)console.trace?console.trace(a):console.info(a);if(b==tent.logging.Levels.DEBUG)console.debug?console.debug(a):console.info(a);b==tent.logging.Levels.INFO&&console.info(a);if(b==tent.logging.Levels.WARN)console.warn?console.warn(a):console.info(a);b==tent.logging.Levels.ERROR&&console.error(a);b==tent.logging.Levels.FATAL&&console.error(a)};tent.logging.alertLogger=
function(a){alert(a)};tent.logging.createHtmlAppendLogger=function(a){var b=null;b=a.tagName=="INPUT"?function(c,d){a.value+="\n["+tent.logging.Levels.getName(d)+"] "+c}:a.tagName=="UL"?function(c,d){var g=document.createElement("li");g.innerHTML="["+tent.logging.Levels.getName(d)+"] "+c;a.appendChild(g)}:a.tagName=="TABLE"?function(c,d){var g=document.createElement("tr"),j=document.createElement("td");j.setAttribute("class","eventType");j.innerHTML=tent.logging.Levels.getName(d);g.appendChild(j);
j=document.createElement("td");j.setAttribute("class","eventMessage");j.innerHTML=c.replace(/(\<)/g,"&lt;").replace(/(\>)/g,"&gt;").replace(/(\&)/g,"&amp;").replace(/(\s)/g,"&nbsp;");g.appendChild(j);a.tBodies[0].appendChild(g)}:function(c,d){a.innerHTML+="<br/>["+tent.logging.Levels.getName(d)+"] "+c};b.outputElement=a;return b};tent.log=(new tent.logging.Log).bindToConsole()});tent.declare("tent.changes",function(){tent.changes.EventTypes=new tent.coreTypes.Enum("ANY,MANYCHANGES,CHANGING,CHANGED,ADDING,ADDED,REMOVING,REMOVED");tent.changes.InterceptorTypes=new tent.coreTypes.Enum("PROPERTY,FUNCTION");tent.changes.PropertyInterceptModes=new tent.coreTypes.Enum("NONE,DEFINESETTER,DEFINEPROPERTY,DEFINEPROPERTYONLYDOM");var a;tent.changes.getPropertyInterceptMode=function(){if(typeof a=="undefined"){var e={};if(Object.defineProperty)try{Object.defineProperty(e,"myproperty",
{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});e.myproperty="my value";if(e.myproperty==="my value"&&e._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINEPROPERTY}catch(f){if(document&&document.createElement){e=document.createElement("span");try{Object.defineProperty(e,"myproperty",{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});e.myproperty="my value";if(e.myproperty==="my value"&&e._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM}catch(h){}}}if(typeof a==
"undefined"){e={};if(e.__defineSetter__)try{e.__defineGetter__("myproperty",function(){return this._myproperty});e.__defineSetter__("myproperty",function(k){this._myproperty=k});e.myproperty="my value";if(e.myproperty==="my value"&&e._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINESETTER}catch(i){}}if(typeof a=="undefined")a=tent.changes.PropertyInterceptModes.NONE}return a};tent.changes.getPropertyInterceptModeName=function(){return tent.changes.PropertyInterceptModes.getName(tent.changes.getPropertyInterceptMode())};
tent.changes.Change=function(e,f,h){this.subject=e;this.eventType=f;this.data=h};tent.changes.ChangeStringifiers=[];tent.changes.Change.prototype.toString=function(){if(typeof tent.changes.ChangeStringifiers[this.eventType]!="undefined")tent.changes.ChangeStringifiers[this.eventType](this);else{var e=tent.changes.EventTypes.getName(this.eventType);if(this.eventType==tent.changes.EventTypes.MANYCHANGES){e+=": ";if(this.data.length<=3)for(var f=0,h=this.data.length;f<h;f++)e+=this.data[f].toString()+
",";else{var i={};f=0;for(h=this.data.length;f<h;f++)i[this.data[f].eventType]=(i[this.data[f].eventType]||0)+1;for(var k in i)e+=tent.changes.EventTypes.getName(k)+"("+i[k]+"),"}}else{if(this.data.propertyName){e+=" "+this.data.propertyName;if(this.eventType==tent.changes.EventTypes.CHANGING)e+=" from "+this.data.current+" to "+this.data.newValue;else if(this.eventType==tent.changes.EventTypes.CHANGED)e+=" from "+this.data.oldValue+" to "+this.data.current;e+=" (on "+this.subject+")"}if(this.data.items){f=
this.data.items;e+=" "+f.length+(f.length>1?" items":" item");if(typeof this.data.index!="undefined")e+=" at index "+this.data.index;e+=this.data.propertyName?" ("+this.subject.__parent__+"."+this.data.propertyName+")":" (["+f+"])"}}return"[Change: "+e+"]"}};tent.changes.Observable=function(e){this.subject=e;this.handlers={};this.interceptors={};this.suspended=false;this.changesWhileSuspended=null};tent.changes.Observable.prototype.interceptFunction=function(e,f){if(!this.interceptors[e]){var h="_"+
e,i={name:e,_name:h,type:tent.changes.InterceptorTypes.FUNCTION};this.subject[h]=this.subject[e];this.subject[e]=f;this.interceptors[e]=i}};tent.pset=function(e,f,h,i){if(typeof f=="object"){for(var k in f)f.hasOwnProperty(k)&&tent.pset(e,k,f[k],h);return e}else{if(e.__observable__&&e.__observable__.interceptors&&e.__observable__.interceptors[f])if(i)e[e.__observable__.interceptors[f]._name||f]=h;else e.__observable__.interceptors[f].newsetter.call(e,h);else e[f]=h;return h}};tent.pget=function(e,
f){return e.__observable__&&e.__observable__.interceptors&&e.__observable__.interceptors[f]?e.__observable__.interceptors[f].newgetter.call(e):e[f]};tent.changes.Observable.prototype.interceptProperty=function(e,f,h,i){if(this.interceptors[e])return this.interceptors[e];var k={name:e,type:tent.changes.InterceptorTypes.PROPERTY,newsetter:i,newgetter:h};if(f){f="_"+e;try{this.subject[f]=this.subject[e]}catch(l){this.subject[f]=null}k._name=f}f=tent.changes.getPropertyInterceptMode();if(f==tent.changes.PropertyInterceptModes.DEFINEPROPERTY||
f==tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject)){try{k.descriptor=Object.getOwnPropertyDescriptor(this.subject,e)}catch(m){}f={};if(h)f.get=h;if(i)f.set=i;try{Object.defineProperty(this.subject,e,f)}catch(n){tent.log.warn("Object.defineProperty for property '"+e+"' failed: "+n)}}else if(f==tent.changes.PropertyInterceptModes.DEFINESETTER){try{k.getter=this.subject.__lookupGetter__(e);k.setter=this.subject.__lookupSetter__(e)}catch(p){}if(h)try{this.subject.__defineGetter__(e,
h)}catch(q){tent.log.warn("Object.__defineGetter__ for property '"+e+"' failed: "+q)}if(i)try{this.subject.__defineSetter__(e,i)}catch(r){tent.log.warn("Object.__defineSetter__ for property '"+e+"' failed: "+r)}}if(k)this.interceptors[e]=k;return k};tent.changes.Observable.prototype.shouldNotifyParent=function(){return!!(this.parentObject&&this.parentObject!==this&&this.parentObjectPropertyName&&this.parentObject.__observable__&&this.parentObject.__observable__.interceptors&&this.parentObject.__observable__.interceptors[this.parentObjectPropertyName])};
tent.changes.Observable.prototype.notifyParentChanging=function(e){e.subject=this.subject;this.parentObject.__observable__.notifyChange(tent.changes.EventTypes.CHANGING,{propertyName:this.parentObjectPropertyName,innerChange:e})};tent.changes.Observable.prototype.notifyParentChanged=function(e){e.subject=this.subject;this.parentObject.__observable__.notifyChange(tent.changes.EventTypes.CHANGED,{propertyName:this.parentObjectPropertyName,innerChange:e})};var b=function(e,f){return function(h){var i=
this[f];if(i!=h){this.__observable__.notifyChange(tent.changes.EventTypes.CHANGING,{propertyName:e,current:i,newValue:h});var k=this.__observable__.shouldNotifyParent();k&&this.__observable__.notifyParentChanging({propertyName:e,current:i,newValue:h});this[f]=h;this.__observable__.notifyChange(tent.changes.EventTypes.CHANGED,{propertyName:e,current:h,oldValue:i});k&&this.__observable__.notifyParentChanged({propertyName:e,current:h,oldValue:i})}}},c=function(e,f){return function(){return this[f]}},
d=function(e,f){return f.substr(0,1)!="_"};tent.changes.Observable.prototype.interceptProperties=function(e){e||(e={});var f=e.propertyFilter||d,h=e.backPropertyPrefix||"_";e=!e.trackDomProperties&&this.isDOMObject();for(var i in this.subject)if(!(e&&tent.isDOMProperty(i)))try{if(typeof this.subject[i]!="function"&&f(this.subject,i)){var k=h+i;this.interceptProperty(i,k,c(i,k),b(i,k))}}catch(l){tent.log.warn("Error intercepting property '"+i+"': "+l)}return this};tent.changes.Observable.prototype.isDOMObject=
function(){if(typeof this._isDomObject=="undefined")this._isDOMObject=tent.isDOMObject(this.subject);return this._isDOMObject};tent.changes.Observable.prototype.interceptArrayModifiers=function(){if(!this.subject instanceof Array)return this;var e=this.subject;this.subject.setLength=function(f){if(this.length>f)this.splice(f,this.length-f);else this.lengh=f};this.interceptFunction("push",function(){var f=this.length,h=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,
{items:h,index:f,propertyName:this.__propertyName__});var i=this.__observable__.shouldNotifyParent();i&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.ADDING,data:{items:h,index:f,propertyName:this.__propertyName__}});this._push.apply(this,arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:h,index:f,propertyName:this.__propertyName__});i&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.ADDED,data:{items:h,index:f,propertyName:this.__propertyName__}})});
this.interceptFunction("unshift",function(){var f=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,{items:f,index:0,propertyName:this.__propertyName__});var h=this.__observable__.shouldNotifyParent();h&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.ADDING,data:{items:f,index:0,propertyName:this.__propertyName__}});this._unshift.apply(this,arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:f,
index:0,propertyName:this.__propertyName__});h&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.ADDED,data:{items:f,index:0,propertyName:this.__propertyName__}})});this.interceptFunction("pop",function(){var f=this.length-1;this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:[this[f]],index:f,propertyName:this.__propertyName__});var h=this.__observable__.shouldNotifyParent();h&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.REMOVING,
data:{items:[this[f]],index:f,propertyName:this.__propertyName__}});var i=this._pop();this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:[i],index:f,propertyName:this.__propertyName__});h&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.REMOVED,data:{items:[i],index:f,propertyName:this.__propertyName__}});return i});this.interceptFunction("shift",function(){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:[this[0]],index:0,propertyName:this.__propertyName__});
var f=this.__observable__.shouldNotifyParent();f&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.REMOVING,data:{items:[this[0]],index:0,propertyName:this.__propertyName__}});var h=this._shift();this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:[h],index:0,propertyName:this.__propertyName__});f&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.REMOVED,data:{items:[h],index:0,propertyName:this.__propertyName__}});return h});this.interceptFunction("splice",
function(f,h){var i,k=this.__observable__.shouldNotifyParent();if(h&&h>0){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:this.slice(f,f+h),index:f,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.REMOVING,data:{items:this.slice(f,f+h),index:f,propertyName:this.__propertyName__}})}if(arguments.length>2){i=Array.prototype.slice.call(arguments,2);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,{items:i,
index:f,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.ADDING,data:{items:i,index:f,propertyName:this.__propertyName__}})}if(i&&i.length>0){var l=i.slice(0);l.unshift(f,h);l=this._splice.apply(this,l)}else l=this._splice(f,h);if(l&&l.length>0){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:l,index:f,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.REMOVED,
data:{items:l,index:f,propertyName:this.__propertyName__}})}if(arguments.length>2){this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:i,index:f,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.ADDED,data:{items:i,index:f,propertyName:this.__propertyName__}})}return l});e.remove=tent.arrays.functions.remove;e.set=tent.arrays.functions.set;if(!e.indexOf)e.indexOf=tent.arrays.functions.indexOf;if(!e.lastIndexOf)e.lastIndexOf=
tent.arrays.functions.lastIndexOf;return this};tent.changes.Observable.prototype.removeInterceptor=function(e){var f=this.interceptors[e];if(f._name){if(f.type!=tent.changes.InterceptorTypes.FUNCTION){try{delete this.subject[f.name]}catch(h){tent.log.warn("Error deleting property interceptor '"+f.name+"': "+h)}var i=tent.changes.getPropertyInterceptMode();if(i==tent.changes.PropertyInterceptModes.DEFINEPROPERTY||i==tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject))f.descriptor&&
f.descriptor.name&&Object.defineProperty(this.subject,e,f.descriptor);else if(i==tent.changes.PropertyInterceptModes.DEFINESETTER){f.getter&&this.subject.__defineGetter__(e,f.getter);f.setter&&this.subject.__defineSetter__(e,f.setter)}}try{this.subject[f.name]=this.subject[f._name]}catch(k){(i=tent.isDOMObject(this.subject))||tent.log.warn("Error restoring property '"+f.name+"' value: "+k)}try{delete this.subject[f._name]}catch(l){tent.log.warn("Error deleting back storage property '"+f._name+"': "+
l)}}else if(f.type!=tent.changes.InterceptorTypes.FUNCTION){i=this.subject[f.name];delete this.subject[f.name];this.subject[f.name]=i}delete f[e]};tent.changes.Observable.prototype.removeInterceptors=function(){for(var e in this.interceptors)try{this.removeInterceptor(e)}catch(f){tent.log.warn("Error removing interceptor from property '"+e+"': "+f)}this.interceptors={}};tent.changes.Observable.prototype.suspend=function(){this.suspended=true};tent.changes.Observable.prototype.resume=function(){this.suspended=
false;if(this.changesWhileSuspended){if(this.changesWhileSuspended.length<5)for(var e=0,f=this.changesWhileSuspended.length;e<f;e++)this.notifyChange(this.changesWhileSuspended[e]);else this.changesWhileSuspended.length>1&&this.notifyChange(tent.changes.EventTypes.MANYCHANGES,this.changesWhileSuspended);delete this.changesWhileSuspended}};tent.changes.Observable.prototype.isValidHandler=function(e){if(!e)return false;if(typeof e=="function"||typeof e=="object"&&typeof e.handle=="function")return true;
return false};tent.changes.Observable.prototype.bind=function(e,f){if(!f)if(this.isValidHandler(e)){f=e;e=tent.changes.EventTypes.ANY}else throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!this.isValidHandler(f))throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!e)e=tent.changes.EventTypes.ANY;var h=this.handlers[e];h||(h=this.handlers[e]=[]);for(var i=0;i<h.length;i++)if(h[i]==f)return false;this.handlers[e].push(f);
return true};tent.changes.Observable.prototype.unbind=function(e,f){if(!f)if(this.isValidHandler(e)){f=e;e=tent.changes.EventTypes.ANY}else throw"must specify a handler to remove";if(!this.isValidHandler(f))throw"must specify a handler to remove";if(!e)e=tent.changes.EventTypes.ANY;var h=this.handlers[e],i=false;if(h)for(var k=0,l=h.length;k<l;k++)if(h[k]==f){h.splice(k,1);k--;l--;i=true}return i};tent.changes.Observable.prototype.unbindWhere=function(e){var f=false,h;for(h in this.handlers)for(var i=
this.handlers[h],k=0,l=i.length;k<l;k++)if(e(i[k])){i.splice(k,1);k--;l--;f=true}return f};tent.changes.Observable.prototype.notifyHandler=function(e,f){try{return typeof f=="function"?f.call(this.subject,e):f.handle(e)}catch(h){var i="";if(h.stack)i+=h.stack;else if(h.message)i+=h.message;tent.log.error("Change Handler Error: "+h+(i?"\n"+i:""));return h}};tent.changes.Observable.prototype.notifyChange=function(e,f){if(this.suspended){if(!this.changesWhileSuspended){this.changesWhileSuspended=[];
if(!this.changesWhileSuspended.filter)this.changesWhileSuspended.filter=tent.arrays.functions.filter;this.changesWhileSuspended.findByEventType=function(){for(var m=0,n=this.length;m<n;m++)for(var p=0,q=arguments.length;p<q;p++)if(this[m].eventType==arguments[p])return this[m]};this.changesWhileSuspended.findPropertyChanged=function(m,n){for(var p=0,q=this.length;p<q;p++)if(this[p].subject==m&&this[p].eventType==tent.changes.EventTypes.CHANGED&&this[p].data.propertyName==n)return this[p]};this.changesWhileSuspended.findArrayChanged=
function(){for(var m=0,n=this.length;m<n;m++)if(this[m].subject==subject&&(this[m].eventType==tent.changes.EventTypes.ADDED||this[m].eventType==tent.changes.EventTypes.REMOVED))return this[m]}}this.changesWhileSuspended.push(new tent.changes.Change(this.subject,e,f))}else{var h;h=e instanceof tent.changes.Change?e:new tent.changes.Change(this.subject,e,f);var i=this.handlers[e];if(i)for(var k=0,l=i.length;k<l;k++)this.notifyHandler(h,i[k]);if(i=this.handlers[tent.changes.EventTypes.ANY]){k=0;for(l=
i.length;k<l;k++)this.notifyHandler(h,i[k])}}};var g;tent.changes.Observable.prototype.log=function(e){if(typeof e=="undefined")e=true;if(e){g||(g=new tent.changes.LogHandler);return this.bind(g)}else if(g)return this.unbind(g);return false};tent.changes.LogHandler=function(e){if(typeof e=="undefined")e="";else if(e&&e[e.length-1]!=" ")e+=" ";this.prefix=e};tent.changes.LogHandler.prototype.handle=function(e){tent.log.info(this.prefix+e.toString())};var j=function(e){var f={};for(opName in e)if(opName!=
"deepStack"&&opName!="liveHandler")f[opName]=e[opName];e=function(h){if(h.eventType==tent.changes.EventTypes.CHANGED){if(typeof h.data.current=="object")if(f.deepOverDOM||!tent.isDOMObject(h.data.current)){f.deepStack=[h.data.subject];tent.changes.track(h.data.current,f);delete f.deepStack}}else if(h.eventType==tent.changes.EventTypes.ADDED)for(var i=0,k=h.data.items.length;i<k;i++)if(typeof h.data.items[i]=="object")if(f.deepOverDOM||!tent.isDOMObject(h.data.current)){f.deepStack=[h.data.subject];
tent.changes.track(h.data.items[i],f);delete f.deepStack}};e.isLivePropagator=true;return e};tent.changes.track=function(e,f){f||(f={});if(typeof e!="object"){if(!f.deepStack)throw"Cannot track changes of "+typeof e;return false}else if(e==null){if(!f.deepStack)throw"Cannot track changes of null";return false}if(f.attachedObjects===false&&e.__collection__)return false;var h=e instanceof Array,i=false;if(!f.remove&&!f.removeAll&&!e.__observable__){if(f.observable&&(!f.observable.subject||f.observable.subject==
e)){e.__observable__=f.observable;e.__observable__.subject=e}else e.__observable__=new tent.changes.Observable(e);i=true;if(!f.interceptOptions)f.interceptOptions={};h?e.__observable__.interceptArrayModifiers(f.interceptOptions):e.__observable__.interceptProperties(f.interceptOptions)}if(f.parentObject&&typeof f.parentObjectPropertyName){if(e.__observable__.parentObject!==f.parentObject){e.__observable__.parentObject=f.parentObject;i=true}if(e.__observable__.parentObjectPropertyName!==f.parentObjectPropertyName){e.__observable__.parentObjectPropertyName=
f.parentObjectPropertyName;i=true}}else if(f.parentObject===false){if(typeof e.__observable__.parentObject!="undefined"){delete e.__observable__.parentObject;i=true}if(e.__observable__.parentObjectPropertyName!="undefined"){delete e.__observable__.parentObjectPropertyName;i=true}}if(f.bindings)for(var k=0,l=f.bindings.length;k<l;k++){var m=f.bindings[k];if(h&&m.bindArrays!=false||!h&&m.bindObjects!=false)if(f.remove){if(e.__observable__&&e.__observable__.unbind(m.eventType,m.handler))i=true}else if(e.__observable__.bind(m.eventType,
m.handler))i=true}if(f.log)if(e.__observable__&&e.__observable__.log(!f.remove))i=true;if(f.reverseProperties)if(f.remove){if(e.__observable__&&e.__observable__.unbind(tent.changes.reverseProperties.getHandler()))i=true}else if(e.__observable__.bind(tent.changes.reverseProperties.getHandler()))i=true;if(f.removeAll&&e.__observable__){e.__observable__.removeInterceptors();delete e.__observable__.subject;delete e.__observable__;i=true}if(f.deep&&f.live&&!f.remove)if(f.remove){if(e.__observable__.unbindWhere(function(p){return p.isLivePropagator}))i=
true}else{if(!f.liveHandler)f.liveHandler=j(f);if(e.__observable__.bind(f.liveHandler))i=true}if(f.deep){if(f.deepStack)f.deepStack.push(e);else{f.deepStack=[e];if(!f.deepStack.lastIndexOf)f.deepStack.lastIndexOf=tent.arrays.functions.lastIndexOf}if(h){k=0;for(l=e.length;k<l;k++)if((h=e[k])&&typeof h=="object"&&f.deepStack.lastIndexOf(h)<0)if(tent.changes.track(h,f))i=true}else{k=f.propertyFilter||d;for(var n in e)if(typeof e[n]!="function"&&k(e,n)){h=e[n];if(f.deepOverDOM||!tent.isDOMObject(h))if(typeof h==
"object"&&f.deepStack.lastIndexOf(h)<0)if(tent.changes.track(h,f))i=true}}f.deepStack.pop()}return i};tent.changes.untrack=function(e,f){if(f){if(!f.removeAll)f.removeAll=true}else f={removeAll:true};return tent.changes.track(e,f)};tent.changes.isTracked=function(e){return e.__observable__&&e.__observable__ instanceof tent.changes.Observable};tent.changes.bind=function(e,f){var h;if(typeof f=="string"){h=f;f={bindings:[]}}else if(typeof f=="function")f={bindings:[{handler:f}]};else if(typeof f=="object"&&
typeof f.handle=="function")f={bindings:[{handler:f}]};if(arguments.length>2){if(f){if(!f.bindings)f.bindings=[]}else f={bindings:[]};for(var i=2;i<arguments.length;i++)f.bindings.push({eventType:h,handler:arguments[i]})}return tent.changes.track(e,f)};tent.changes.unbind=function(e,f){var h;if(typeof f=="string"){h=f;f={bindings:[]}}else if(typeof f=="function")f={bindings:[{handler:f}]};else if(typeof f=="object"&&typeof f.handle=="function")f={bindings:[{handler:f}]};if(arguments.length>2){if(f){if(!f.bindings)f.bindings=
[]}else f={bindings:[]};for(var i=2;i<arguments.length;i++)f.bindings.push({eventType:h,handler:arguments[i]})}if(f){if(!f.remove)f.remove=true}else f={remove:true};return tent.changes.track(e,f)}});tent.declare("tent.databinding",function(){var a=function(c,d,g,j,e){var f={};f.handle=function(h){var i=false;if(h.eventType==tent.changes.EventTypes.ADDED||h.eventType==tent.changes.EventTypes.REMOVED||h.eventType==tent.changes.EventTypes.CHANGED)if(e.deep)i=true;else{var k=c;if(h.subject==c)i=true;else for(var l=d.split("."),m=0;m<l.length;m++){var n=l[m];k=k[n];if(k==h.subject){i=true;break}}}else if(h.eventType==tent.changes.EventTypes.MANYCHANGES)i=true;if(i){h=c;k=null;if(d){l=d.split(".");
for(m=0;m<l.length;m++){n=l[m];k=h;h=h[n];if(h==null||typeof h=="undefined")break;else tent.changes.bind(h,{live:e.live,log:e.log,deepStack:[k],bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:this}]})}}l=g;if(n=j){k=j.split(".");for(m=0;m<k.length;m++){n=k[m];tgtParent=l;l=l[n];if(l==null||typeof l=="undefined"){if(m<k.length-1)i=false;break}}l=tgtParent}if(i)if(e.template)tent.databinding.parseTemplate(e.template,h,l,n);else{if(typeof e.format=="function")h=e.format(h);if(l[n]!=h)l[n]=
h}}};return f};tent.databinding.bind=function(c,d,g,j,e){e||(e={});var f=a(c,d,g,j,e);if(e.deep){if(e.bidirectional)throw"cannot use bidirectional databinding when using a deep tracking";tent.changes.bind(c,{deep:true,live:e.live,log:e.log,bindings:[{handler:f}]})}else{if(e.bidirectional){if(e.template)throw"cannot use bidirectional databinding when using a template";var h=a(g,j,c,d,e);tent.changes.bind(g,{live:e.live,log:e.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:h}]})}tent.changes.bind(c,
{live:e.live,log:e.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:f}]})}c=!d?c:c[d];if(e.template)tent.databinding.parseTemplate(e.template,c,g,j);else if(g[j]!=c)g[j]=c};var b={};tent.databinding.parseTemplate=function(c,d,g,j){var e;try{var f=b[c];if(!f){var h="var p=[],print=function (){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").replace(/'(?=[^#]*#>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<#=(.+?)#>/g,"',$1,'").split("<#").join("');").split("#>").join("p.push('")+
"');}return p.join('');";f=new Function("obj",h);b[c]=f}e=f(d)}catch(i){e="< # ERROR: "+i.message+" # >"}if(g)if(j)g[j]=e;else g.innerHTML=e;return e}});tent.declare("tent.changes.reverseProperties",function(){tent.changes.reverseProperties.setReverseProperty=function(b,c,d){d||(d={});d.cardinality=d.cardinality?d.cardinality.toLowerCase():"11";if(!d.reverse)d.reverse=c+"Of";var g={name:d.reverse,cardinality:d.cardinality};if(d.cardinality.substr(0,1)==="n"||d.cardinality.substr(0,1)==="m")g.isArray=true;if(!b.__reverseProperties__)b.__reverseProperties__={};if(d.cardinality.substr(1,1)==="n"||d.cardinality.substr(1,1)==="m"){if(typeof b[c]=="undefined"||
!(b[c]instanceof Array))b[c]=[];b.__reverseProperties__[c]=g;b[c].__parent__=b;b[c].__reverseProperty__=g}else{if(typeof b[c]=="undefined")b[c]=null;b.__reverseProperties__[c]=g}};tent.changes.reverseProperties.setReverseProperties=function(b,c){if(c)for(var d in c)c[d].reverse&&tent.changes.reverseProperties.setReverseProperty(b,d,c[d])};tent.changes.reverseProperties.Set=function(b){this.properties=b};tent.changes.reverseProperties.Set.prototype.create=function(){var b={};this.applyTo(b);return b};
tent.changes.reverseProperties.Set.prototype.applyTo=function(){var b=[];b.bind=function(d){d||(d={});d.reverseProperties=true;for(var g=0;g<this.length;g++){var j=this[g];if(j.__reverseProperties__){tent.changes.bind(j,d);var e=j.__reverseProperties__,f;for(f in e)if(e.hasOwnProperty(f))if(e[f].cardinality&&(e[f].cardinality[1]=="n"||e[f].cardinality[1]=="m")){if(!(j[f]instanceof Array)){j[f]=[];j[f].__parent__=j;j[f].__reverseProperty__=j.__reverseProperties__[f]}tent.changes.bind(j[f],d)}}}};if(this.properties){for(var c=
0;c<arguments.length;c++)tent.changes.reverseProperties.setReverseProperties(arguments[c],this.properties);b.push.apply(b,arguments)}return b};var a;tent.changes.reverseProperties.getHandler=function(){a||(a=function(b){if(b.eventType==tent.changes.EventTypes.ADDED){var c=b.data.items;if(c&&b.subject&&b.subject.__reverseProperty__){var d=b.subject.__reverseProperty__;b=b.subject.__parent__;for(var g=0,j=c.length;g<j;g++){var e=c[g];if(d.isArray){e[d.name]||(e[d.name]=[]);e[d.name].indexOf(b)<0&&e[d.name].push(b)}else if(e[d.name]!=
b){if(typeof e[d.name]!="undefined"&&e[d.name]!=null)throw Error("this."+d.name+" is set. Remove this from its current array before adding it to this array");e[d.name]=b}}}}else if(b.eventType==tent.changes.EventTypes.REMOVED){if((c=b.data.items)&&b.subject&&b.subject.__reverseProperty__){d=b.subject.__reverseProperty__;b=b.subject.__parent__;g=0;for(j=c.length;g<j;g++){e=c[g];if(d.isArray){if(e=e[d.name])for(var f=0,h=e.length;f<h;f++)if(e[f]===b){e.splice(f,1);f--;h--}}else if(e[d.name]===b)e[d.name]=
null}}}else if(b.eventType==tent.changes.EventTypes.CHANGED)if(b.data.propertyName&&b.subject&&b.subject.__reverseProperties__)if(d=b.subject.__reverseProperties__[b.data.propertyName])if(d.isArray){if(e=b.data.oldValue){e=e[d.name];if(e instanceof Array){g=0;for(j=e.length;g<j;g++)if(e[g]===b.subject){e.splice(g,1);g--;j--}}}if(e=b.data.current){e[d.name]||(e[d.name]=[]);e[d.name]instanceof Array&&e[d.name].indexOf(b.subject)<0&&e[d.name].push(b.subject)}}else{if(e=b.data.oldValue)if(e[d.name]==
b.subject)e[d.name]=null;if(e=b.data.current)if(e[d.name]!=b.subject)e[d.name]=b.subject}});return a}});tent.declare("tent.entities",function(){tent.entities.ChangeStates=new tent.coreTypes.Enum("DETACHED,UNCHANGED,ADDED,MODIFIED,DELETED");tent.entities.Type=function(a,b){this.name=a;this.properties=b;if(b instanceof tent.changes.reverseProperties.Set)this.reversePropertySet=b;else if(typeof b=="object")this.reversePropertySet=new tent.changes.reverseProperties.Set(b);else throw"cannot create a Type without properties";};tent.entities.Type.prototype.getIdPropertyName=function(a){if(a.__entityType__&&
a.__entityType===this){if(typeof this.idProperty=="undefined"){this.idProperty=null;for(var b in this.properties)if(this.properties[b].identity){if(this.idProperty){console.error('Error on type "'+this.name+'": multiple identity properties');break}this.idProperty=b}}if(this.idProperty)return this.idProperty;else{if(typeof a.id!="undefined")return"id";if(typeof a._id!="undefined")return"_id"}}else return tent.entities.getIdPropertyName(a)};tent.entities.Type.prototype.getId=function(a){var b=this.getIdPropertyName(a);
if(b)return a[b]};tent.entities.Type.prototype.toString=function(){return"EntityType("+this.name+")"};tent.entities.Type.prototype.applyTo=function(){this.reversePropertySet.applyTo.apply(this.reversePropertySet,arguments);for(var a=0;a<arguments.length;a++){if(arguments[a].__entityType__!=this)arguments[a].__entityType__=this;for(var b in this.properties){var c=this.properties[b];if(typeof arguments[a][b]=="undefined")arguments[a][b]=!c.cardinality||c.cardinality.substr(1,1)==="1"?null:[]}}};tent.entities.Collection=
function(a,b,c){this.context=a;this.type=b;this.name=c||b.name;this.items=[];tent.arrays.extend(this.items)};tent.entities.Collection.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)this.push.apply(this,arguments[a]);else if(arguments[a].__collection__){if(arguments[a].__collection__!=this)throw"cannot add this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+
arguments[a].__entityType__.name+'" to this collection';}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;this.items.push(arguments[a]);this.context.changeHandler&&this.context.changeHandler.itemAdded(arguments[a]);this.type&&this.context.__cascadePush__(arguments[a])}}return this.items.length};tent.entities.Collection.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays to a Collection";
else if(arguments[a].__collection__){if(arguments[a].__collection__!=this)throw"cannot attach this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;arguments[a].__changeState__!=tent.entities.ChangeStates.DELETED&&
this.items.push(arguments[a]);this.context.changeHandler&&this.context.changeHandler.itemAttached(arguments[a]);this.type&&this.context.__cascadeAttach__(arguments[a])}}return this.items.length};tent.entities.Collection.prototype.remove=function(){for(var a=false,b=0,c=arguments.length;b<c;b++){var d=arguments[b];if(this.items.remove(d)){a=true;this.context.changeHandler&&this.context.changeHandler.itemRemoved(arguments[b]);this.type&&this.context.__cascadeRemove__(d)}}return a};tent.entities.Collection.prototype.detach=
function(){for(var a=false,b=0,c=arguments.length;b<c;b++){var d=arguments[b];if(this.items.remove(d)||d.__changeState__==tent.entities.ChangeStates.DELETED){a=true;this.context.changeHandler&&this.context.changeHandler.itemDetached(d);delete d.__collection__;d.__entityType__&&this.context.__cascadeDetach__(d)}}return a};tent.entities.Collection.prototype.detachAll=function(){if(this.items.length<1)return false;for(var a=this.items.pop();typeof a!="undefined";){this.context.changeHandler&&this.context.changeHandler.itemDetached(a);
delete a.__collection__;a.__entityType__&&this.context.__cascadeDetach__(a);a=this.items.pop()}this.items.length=0;return true};tent.entities.Collection.prototype.find=function(a){if(a instanceof Array){for(var b=[],c=0,d=a.length;c<d;c++)b[c]=this.find(a[c]);return b}else{b=null;var g=this.type?this.type.idProperty:null;b=typeof a=="string"||typeof a=="number"?g?function(j){return j[g]===a}:function(j){return tent.entities.getId(j)===a}:g&&typeof a[g]!="undefined"?function(j){return j[g]===a[g]}:
function(j){for(var e in a)if(j[e]!==a[e])return false;return true};return this.items.first(b)}};tent.entities.Collection.prototype.getById=function(a){return this.items.first(function(b){return tent.entities.getId(b)===a})};tent.entities.Context=function(a,b){this.__collections__={};this.__types__={};if(typeof a!="boolean"){b=a;a=null}b||(b={});if(a===true)b.trackChanges=true;b.trackChanges===true&&this.trackChanges();this.options=b;this.changes=null};tent.entities.MyContext=new tent.entities.Context;
tent.entities.Context.prototype.getIdPropertyName=function(a){if(a.__entityType__)return a.__entityType__.getIdPropertyName(a);else if(this.options.defaultIdProperty)return this.options.defaultIdProperty;else{if(typeof a.id!="undefined")return"id";if(typeof a._id!="undefined")return"_id"}};tent.entities.Context.prototype.getId=function(a){var b=this.getIdPropertyName(a);if(b)return a[b]};tent.entities.Context.prototype.all=function(){var a=[],b;for(b in this.__collections__)a.push.apply(a,this.__collections__[b].items);
return a};tent.entities.Context.prototype.items=function(){return this._Object?this._Object.items:this.getCollection().items};tent.entities.Context.prototype.first=function(a){for(var b in this.__collections__){var c=this.__collections__[b].items.first(a);if(c)return c}return null};tent.entities.Context.prototype.find=function(a){if(a instanceof Array){for(var b=[],c=0,d=a.length;c<d;c++)b[c]=this.find(a[c]);return b}else{for(b in this.__collections__)if(c=this.__collections__[b].find(a))return c;
return null}};tent.entities.Context.prototype.filter=function(a){var b=[],c;for(c in this.__collections__)b.push.apply(b,this.__collections__[c].items.filter(a));return b};tent.entities.Context.prototype.contains=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(typeof b!="object")return false;else if(b.__collection__){if(this.__collections__[b.__collection__.name]!=b.__collection__)return false}else if(b instanceof tent.entities.Type){if(this.__types__[b.name]!=b)return false}else if(b instanceof
tent.entities.Collection){if(this!=b.context)return false}else return false}return true};tent.entities.Context.prototype.getCollection=function(a,b){if(b){if(a&&!a instanceof tent.entities.Type)throw"provided type is not a Type instance";}else if(a)if(a instanceof tent.entities.Type)b=a.name;else if(typeof a=="string"){b=a;a=null}else throw"provide a Type or name to create a Collection";else b="_Object";if(!this.__collections__[b]){this.__collections__[b]=new tent.entities.Collection(this,a,b);for(var c=
b;this[c];)c+="_";this[c]=this.__collections__[b]}return this.__collections__[b]};tent.entities.Context.prototype.pushModel=function(a){if(a)if(a.types)for(var b in a.types)this.push(new tent.entities.Type(b,a.types[b]))};tent.entities.Context.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot push arrays into a Context";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot push this item, it belongs to another Context";
}else if(arguments[a]instanceof tent.entities.Type){if(!arguments[a].name)throw"cannot add an EntityType without name";if(this.__types__[arguments[a].name])if(this.__types__[arguments[a].name]==arguments[a])continue;else throw'EntityType "'+arguments[a].name+'" already exists';this.__types__[arguments[a].name]=arguments[a];this.getCollection(arguments[a])}else if(arguments[a]instanceof tent.entities.Context)throw"cannot add an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=
arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.getCollection(b).push(arguments[a])}};tent.entities.Context.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot attach this item, it belongs to another Context";
}else if(arguments[a]instanceof tent.entities.Type)throw"cannot attach EntityTypes";else if(arguments[a]instanceof tent.entities.Context)throw"cannot attach an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.getCollection(b).attach(arguments[a])}};tent.entities.Context.prototype.remove=
function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof tent.entities.Type)throw"cannot remove EntityTypes";else if(arguments[a]instanceof tent.entities.Context)throw"cannot remove an EntityContext from an EntityContext";else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.remove(arguments[a])};tent.entities.Context.prototype.detach=function(){for(var a=0;a<arguments.length;a++){if(arguments[a]instanceof Array)throw"cannot detach arrays";if(arguments[a]instanceof
tent.entities.Type)throw"cannot detach EntityTypes";else if(arguments[a]instanceof tent.entities.Context)throw"cannot detach an EntityContext from an EntityContext";else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.detach(arguments[a])}};tent.entities.Context.prototype.detachAll=function(){for(var a=false,b=0;b<this.__collections__.length;b++)if(this.__collections__[b].detachAll())a=true;return a};tent.entities.Context.prototype.touch=function(){if(this.changeHandler)return this.changeHandler.touch.apply(this.changeHandler,
arguments)};tent.entities.Context.prototype.__cascadePush__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var d=b.__entityType__.properties[c];if(d.cascadePush){var g=null;if(d.collection)g=this.__collections__[d.collection]||this.getCollection(d.collection);if(b[c]instanceof Array){if(d.cardinality&&d.cardinality[1]!="1")g?g.push.apply(g,b[c]):this.push.apply(this,b[c])}else g?
g.push(b[c]):this.push(b[c])}}}};tent.entities.Context.prototype.__cascadeAttach__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var d=b.__entityType__.properties[c];if(d.cascadeAttach){var g=null;if(d.collection)g=this.__collections__[d.collection]||this.getCollection(d.collection);if(b[c]instanceof Array){if(d.cardinality&&d.cardinality[1]!="1")g?g.attach.apply(g,b[c]):this.attach.apply(this,
b[c])}else g?g.attach(b[c]):this.attach(b[c])}}}};tent.entities.Context.prototype.__cascadeRemove__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var d=b.__entityType__.properties[c];if(d.cascadeRemove)if(b[c]instanceof Array)d.cardinality&&d.cardinality[1]!="1"&&this.remove.apply(this,b[c]);else this.remove(b[c])}}};tent.entities.Context.prototype.__cascadeDetach__=function(){for(var a=
0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var d=b.__entityType__.properties[c];if(d.cascadeDetach)if(b[c]instanceof Array)d.cardinality&&d.cardinality[1]!="1"&&this.detach.apply(this,b[c]);else this.detach(b[c])}}};tent.entities.Context.prototype.trackChanges=function(){if(!this.changeHandler){this.changeHandler=new tent.entities.ContextChangeHandler(this);this.changeHandler.init()}};tent.entities.Context.prototype.hasChanges=
function(){return!!(this.changes&&this.changes.items.length>0)};tent.entities.Context.prototype.markAsSaving=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b instanceof Array)this.markAsSaving.apply(this,b);else{if(b.__syncState__&&b.__syncState__.saving)throw"cannot start saving, item already being saved";b.__syncState__={saving:true}}}};tent.entities.Context.prototype.acceptAllChanges=function(){this.changeHandler&&this.changeHandler.acceptAllChanges()};tent.entities.Context.prototype.acceptChanges=
function(){this.changeHandler&&this.changeHandler.acceptChanges.apply(this.changeHandler,arguments)};tent.entities.EntityLink=function(a,b,c,d){this.from=a;this.to=b;this.propertyName=c;this.__changeState__=d||tent.entities.ChangeStates.DETACHED};tent.entities.ContextChanges=function(a){this.context=a;this.items=[];tent.arrays.extend(this.items)};tent.entities.ContextChanges.prototype.toString=function(){for(var a=new tent.coreTypes.NameCounter,b=0,c=this.items.length;b<c;b++)a.add(tent.entities.ChangeStates.getName(this.items[b].__changeState__)+
"."+this.items[b].__collection__.name);return a.toString()};tent.entities.ContextChangeHandler=function(a){this.context=a};tent.entities.ContextChangeHandler.prototype.isDetached=function(a){return!a.__changeState__||a.__changeState__==tent.entities.ChangeStates.DETACHED};tent.entities.ContextChangeHandler.prototype.bindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var c=a.__entityType__.properties[b];if(c.cardinality&&c.cardinality.substr(1,1)!="1"&&a[b]instanceof
Array){a[b].__parent__=a;a[b].__propertyName__=b;tent.changes.bind(a[b],this)}}};tent.entities.ContextChangeHandler.prototype.unbindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var c=a.__entityType__.properties[b];c.cardinality&&c.cardinality.substr(1,1)!="1"&&a[b]instanceof Array&&tent.changes.unbind(a[b],this)}};tent.entities.ContextChangeHandler.prototype.trackComplexProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties)a.__entityType__.properties[b].complex&&
typeof a[b]=="object"&&tent.changes.track(a[b],{deep:true,attachedObjects:false,parentObject:a,parentObjectPropertyName:b});else for(b in a)b.substr(0,1)!=="_"&&a.hasOwnProperty(b)&&typeof a[b]=="object"&&tent.changes.track(a[b],{deep:true,attachedObjects:false,parentObject:a,parentObjectPropertyName:b})};tent.entities.ContextChangeHandler.prototype.setAdded=function(a){if(a.__changeState__!=tent.entities.ChangeStates.ADDED)if(a.__collection__)if(a.__collection__.context==this.context){a.__changeState__=
tent.entities.ChangeStates.ADDED;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else throw"cannot set this item as ADDED, it belongs to another Context";else a.__changeState__=tent.entities.ChangeStates.ADDED};tent.entities.ContextChangeHandler.prototype.setRemoved=function(a){if(!(this.isDetached(a)||a.__changeState__==tent.entities.ChangeStates.DELETED))if(a.__collection__)if(a.__collection__.context==this.context)if(a.__changeState__==
tent.entities.ChangeStates.UNCHANGED||a.__changeState__==tent.entities.ChangeStates.MODIFIED){a.__changeState__=tent.entities.ChangeStates.DELETED;if(a.__syncState__&&a.__syncState__.saving)a.__syncState__.deletedWhileSaving=true;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else{if(a.__changeState__==tent.entities.ChangeStates.ADDED){this.context.changes.items.remove(a);if(a.__syncState__&&a.__syncState__.saving){a.__syncState__.deletedWhileSaving=
true;a.__changeState__=tent.entities.ChangeStates.DELETED;this.context.changes.items.pushUnique(a)}else{a.__changeState__=tent.entities.ChangeStates.DETACHED;delete a.__collection__}}}else throw"cannot set this item as DELETED, it belongs to another Context";else{a.__changeState__=tent.entities.ChangeStates.DELETED;if(a.__syncState__&&a.__syncState__.saving)a.__syncState__.deletedWhileSaving=true}};tent.entities.ContextChangeHandler.prototype.touch=function(){for(var a=0,b=arguments.length;a<b;a++)if(arguments[a].__collection__&&
arguments[a].__collection__.context==this.context)if(arguments[a].__changeState__===tent.entities.ChangeStates.UNCHANGED){if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this);arguments[a].__changeState__=tent.entities.ChangeStates.MODIFIED;this.context.changes.items.pushUnique(arguments[a])}else if(arguments[a].__syncState__&&arguments[a].__syncState__.saving&&(arguments[a].__changeState__===tent.entities.ChangeStates.MODIFIED||arguments[a].__changeState__===tent.entities.ChangeStates.ADDED))arguments[a].__syncState__.changedWhileSaving=
true};tent.entities.ContextChangeHandler.prototype.itemAdded=function(a){if(this.isDetached(a))this.setAdded(a);else if(a.__changeState__!=tent.entities.ChangeStates.UNCHANGED){if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}if(a.__changeState__!=tent.entities.ChangeStates.DELETED){tent.changes.bind(a,this);this.bindArrayProperties(a);this.trackComplexProperties(a)}};tent.entities.ContextChangeHandler.prototype.itemAttached=
function(a){if(this.isDetached(a))a.__changeState__=tent.entities.ChangeStates.UNCHANGED;this.itemAdded(a)};tent.entities.ContextChangeHandler.prototype.itemRemoved=function(a){this.setRemoved(a);tent.changes.unbind(a,this);this.unbindArrayProperties(a)};tent.entities.ContextChangeHandler.prototype.itemDetached=function(a){var b=this.context.changes;a.__changeState__!=tent.entities.ChangeStates.UNCHANGED&&b&&b.items.remove(a);delete a.__changeState__;tent.changes.unbind(a,this);this.unbindArrayProperties(a)};
tent.entities.ContextChangeHandler.prototype.objectLinked=function(a,b,c,d){if(typeof d=="object")if(d instanceof Array){if(d.__parent__!=a){if(d.__parent__)throw"this array already has another parent object";d.__parent__=a}if(d.__propertyName__!=b)d.__propertyName__=b;tent.changes.bind(d,this);c.onLinkPush&&this.context.attach.push(this.context,d)}else if(d!==null&&typeof d!="undefined"){if(d.__changeState__==tent.entities.ChangeStates.DELETED)throw'cannot link a DELETED object to property "'+c+
'"';if(d.__collection__){if(d.__collection__.context!=this.context)throw"cannot link this object, it belongs to another Context";if(c.collection&&d.__collection__.name!=c.collection)throw"cannot link an object of collection "+c.collection+' to property "'+c+'"';}if(!d.__collection__&&c.onLinkPush){d.__entityType__&&this.context.push(d.__entityType__);if(c.collection){if(!this.context.__collections__[c.collection])throw Error('Collection "'+c.collection+'" not found in this Context');this.context.__collections__[c.collection].push(d)}else this.context.push(d)}if(c.trackLinks){c=
null;for(var g=this.context.changes.items.length-1;g>=0;g--){var j=this.context.changes.items[g];if(j instanceof tent.entities.EntityLink&&j.from===a&&j.to===d&&j.propertyName==b){c=j;break}}if(c){if(c.__changeState__==tent.entities.ChangeStates.DELETED)c.__changeState__=tent.entities.ChangeStates.UNCHANGED}else{c=new tent.entities.EntityLink(a,d,b,tent.entities.ChangeStates.ADDED);this.context.changes.items.push(c)}}}};tent.entities.ContextChangeHandler.prototype.objectUnlinked=function(a,b,c,d){if(typeof d==
"object")if(d instanceof Array){delete d.__parent__;delete d.__propertyName__;tent.changes.unbind(d,this);c.onUnlinkRemove&&this.context.remove.apply(this.context,d)}else if(d!==null&&typeof d!="undefined"){c.onUnlinkRemove&&d.__collection__&&d.__collection__.remove(d);if(c.trackLinks){c=null;for(var g=-1,j=this.context.changes.items.length-1;j>=0;j--){var e=this.context.changes.items[j];if(e instanceof tent.entities.EntityLink&&e.from===a&&e.to===d&&e.propertyName==b){c=e;g=j;break}}if(c)if(c.__changeState__==
tent.entities.ChangeStates.ADDED)this.context.changes.items.splice(g,1);else{if(c.__changeState__!=tent.entities.ChangeStates.DELETED)c.__changeState__=tent.entities.ChangeStates.DELETED}else{c=new tent.entities.EntityLink(a,d,b,tent.entities.ChangeStates.DELETED);this.context.changes.items.push(c)}}}};tent.entities.ContextChangeHandler.prototype.getTrackedProperty=function(a,b){var c;if(a.__entityType__&&a.__changeState__&&a.__changeState__!=tent.entities.ChangeStates.DELETED&&a.__changeState__!=
tent.entities.ChangeStates.DETACHED&&a.__collection__&&a.__collection__.context==this.context&&(c=a.__entityType__.properties[b]))return c};tent.entities.ContextChangeHandler.prototype.handle=function(a){if(a.subject){var b;if(a.eventType==tent.changes.EventTypes.CHANGED)if(a.subject.__entityType__){if(b=this.getTrackedProperty(a.subject,a.data.propertyName)){this.context.touch(a.subject);this.objectUnlinked(a.subject,a.data.propertyName,b,a.data.oldValue);this.objectLinked(a.subject,a.data.propertyName,
b,a.data.current)}}else this.context.touch(a.subject);else if(a.eventType==tent.changes.EventTypes.ADDED){var c=a.subject.__parent__;if(c&&(b=this.getTrackedProperty(c,a.data.propertyName)))for(var d=0,g=a.data.items.length;d<g;d++)this.objectLinked(c,a.data.propertyName,b,a.data.items[d])}else if(a.eventType==tent.changes.EventTypes.REMOVED)if((c=a.subject.__parent__)&&(b=this.getTrackedProperty(c,a.data.propertyName))){d=0;for(g=a.data.items.length;d<g;d++)this.objectUnlinked(c,a.data.propertyName,
b,a.data.items[d])}tent.changes.reverseProperties.getHandler()(a)}};tent.entities.ContextChangeHandler.prototype.init=function(){if(this.context.log)var a=new tent.coreTypes.NameCounter;for(var b in this.context.__collections__){for(var c=this.context.__collections__[b],d=0,g=c.items.length;d<g;d++)this.itemAttached(c.items[d]);a&&a.add(b,c.items.length)}if(this.context.log)a&&a.root._count>0?tent.log.debug("Context: initialized with "+a):tent.log.debug("Context: initialized empty")};tent.entities.ContextChangeHandler.prototype.acceptAllChanges=
function(){if(this.context.hasChanges()){this.context.log&&tent.log.debug("Context: accepting changes, "+this.context.changes);for(var a=this.context.changes.items,b=0,c=a.length;b<c;b++)a[b].__changeState__=tent.entities.ChangeStates.UNCHANGED;a.length=0;this.context.log&&tent.log.debug("Context: all changes accepted")}};tent.entities.ContextChangeHandler.prototype.acceptChanges=function(){for(var a=0,b=arguments.length;a<b;a++){var c=arguments[a],d;if(typeof c=="number"){d=c;if(d<0||this.context.changes.items.length<
d-1){c=null;d=-1}else c=this.context.changes.items[d]}else d=this.context.changes.items.lastIndexOf(c);if(d>=0&&c){if(c.__changeState__===tent.entities.ChangeStates.ADDED||c.__changeState__===tent.entities.ChangeStates.MODIFIED){this.context.changes.items.splice(d,1);c.__changeState__=tent.entities.ChangeStates.UNCHANGED;if(c.__syncState__&&c.__syncState__.changedWhileSaving){delete c.__syncState__;this.context.touch(c)}}else if(c.__changeState__===tent.entities.ChangeStates.DELETED){this.context.changes.items.splice(d,
1);c.__changeState__=tent.entities.ChangeStates.DETACHED;delete c.__collection__}delete c.__syncState__}}};tent.entities.getIdPropertyName=function(a){if(a.__entityType__)return a.__entityType__.getIdPropertyName(a);else{if(a.__collection__)return a.__collection__.context.getIdPropertyName(a);if(typeof a.id!="undefined")return"id";if(typeof a._id!="undefined")return"_id"}};tent.entities.getId=function(a){var b=tent.entities.getIdPropertyName(a);if(b)return a[b]}});tent.declare("tent.connectors",function(){});tent.declare("tent.connectors.http",function(){tent.connectors.http.uriCombine=function(){for(var a="",b=0,c=arguments.length;b<c;b++){var d;if(d=typeof arguments[b]=="undefined"||arguments[b]===null?"":arguments[b]+"")if(d.match(/^[A-Za-z]+\:\/\//))a=d;else{var g=a.indexOf("?"),j=a.indexOf("#");if(j>=0&&(g<0||g>j))g=j;if(g>=0)a=a.substr(0,g);a+=a.substr(a.length-1,1)=="/"?d.substr(0,1)=="/"?d.substr(1):d.substr(0,2)=="./"?d.substr(2):d:d.substr(0,1)=="/"?d:d.substr(0,2)=="./"?d.substr(1):"/"+d}}return a};
tent.connectors.http.requestDefaultOptions={type:"GET",cache:false};tent.connectors.http.request_nodejs=function(){throw"http request using node.js not implemented";};tent.connectors.http.request_jquery=function(a,b){if(typeof jQuery=="undefined")throw"jQuery is required for ajax requests";(function(c,d){jQuery.ajax({url:tent.connectors.http.uriCombine(c.baseUrl,c.url),beforeSend:function(g){if(c.auth){if(typeof Base64=="undefined")throw"Base64 is required for http basic authentication";var j=Base64.encode(c.username+
":"+c.password);g.setRequestHeader("Origin",document.location.protocol+"//"+document.location.host);g.setRequestHeader("Authorization","Basic "+j)}},type:c.type,cache:!!c.cache,dataType:"json",contentType:"application/json",data:JSON.stringify(c.data),headers:c.headers,timeout:c.timeout,username:c.username,password:c.password}).done(function(g,j,e){typeof d=="function"&&d({ok:true,data:g,req:e})}).fail(function(g,j,e){if(typeof d=="function")d({error:e||"error",req:g})})})(tent.combineOptions(tent.connectors.http.requestDefaultOptions,
a),b)};tent.connectors.http.request=tent.connectors.http.request_jquery});tent.declare("tent.connectors.rest",function(){tent.connectors.rest.RestConnector=function(){this.provider="Custom REST";this.baseUrl=null;this.loading=this.saving=false;this.options={entityLinkUrl:"_links",load:{http:{}},saveChanges:{bulk:true,bulkUrl:"_bulk",useCollectionInUrl:true,revisionProperty:"_rev",http:{type:"POST"}}};this.auth={username:"",password:""};this.filters={load:[],saveChanges:[],saveResult:[]};this.processors={load:[],saveResult:[]};this.processors.load.push(tent.connectors.rest.processors.load.defaultLoader);
this.processors.saveResult.push(tent.connectors.rest.processors.saveResult.saveResultReceiveByPosition);this.filters.saveChanges.push(tent.connectors.rest.filters.saveChanges.packChanges,tent.connectors.rest.filters.saveChanges.setUrlAndMethod)};tent.connectors.rest.RestConnector.prototype.createdb=function(a){tent.connectors.http.request({url:this.baseUrl,type:"PUT"},a)};tent.connectors.rest.RestConnector.prototype.deletedb=function(a){tent.connectors.http.request({url:this.baseUrl,type:"DELETE"},
a)};tent.connectors.rest.RestConnector.prototype.filterData=function(a){if(typeof a.action=="string"&&this.filters[a.action]&&this.filters[a.action].length>0)for(var b=this.filters[a.action],c=0,d=b.length;c<d;c++)a=b[c](a);return a};tent.connectors.rest.RestConnector.prototype.process=function(a){if(typeof a.action=="string"&&this.processors[a.action]&&this.processors[a.action].length>0)for(var b=this.processors[a.action],c=0,d=b.length;c<d;c++)b[c](a);return a};tent.connectors.rest.RestConnector.prototype.load=
function(a,b,c,d){var g={action:"load"},j=this;try{if(typeof c=="function"){d=c;c=null}g.options=tent.combineOptions(this.options,this.options.load,c);g.options.url=b||g.options.url;if(!g.options.baseUrl)g.options.baseUrl=this.baseUrl;if(!a)throw"a context is required for loading entities";if(!g.options.url)throw"an url must be specified to load";if(this.saving)throw"cannot load while saving";if(this.loading)throw"already loading entities";this.loading=true;g.options.context=a;tent.connectors.http.request(tent.combineOptions(g.options,
g.options.http),function(f){g.req=f.req;if(f.error)g.error=f.error;else{g.data=f.data;g=j.filterData(g);j.process(g);if(!g.error)g.ok=true}j.loading=false;d&&d(g)})}catch(e){this.loading=false;g.error=e;d&&d(g)}};tent.connectors.rest.RestConnector.prototype.saveChanges=function(a,b,c){var d={action:"saveChanges"},g=this;try{if(typeof b=="function"){c=b;b=null}d.options=tent.combineOptions(this.options,this.options.saveChanges,b);if(!d.options.baseUrl)d.options.baseUrl=this.baseUrl;if(!a)throw"a context is required for saving changes";
if(this.saving)throw"already saving changes";if(this.loading)throw"cannot save while loading";if(!(a instanceof tent.entities.Context))throw"a tent.entities.Context is required";this.saving=true;d.options.context=a;d=g.filterData(d);if(d.data){d.options.data=d.data;d.options.data==="-"&&delete d.options.data;tent.connectors.http.request(tent.combineOptions(d.options,d.options.http),function(e){d.req=e.req;if(e.error)d.error=e.error;else{d.qdata=d.data;d.data=e.data;d.action="saveResult";d=g.filterData(d);
g.process(d);if(!d.error)d.ok=true}g.saving=false;c&&c(d)})}else{d.noop=true;if(!d.error)d.ok=true;c&&c(d)}}catch(j){this.saving=false;d.error=j;c&&c(d)}};tent.connectors.rest.processors={load:{defaultLoader:function(a){if(!(a.action!="load"&&a.action!="saveResult"))for(var b,c,d,g,j=0,e=a.data.items.length;j<e;j++){c=a.data.items[j];d=false;g=(b=a.options.collection?a.options.collection:a.options.discriminatorProperty?doc[a.options.discriminatorProperty]:null)?a.options.context.getCollection(b):
null;b=(g||a.options.context).find(c);if(c._deleted)if(b){if(b.__changeState__!==tent.entities.ChangeStates.MODIFIED){(g||a.options.context).remove(b);(g||a.options.context).detach(b);d=true}}else d=true;else if(b){if(!(b.__changeState__===tent.entities.ChangeStates.MODIFIED||b.__changeState__===tent.entities.ChangeStates.DELETED)){tent.pset(b,c,true);a.options.context.changeHandler&&a.options.context.changeHandler.trackComplexProperties(b);d=true}}else{(g||a.options.context).attach(c);d=true}if(d){a.data.items.splice(j,
1);j--;e--}}}},saveResult:{saveResultReceiveByPosition:function(a){if(a.action=="saveResult")if(!(!a.packedChanges||!a.packedChanges.length>0)){for(var b,c,d=0,g=a.packedChanges.length;d<g;d++){b=a.packedChanges[d];if(c=a.data.items[d])if(b.__changeState__===tent.entities.ChangeStates.DELETED)if(c.deleted||c._deleted)a.options.context.acceptChanges(b);else{b.__syncState__.saving=false;b.__syncState__.error=c.error||"no delete response";b.__syncState__.message=c.message;b.__syncState__.reason=c.reason}else if(c.error){b.__syncState__.saving=
false;b.__syncState__.error=c.error;b.__syncState__.message=c.message;b.__syncState__.reason=c.reason}else{a.options.context.acceptChanges(b);if(b.__changeState__===tent.entities.ChangeStates.UNCHANGED){tent.pset(b,c,true);a.options.context.changeHandler&&a.options.context.changeHandler.trackComplexProperties(b)}}else{b.__syncState__.saving=false;b.__syncState__.error="noresponse";b.__syncState__.reason="no response from server"}}a.data.items.splice(0,a.packedChanges.length)}}}};tent.connectors.rest.filters=
{saveChanges:{packChanges:function(a){if(a.action!="saveChanges")return a;if(a.options.context.hasChanges())for(var b=-1,c=function(){if(a.options.maxCount&&a.data&&a.data.items&&a.data.items.length>=a.options.maxCount)return false;if(a.options.bulk===false&&a.data&&a.data.items&&a.data.items.length>0)return false;b++;if(b>=a.options.context.changes.items.length)return false;if(!a.data)a.data={};if(!a.data.items)a.data.items=[];var d=a.options.context.changes.items[b],g;if(d instanceof tent.entities.EntityLink){g=
{_link:true,from:tent.entities.getId(d.from),to:tent.entities.getId(d.to),property:d.propertyName};if(d.__changeState__===tent.entities.ChangeStates.DELETED)g._deleted=true}var j=tent.entities.getIdPropertyName(d);g=d.__changeState__===tent.entities.ChangeStates.DELETED?{_deleted:true}:tent.clone(d,{deep:true,onlyOwnProperties:true,attachedObjectsIds:true,attachedObjects:false,skipPrivates:true});if(j&&d[j])g[j]=tent.pget(d,j);if(a.options.revisionProperty)g[a.options.revisionProperty]=tent.pget(d,
a.options.revisionProperty);if(a.options.discriminatorProperty&&d.__collection__)g[a.options.discriminatorProperty]=d.__collection__.name;if(g=g){a.data.items.push(g);a.options.context.markAsSaving(d);if(!a.packedChanges)a.packedChanges=[];a.packedChanges.push(d)}return true};c(););return a},setUrlAndMethod:function(a){if(a.action!="saveChanges")return a;if(!a.packedChanges||!a.packedChanges.length>0)return a;if(a.options.bulk||a.packedChanges.length>1){if(!(a.options.http.url||a.options.url))a.options.http.url=
a.options.bulkUrl}else if(a.packedChanges.length==1){if(!(a.options.http.url||a.options.url)){var b=a.packedChanges[0],c="/";if(b instanceof tent.entities.EntityLink){if(a.options.entityLinkUrl)c=tent.connectors.http.uriCombine(c,a.options.entityLinkUrl)}else if(a.options.useCollectionInUrl&&b.__collection__)c=tent.connectors.http.uriCombine(c,b.__collection__.name);var d=tent.entities.getId(b);if(typeof d!="undefined"){c=tent.connectors.http.uriCombine(c,d);a.options.http.type=b.__changeState__===
tent.entities.ChangeStates.DELETED?"DELETE":"PUT"}else a.options.http.type="POST";a.options.http.url=c}a.data=a.data.items[0];if(a.options.http.type==="DELETE")a.data="-"}return a}}}});tent.declare("tent.connectors.couchdb",function(){tent.connectors.couchdb.CouchDBConnector=function(){var a=new tent.connectors.rest.RestConnector;a.couchdb=true;a.provider="CouchDB";a.options.saveChanges.bulk=true;a.options.saveChanges.bulkUrl="_bulk_docs";a.options.saveChanges.useCollectionInUrl=false;a.options.saveChanges.revisionProperty="_rev";a.filters.load.unshift(function(b){if(typeof b.data.rows=="object"&&b.data.rows instanceof Array&&typeof b.data.total_rows=="number"){b.data.items=[];
for(var c=0,d=b.data.rows.length;c<d;c++)b.data.items.push(b.data.rows[c].doc);delete b.data.rows}else b.data={total_rows:1,items:[b.data]};return b});a.filters.saveChanges.push(function(b){if(b.data&&b.data.items instanceof Array){for(var c=0,d=b.data.items.length;c<d;c++){var g=b.data.items[c];if(b.packedChanges&&b.packedChanges[c]&&b.packedChanges[c].__changeState__===tent.entities.ChangeStates.DELETED)g._deleted=true}b.data.docs=b.data.items;delete b.data.items}else if(b.packedChanges&&b.packedChanges.length===
1)if(b.options.http.type==="DELETE"){if(!b.options.http.headers)b.options.http.headers={};b.packedChanges[0]._deleted=true;b.options.http.headers["If-Match"]=b.packedChanges[0][b.options.saveChanges.revisionProperty];b.options.http.url+="?rev="+b.packedChanges[0][b.options.saveChanges.revisionProperty]}return b});a.filters.saveResult.unshift(function(b){for(var c=0,d=b.data.items.length;c<d;c++){var g=b.data.items[c];delete g.ok;g._id=g.id;delete g.id;g._rev=g.rev;delete g.rev;if(!g.error&&b.packedChanges&&
b.packedChanges[c]&&b.packedChanges[c].__changeState__===tent.entities.ChangeStates.DELETED)g._deleted=true}return b});a.filters.saveResult.unshift(function(b){b.data=typeof b.data=="object"&&b.data instanceof Array?{items:b.data}:{items:[b.data]};return b});return a}});
