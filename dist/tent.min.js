var tent=tent||{};tent.global=typeof window=="undefined"?this:window;
tent.Namespace=function(a,b){if(!b)if(a){b=a;a=tent.global}else throw"must specify namespace path";if(b===".."){if(a===tent.global)throw"cannot use '..' at top level";return a.parent}var c=b.indexOf(".");c<0||b.indexOf(".",c+1);var e=a===tent.global?"":a.fullname+"";if(e)e+=".";e+=b;if(c<0)if(typeof a[b]=="undefined"){this.fullname=e;this.name=b;this.parent=a;a[b]=this}else if(!a[b]instanceof tent.Namespace)throw'error creating namespace: "'+e+'" is not a Namespace object';else return a[b];else return new tent.Namespace(new tent.Namespace(a,
b.slice(0,c)),b.slice(c+1));return this};tent.__tentTmp=new tent.Namespace("__tentTmp");tent.__tentTmp.Namespace=tent.Namespace;tent.__tentTmp.fullname="tent";tent.__tentTmp.name="tent";tent.__tentTmp.parent=tent.global;tent.__tentTmp.global=tent.global;tent.global.tent=tent.__tentTmp;delete tent.__tentTmp;try{delete tent.global.__tentTmp}catch(ex){}
tent.Namespace.prototype.expand=function(a){if(a instanceof Function)a(this);else if(typeof a=="object")for(var b in a)if(a.hasOwnProperty(b)){if(typeof this[b]!="undefined")throw this.fullname+"."+b+" already exists";this[b]=a[b]}return this};
tent.declare=function(){for(var a,b=0;b<arguments.length;b++){var c=arguments[b];if(c instanceof tent.Namespace)a=c;else if(typeof c=="string")a=a?new tent.Namespace(a,c):new tent.Namespace(c);else if(c instanceof Function||typeof c=="object"){if(!a)throw"no namespace provided";a.expand(c)}else throw"invalid argument type at index "+b+", expected Namespace, string, Function";}return a};
tent.mixin=function(a,b){for(var c in b.prototype)if(b.prototype.hasOwnProperty(c))a.prototype[c]=b.prototype[c];return a};tent.isDOMObject=function(a){if(typeof Node!="undefined"&&a instanceof Node||typeof Element!="undefined"&&a instanceof Element||typeof NodeList!="undefined"&&a instanceof NodeList||a===window||a===document)return true;if(typeof o==="object"&&typeof o.nodeType==="number"&&typeof o.nodeName==="string")return true;return false};
tent.DOMPropertyNames=["nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate","dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter",
"id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin","isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove",
"title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue","onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout",
"aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart","aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all",
"onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name","nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate",
"dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter","id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin",
"isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove","title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue",
"onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout","aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart",
"aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all","onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name"];tent.isDOMProperty=function(a){if(!tent.DOMPropertyNames.indexOf)tent.DOMPropertyNames.indexOf=tent.arrays.functions.indexOf;return tent.DOMPropertyNames.indexOf(a)>=0};
tent.domClone=function(a,b){if(a===null)return null;else if(typeof a=="undefined")return;else if(typeof a=="object"){if(b&&b.onlyForTracking&&tent.changes.getPropertyInterceptMode()!=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM)return a;if(b){if(b.deep&&!b.deepStack)b.deepStack=tent.arrays.extend([])}else b={};if(a instanceof Array)for(var c=[],e=0;e<a.length;e++)if(b.deep){b.deepStack.push(a);b.deepStack.lastIndexOf(a[e])<0&&c.push(tent.domClone(a[e],b));b.deepStack.pop()}else c.push(a[e]);
else{c=document.createElement("span");for(var g in a)if(!b.clonePrivates&&g.substr(0,1)=="_")c[g]=a[g];else if(b.deep&&typeof a[g]=="object"){b.deepStack.push(a);if(b.deepStack.indexOf(a[e])<0)c[g]=tent.domClone(a[g],b);b.deepStack.pop()}else c[g]=a[g]}return c}return a};tent.declare("tent.arrays",function(){tent.arrays.extend=function(a,b){for(var c in tent.arrays.functions)if(b||!(a[c]instanceof Function))a[c]=tent.arrays.functions[c];return a};tent.arrays.functions={findByProperty:function(a,b){for(var c=0,e=this.length;c<e;c++)if(this[c][a]===b)return this[c];return null},indexByProperty:function(a,b){for(var c=0,e=this.length;c<e;c++)if(this[c][a]===b)return c;return-1},indexOf:function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1},lastIndexOf:function(a){for(var b=
this.length-1;b>0;b--)if(this[b]===a)return b;return-1},filter:function(a){for(var b=[],c=0,e=this.length;c<e;c++)a(this[c])&&b.push(this[c]);return b},remove:function(){for(var a,b=0,c=this.length;b<c;b++)for(var e=0,g=arguments.length;e<g;e++)if(this[b]==arguments[e]){this.splice(b,1);a=true;b--;c--;break}if(a)return true;return false},set:function(a,b){this.splice(a,1,b)},pushUnique:function(){if(arguments.length==1){for(var a=false,b=0,c=this.length;b<c;b++)if(this[b]==arguments[0]){a=true;break}a||
this.push(arguments[0])}else{a=[];b=0;for(c=this.length;b<c;b++)for(var e=0,g=arguments.length;e<g;e++)if(this[b]==arguments[e])a[e]=true;e=0;for(g=arguments.length;e<g;e++)a[e]||this.push(arguments[e])}return this.length},clone:function(){var a=[];Array.prototype.push.apply(a,this);return a},isCloneOf:function(a){if(!a)return false;if(this.length!=a.length)return false;if(this===a)return false;for(var b=this.length;b>=0;b--)if(this[b]!==a[b])return false;return true}}});tent.declare("tent.coreTypes",function(){tent.coreTypes.Enum=function(){this.__names__=[];this.__values__={};this.__flags__=false;this.__enum=true;arguments.length>0&&this.add.apply(this,arguments)};tent.coreTypes.Enum.prototype.getName=function(c){if(this.__names__)if(this.__names__[c])return this.__names__[c];else if(this.__flags__){c=c;var e="",g;for(g in this.__values__)if(this.__values__[g]&&(this.__values__[g]&c)===this.__values__[g]){c-=this.__values__[g];if(e)e+="|";e+=g}if(e&&c===0)return e;
else if(e)return e+"|"+c}};tent.coreTypes.Enum.prototype.__freeValue__=function(){var c=typeof this.__maxValue__=="undefined"?1:this.__maxValue__+1;if(this.__values__&&typeof this.__values__[c]!="undefined")for(var e in this.__values__)if(this.__values__[e]>=c){this.__maxValue__=this.__values__[e];c=this.__values__[e]+1}if(this.__flags__)c=c<1?1:Math.pow(2,Math.ceil(Math.log(c)/Math.log(2)));return c};tent.coreTypes.Enum.prototype.useFlags=function(c){this.__flags__=c;return this};var a=function(c,
e,g){c[e]=g;c.__values__[e]=g;if(typeof c.__names__[g]=="undefined")c.__names__[g]=e;if(typeof c.__maxValue__=="undefined"||c.__maxValue__<g)c.__maxValue__=g};tent.coreTypes.Enum.prototype.add=function(){if(arguments.length<1)return this;for(var c,e,g=0,j=arguments.length;g<j;g++){c=arguments[g];if(c instanceof Array)this.add.apply(this,c);else if(typeof c=="object")for(e in c)if(c.hasOwnProperty(e)){var d=this.__values__[e];if(!d instanceof Number||typeof this.__names__[d]!="undefined")d=this.__freeValue__();
a(this,e,d)}if(typeof c=="string")if(c){c=c.split(",");d=0;for(var f=c.length;d<f;d++){e=c[d].replace(/^\s+/g,"").replace(/\s+$/g,"");if(e=="_FLAGS")this.useFlags(true);else{if(typeof this.__values__[e]!="undefined")if(this.__values__[e]instanceof Number)throw"Enum duplicate name found: "+e;else throw"Enum invalid name (reserved): "+e;if(d==f-1&&g<j-1&&typeof arguments[g+1]=="number"){a(this,e,arguments[g+1]);g++}else a(this,e,this.__freeValue__())}}}}return this};var b=function(){var c=this._name+
(this._count>1?"("+this._count+")":"");if(this._childrenCount){c+="{";var e=0,g;for(g in this)if(g.substr(0,1)!="_"&&typeof this[g]=="object"){if(e>0)c+=", ";c+=this[g];e++}c+="}"}return c};tent.coreTypes.NameCounter=function(c){this.root={_name:c||"",_count:0,toString:b}};tent.coreTypes.NameCounter.prototype.__nodeAdd__=function(c,e){c._count=(c._count||0)+e;if(c._parent){if(c._count==0&&!c._childrenCount){c._parent._childrenCount&&c._parent._childrenCount--;delete c._parent[c._name]}this.__nodeAdd__(c._parent,
e)}};tent.coreTypes.NameCounter.prototype.add=function(c,e){if(typeof e!="number")e=1;for(var g=c.split("."),j=this.root,d=0;d<g.length;d++){if(typeof j[g[d]]=="undefined"){j._childrenCount=(j._childrenCount||0)+1;j[g[d]]={_parent:j,_name:g[d],_count:0,toString:b}}j=j[g[d]]}this.__nodeAdd__(j,e)};tent.coreTypes.NameCounter.prototype.reset=function(){this.root={_name:this.root._name,_count:0,toString:b}};tent.coreTypes.NameCounter.prototype.toString=function(){return b.apply(this.root)}});tent.declare("tent.logging",function(){tent.logging.Levels=new tent.coreTypes.Enum("TRACE,DEBUG,INFO,WARN,ERROR,FATAL");tent.logging.Log=function(){this.listeners=[]};tent.logging.Log.prototype.bindToConsole=function(a){typeof console!="undefined"&&this.bind(tent.logging.consoleLogger,a);return this};tent.logging.Log.prototype.bindToAlert=function(a){this.bind(tent.logging.alertLogger,a);return this};tent.logging.Log.prototype.bindToHtml=function(a,b){this.bind(tent.logging.createHtmlAppendLogger(a),
b);return this};tent.logging.Log.prototype.unbindConsole=function(){typeof console!="undefined"&&this.unbind(tent.logging.consoleLogger);return this};tent.logging.Log.prototype.unbindAlert=function(){this.unbind(tent.logging.alertLogger,level);return this};tent.logging.Log.prototype.unbindHtml=function(a){for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback.outputElement===a&&this.listeners.splice(b,1);return this};tent.logging.Log.prototype.bind=function(a,b){if(!a instanceof Function)throw"a callback Function must be provided";
var c=b;if(typeof c!="number")c=typeof c=="undefined"?tent.logging.Levels.TRACE:tent.logging.Levels[c]||tent.logging.Levels.TRACE;for(var e=false,g=this.listeners.length-1;g>=0;g--){var j=this.listeners[g];if(j.callback===a){j.level=c;e=true}}e||this.listeners.push({callback:a,level:c});return this};tent.logging.Log.prototype.unbind=function(a){if(!a instanceof Function)throw"a callback Function must be provided";for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback===a&&this.listeners.splice(b,
1);return this};tent.logging.Log.prototype.notify=function(a,b){var c=b;if(typeof c!="number")c=c?tent.logging.Levels[c]||tent.logging.Levels.INFO:tent.logging.Levels.INFO;for(var e=0,g=this.listeners.length;e<g;e++){var j=this.listeners[e];if(j.callback)if(typeof j.level=="undefined"||j.level<=c)j.callback(a,b)}};tent.logging.Log.prototype.trace=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.TRACE)};tent.logging.Log.prototype.debug=function(){this.notify(this.stringOrStringify.apply(this,
arguments),tent.logging.Levels.DEBUG)};tent.logging.Log.prototype.info=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.INFO)};tent.logging.Log.prototype.warn=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.WARN)};tent.logging.Log.prototype.error=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.ERROR)};tent.logging.Log.prototype.fatal=function(){this.notify(this.stringOrStringify.apply(this,
arguments),tent.logging.Levels.FATAL)};tent.logging.Log.prototype.stringify=function(){var a="";try{var b=arguments.length>0&&arguments[arguments.length-1]&&arguments[arguments.length-1]._options?arguments[arguments.length-1]:{_options:true};if(!b.deepStack){b.deepStack=[];tent.arrays.extend(b.deepStack)}for(var c=0,e=arguments.length;c<e;c++)if(!(arguments[c]&&typeof arguments[c]=="object"&&arguments[c]._options))if(!(arguments[c]instanceof Function)){if(a)a+=", ";if(b.deepStack.length>3||b.deepStack.lastIndexOf(arguments[c])>=
0)a+="#";else if(typeof arguments[c]=="undefined")a+="undefined";else if(arguments[c]==null)a+="null";else if(arguments[c]instanceof Array){var g=tent.arrays.functions.clone.apply(arguments[c]).filter(function(h){if(h instanceof Function)return false;if(b.deepStack.lastIndexOf(h>=0))return false;return true});g.push(b);b.deepStack.push(arguments[c]);a+="[";if(b.deepStack.length<4)a+=this.stringify.apply(this,g);b.deepStack.pop();a+="]"}else if(typeof arguments[c]=="string")a+='"'+arguments[c]+'"';
else if(arguments[c]instanceof Date)a+='"'+arguments[c]+'"';else if(typeof arguments[c]=="object"){var j="";b.deepStack.push(arguments[c]);if(b.deepStack.length<4)for(var d in arguments[c])if(!(arguments[c][d]instanceof Function))if(!(b.deepStack.lastIndexOf(arguments[c][d])>=0)){if(j)j+=", ";j+='"'+d+'": '+this.stringify.apply(this,[arguments[c][d],b])}b.deepStack.pop();a+="{"+j+"}"}else a+=arguments[c]}}catch(f){return"#err#"}return a};tent.logging.Log.prototype.stringOrStringify=function(){return arguments.length==
1&&typeof arguments[0]=="string"?arguments[0]:this.stringify.apply(this,arguments)};tent.logging.consoleLogger=function(a,b){if(b==tent.logging.Levels.TRACE)console.trace?console.trace(a):console.info(a);if(b==tent.logging.Levels.DEBUG)console.debug?console.debug(a):console.info(a);b==tent.logging.Levels.INFO&&console.info(a);if(b==tent.logging.Levels.WARN)console.warn?console.warn(a):console.info(a);b==tent.logging.Levels.ERROR&&console.error(a);b==tent.logging.Levels.FATAL&&console.error(a)};tent.logging.alertLogger=
function(a){alert(a)};tent.logging.createHtmlAppendLogger=function(a){var b=null;b=a.tagName=="INPUT"?function(c,e){a.value+="\n["+tent.logging.Levels.getName(e)+"] "+c}:a.tagName=="UL"?function(c,e){var g=document.createElement("li");g.innerHTML="["+tent.logging.Levels.getName(e)+"] "+c;a.appendChild(g)}:a.tagName=="TABLE"?function(c,e){var g=document.createElement("tr"),j=document.createElement("td");j.setAttribute("class","eventType");j.innerHTML=tent.logging.Levels.getName(e);g.appendChild(j);
j=document.createElement("td");j.setAttribute("class","eventMessage");j.innerHTML=c.replace(/(\<)/g,"&lt;").replace(/(\>)/g,"&gt;").replace(/(\&)/g,"&amp;").replace(/(\s)/g,"&nbsp;");g.appendChild(j);a.tBodies[0].appendChild(g)}:function(c,e){a.innerHTML+="<br/>["+tent.logging.Levels.getName(e)+"] "+c};b.outputElement=a;return b};tent.log=(new tent.logging.Log).bindToConsole()});tent.declare("tent.changes",function(){tent.changes.EventTypes=new tent.coreTypes.Enum("ANY,MANYCHANGES,CHANGING,CHANGED,ADDING,ADDED,REMOVING,REMOVED");tent.changes.InterceptorTypes=new tent.coreTypes.Enum("PROPERTY,FUNCTION");tent.changes.PropertyInterceptModes=new tent.coreTypes.Enum("NONE,DEFINESETTER,DEFINEPROPERTY,DEFINEPROPERTYONLYDOM");var a;tent.changes.getPropertyInterceptMode=function(){if(typeof a=="undefined"){var d={};if(Object.defineProperty)try{Object.defineProperty(d,"myproperty",
{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINEPROPERTY}catch(f){if(document&&document.createElement){d=document.createElement("span");try{Object.defineProperty(d,"myproperty",{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM}catch(h){}}}if(typeof a==
"undefined"){d={};if(d.__defineSetter__)try{d.__defineGetter__("myproperty",function(){return this._myproperty});d.__defineSetter__("myproperty",function(k){this._myproperty=k});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINESETTER}catch(i){}}if(typeof a=="undefined")a=tent.changes.PropertyInterceptModes.NONE}return a};tent.changes.getPropertyInterceptModeName=function(){return tent.changes.PropertyInterceptModes.getName(tent.changes.getPropertyInterceptMode())};
tent.changes.Change=function(d,f,h){this.subject=d;this.eventType=f;this.data=h};tent.changes.ChangeStringifiers=[];tent.changes.Change.prototype.toString=function(){if(typeof tent.changes.ChangeStringifiers[this.eventType]!="undefined")tent.changes.ChangeStringifiers[this.eventType](this);else{var d=tent.changes.EventTypes.getName(this.eventType);if(this.eventType==tent.changes.EventTypes.MANYCHANGES){d+=": ";if(this.data.length<=3)for(var f=0,h=this.data.length;f<h;f++)d+=this.data[f].toString()+
",";else{var i={};f=0;for(h=this.data.length;f<h;f++)i[this.data[f].eventType]=(i[this.data[f].eventType]||0)+1;for(var k in i)d+=tent.changes.EventTypes.getName(k)+"("+i[k]+"),"}}else{if(this.data.propertyName){d+=" "+this.data.propertyName;if(this.eventType==tent.changes.EventTypes.CHANGING)d+=" from "+this.data.current+" to "+this.data.newValue;else if(this.eventType==tent.changes.EventTypes.CHANGED)d+=" from "+this.data.oldValue+" to "+this.data.current;d+=" (on "+this.subject+")"}if(this.data.items){f=
this.data.items;d+=" "+f.length+(f.length>1?" items":" item");if(typeof this.data.index!="undefined")d+=" at index "+this.data.index;d+=this.data.propertyName?" ("+this.subject.__parent__+"."+this.data.propertyName+")":" (["+f+"])"}}return"[Change: "+d+"]"}};tent.changes.Observable=function(d){this.subject=d;this.handlers={};this.interceptors={};this.suspended=false;this.changesWhileSuspended=null};tent.changes.Observable.prototype.interceptFunction=function(d,f){if(!this.interceptors[d]){var h="_"+
d,i={name:d,_name:h,type:tent.changes.InterceptorTypes.FUNCTION};this.subject[h]=this.subject[d];this.subject[d]=f;this.interceptors[d]=i}};tent.pset=function(d,f,h,i){if(typeof f=="object"){for(var k in f)f.hasOwnProperty(k)&&tent.pset(d,k,f[k],h);return d}else{if(d.__observable__&&d.__observable__.interceptors&&d.__observable__.interceptors[f])if(i)d[d.__observable__.interceptors[f]._name||f]=h;else d.__observable__.interceptors[f].newsetter.call(d,h);else d[f]=h;return h}};tent.pget=function(d,
f){return d.__observable__&&d.__observable__.interceptors&&d.__observable__.interceptors[f]?d.__observable__.interceptors[f].newgetter.call(d):d[f]};tent.changes.Observable.prototype.interceptProperty=function(d,f,h,i){if(this.interceptors[d])return this.interceptors[d];var k={name:d,type:tent.changes.InterceptorTypes.PROPERTY,newsetter:i,newgetter:h};if(f){f="_"+d;try{this.subject[f]=this.subject[d]}catch(l){this.subject[f]=null}k._name=f}f=tent.changes.getPropertyInterceptMode();if(f==tent.changes.PropertyInterceptModes.DEFINEPROPERTY||
f==tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject)){try{k.descriptor=Object.getOwnPropertyDescriptor(this.subject,d)}catch(m){}f={};if(h)f.get=h;if(i)f.set=i;try{Object.defineProperty(this.subject,d,f)}catch(n){tent.log.warn("Object.defineProperty for property '"+d+"' failed: "+n)}}else if(f==tent.changes.PropertyInterceptModes.DEFINESETTER){try{k.getter=this.subject.__lookupGetter__(d);k.setter=this.subject.__lookupSetter__(d)}catch(p){}if(h)try{this.subject.__defineGetter__(d,
h)}catch(q){tent.log.warn("Object.__defineGetter__ for property '"+d+"' failed: "+q)}if(i)try{this.subject.__defineSetter__(d,i)}catch(r){tent.log.warn("Object.__defineSetter__ for property '"+d+"' failed: "+r)}}if(k)this.interceptors[d]=k;return k};var b=function(d,f){return function(h){var i=this[f];if(i!=h){this.__observable__.notifyChange(tent.changes.EventTypes.CHANGING,{propertyName:d,current:i,newValue:h});this[f]=h;this.__observable__.notifyChange(tent.changes.EventTypes.CHANGED,{propertyName:d,
current:h,oldValue:i})}}},c=function(d,f){return function(){return this[f]}},e=function(d,f){return f.substr(0,1)!="_"};tent.changes.Observable.prototype.interceptProperties=function(d){d||(d={});var f=d.propertyFilter||e,h=d.backPropertyPrefix||"_";!d.trackDomProperties&&this.isDOMObject();for(var i in this.subject)if(!tent.isDOMProperty(i))try{if(typeof this.subject[i]!="function"&&f(this.subject,i)){d=h+i;this.interceptProperty(i,d,c(i,d),b(i,d))}}catch(k){tent.log.warn("Error intercepting property '"+
i+"': "+k)}return this};tent.changes.Observable.prototype.isDOMObject=function(){if(typeof this._isDomObject=="undefined")this._isDOMObject=tent.isDOMObject(this.subject);return this._isDOMObject};tent.changes.Observable.prototype.interceptArrayModifiers=function(){if(!this.subject instanceof Array)return this;var d=this.subject;this.subject.setLength=function(f){if(this.length>f)this.splice(f,this.length-f);else this.lengh=f};this.interceptFunction("push",function(){var f=this.length,h=h=Array.prototype.slice.call(arguments);
this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,{items:h,index:f,propertyName:this.__propertyName__});this._push.apply(this,arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:h,index:f,propertyName:this.__propertyName__})});this.interceptFunction("unshift",function(){var f=f=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,{items:f,index:0,propertyName:this.__propertyName__});this._unshift.apply(this,
arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:f,index:0,propertyName:this.__propertyName__})});this.interceptFunction("pop",function(){var f=this.length-1;this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:[this[f]],index:f,propertyName:this.__propertyName__});var h=this._pop();this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:[h],index:f,propertyName:this.__propertyName__});return h});this.interceptFunction("shift",function(){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,
{items:[this[0]],index:0,propertyName:this.__propertyName__});var f=this._shift();this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:[f],index:0,propertyName:this.__propertyName__});return f});this.interceptFunction("splice",function(f,h){var i;h&&h>0&&this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:this.slice(f,f+h),index:f,propertyName:this.__propertyName__});if(arguments.length>2){i=Array.prototype.slice.call(arguments,2);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,
{items:i,index:f,propertyName:this.__propertyName__})}if(i&&i.length>0){var k=i.slice(0);k.unshift(f,h);k=this._splice.apply(this,k)}else k=this._splice(f,h);k&&k.length>0&&this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:k,index:f,propertyName:this.__propertyName__});arguments.length>2&&this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:i,index:f,propertyName:this.__propertyName__});return k});d.remove=tent.arrays.functions.remove;d.set=tent.arrays.functions.set;
if(!d.indexOf)d.indexOf=tent.arrays.functions.indexOf;if(!d.lastIndexOf)d.lastIndexOf=tent.arrays.functions.lastIndexOf;return this};tent.changes.Observable.prototype.removeInterceptor=function(d){var f=this.interceptors[d];if(f._name){if(f.type!=tent.changes.InterceptorTypes.FUNCTION){try{delete this.subject[f.name]}catch(h){tent.log.warn("Error deleting property interceptor '"+f.name+"': "+h)}var i=tent.changes.getPropertyInterceptMode();if(i==tent.changes.PropertyInterceptModes.DEFINEPROPERTY||
i==tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject))f.descriptor&&f.descriptor.name&&Object.defineProperty(this.subject,d,f.descriptor);else if(i==tent.changes.PropertyInterceptModes.DEFINESETTER){f.getter&&this.subject.__defineGetter__(d,f.getter);f.setter&&this.subject.__defineSetter__(d,f.setter)}}try{this.subject[f.name]=this.subject[f._name]}catch(k){(i=tent.isDOMObject(this.subject))||tent.log.warn("Error restoring property '"+f.name+"' value: "+k)}try{delete this.subject[f._name]}catch(l){tent.log.warn("Error deleting back storage property '"+
f._name+"': "+l)}}else if(f.type!=tent.changes.InterceptorTypes.FUNCTION){i=this.subject[f.name];delete this.subject[f.name];this.subject[f.name]=i}delete f[d]};tent.changes.Observable.prototype.removeInterceptors=function(){for(var d in this.interceptors)try{this.removeInterceptor(d)}catch(f){tent.log.warn("Error removing interceptor from property '"+d+"': "+f)}this.interceptors={}};tent.changes.Observable.prototype.suspend=function(){this.suspended=true};tent.changes.Observable.prototype.resume=
function(){this.suspended=false;if(this.changesWhileSuspended){if(this.changesWhileSuspended.length<5)for(var d=0,f=this.changesWhileSuspended.length;d<f;d++)this.notifyChange(this.changesWhileSuspended[d]);else this.changesWhileSuspended.length>1&&this.notifyChange(tent.changes.EventTypes.MANYCHANGES,this.changesWhileSuspended);delete this.changesWhileSuspended}};tent.changes.Observable.prototype.isValidHandler=function(d){if(!d)return false;if(typeof d=="function"||typeof d=="object"&&typeof d.handle==
"function")return true;return false};tent.changes.Observable.prototype.bind=function(d,f){if(!f)if(this.isValidHandler(d)){f=d;d=tent.changes.EventTypes.ANY}else throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!this.isValidHandler(f))throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!d)d=tent.changes.EventTypes.ANY;var h=this.handlers[d];h||(h=this.handlers[d]=[]);for(var i=0;i<h.length;i++)if(h[i]==f)return false;
this.handlers[d].push(f);return true};tent.changes.Observable.prototype.unbind=function(d,f){if(!f)if(this.isValidHandler(d)){f=d;d=tent.changes.EventTypes.ANY}else throw"must specify a handler to remove";if(!this.isValidHandler(f))throw"must specify a handler to remove";if(!d)d=tent.changes.EventTypes.ANY;var h=this.handlers[d],i=false;if(h)for(var k=0,l=h.length;k<l;k++)if(h[k]==f){h.splice(k,1);k--;l--;i=true}return i};tent.changes.Observable.prototype.unbindWhere=function(d){var f=false,h;for(h in this.handlers)for(var i=
this.handlers[h],k=0,l=i.length;k<l;k++)if(d(i[k])){i.splice(k,1);k--;l--;f=true}return f};tent.changes.Observable.prototype.notifyHandler=function(d,f){try{return typeof f=="function"?f.call(this.subject,d):f.handle(d)}catch(h){var i="";if(h.stack)i+=h.stack;else if(h.message)i+=h.message;tent.log.error("Change Handler Error: "+h+(i?"\n"+i:""));return h}};tent.changes.Observable.prototype.notifyChange=function(d,f){if(this.suspended){if(!this.changesWhileSuspended){this.changesWhileSuspended=[];
if(!this.changesWhileSuspended.filter)this.changesWhileSuspended.filter=tent.arrays.functions.filter;this.changesWhileSuspended.findByEventType=function(){for(var m=0,n=this.length;m<n;m++)for(var p=0,q=arguments.length;p<q;p++)if(this[m].eventType==arguments[p])return this[m]};this.changesWhileSuspended.findPropertyChanged=function(m,n){for(var p=0,q=this.length;p<q;p++)if(this[p].subject==m&&this[p].eventType==tent.changes.EventTypes.CHANGED&&this[p].data.propertyName==n)return this[p]};this.changesWhileSuspended.findArrayChanged=
function(){for(var m=0,n=this.length;m<n;m++)if(this[m].subject==subject&&(this[m].eventType==tent.changes.EventTypes.ADDED||this[m].eventType==tent.changes.EventTypes.REMOVED))return this[m]}}this.changesWhileSuspended.push(new tent.changes.Change(this.subject,d,f))}else{var h;h=d instanceof tent.changes.Change?d:new tent.changes.Change(this.subject,d,f);var i=this.handlers[d];if(i)for(var k=0,l=i.length;k<l;k++)this.notifyHandler(h,i[k]);if(i=this.handlers[tent.changes.EventTypes.ANY]){k=0;for(l=
i.length;k<l;k++)this.notifyHandler(h,i[k])}}};var g;tent.changes.Observable.prototype.log=function(d){if(typeof d=="undefined")d=true;if(d){g||(g=new tent.changes.LogHandler);return this.bind(g)}else if(g)return this.unbind(g);return false};tent.changes.LogHandler=function(d){if(typeof d=="undefined")d="";else if(d&&d[d.length-1]!=" ")d+=" ";this.prefix=d};tent.changes.LogHandler.prototype.handle=function(d){tent.log.info(this.prefix+d.toString())};var j=function(d){var f={};for(opName in d)if(opName!=
"deepStack"&&opName!="liveHandler")f[opName]=d[opName];d=function(h){if(h.eventType==tent.changes.EventTypes.CHANGED){if(typeof h.data.current=="object")if(f.deepOverDOM||!tent.isDOMObject(h.data.current)){f.deepStack=[h.data.subject];tent.changes.track(h.data.current,f);delete f.deepStack}}else if(h.eventType==tent.changes.EventTypes.ADDED)for(var i=0,k=h.data.items.length;i<k;i++)if(typeof h.data.items[i]=="object")if(f.deepOverDOM||!tent.isDOMObject(h.data.current)){f.deepStack=[h.data.subject];
tent.changes.track(h.data.items[i],f);delete f.deepStack}};d.isLivePropagator=true;return d};tent.changes.track=function(d,f){f||(f={});if(typeof d!="object"){if(!f.deepStack)throw"Cannot track changes of "+typeof d;return false}else if(d==null){if(!f.deepStack)throw"Cannot track changes of null";return false}var h=d instanceof Array,i=false;if(!f.remove&&!f.removeAll&&!d.__observable__){if(f.observable&&(!f.observable.subject||f.observable.subject==d)){d.__observable__=f.observable;d.__observable__.subject=
d}else d.__observable__=new tent.changes.Observable(d);i=true;if(!f.interceptOptions)f.interceptOptions={};h?d.__observable__.interceptArrayModifiers(f.interceptOptions):d.__observable__.interceptProperties(f.interceptOptions)}if(f.bindings)for(var k=0,l=f.bindings.length;k<l;k++){var m=f.bindings[k];if(h&&m.bindArrays!=false||!h&&m.bindObjects!=false)if(f.remove){if(d.__observable__&&d.__observable__.unbind(m.eventType,m.handler))i=true}else if(d.__observable__.bind(m.eventType,m.handler))i=true}if(f.log)if(d.__observable__&&
d.__observable__.log(!f.remove))i=true;if(f.reverseProperties)if(f.remove){if(d.__observable__&&d.__observable__.unbind(tent.changes.reverseProperties.getHandler()))i=true}else if(d.__observable__.bind(tent.changes.reverseProperties.getHandler()))i=true;if(f.removeAll&&d.__observable__){d.__observable__.removeInterceptors();delete d.__observable__.subject;delete d.__observable__;i=true}if(f.deep&&f.live&&!f.remove)if(f.remove){if(d.__observable__.unbindWhere(function(p){return p.isLivePropagator}))i=
true}else{if(!f.liveHandler)f.liveHandler=j(f);if(d.__observable__.bind(f.liveHandler))i=true}if(f.deep){if(f.deepStack)f.deepStack.push(d);else{f.deepStack=[d];if(!f.deepStack.lastIndexOf)f.deepStack.lastIndexOf=tent.arrays.functions.lastIndexOf}if(h){k=0;for(l=d.length;k<l;k++)if((h=d[k])&&typeof h=="object"&&f.deepStack.lastIndexOf(h)<0)if(tent.changes.track(h,f))i=true}else{k=f.propertyFilter||e;for(var n in d)if(typeof d[n]!="function"&&k(d,n)){h=d[n];if(f.deepOverDOM||!tent.isDOMObject(subject))if(typeof h==
"object"&&f.deepStack.lastIndexOf(h)<0)if(tent.changes.track(h,f))i=true}}f.deepStack.pop()}return i};tent.changes.untrack=function(d,f){if(f){if(!f.removeAll)f.removeAll=true}else f={removeAll:true};return tent.changes.track(d,f)};tent.changes.isTracked=function(d){return d.__observable__&&d.__observable__ instanceof tent.changes.Observable};tent.changes.bind=function(d,f){var h;if(typeof f=="string"){h=f;f={bindings:[]}}else if(typeof f=="function")f={bindings:[{handler:f}]};else if(typeof f=="object"&&
typeof f.handle=="function")f={bindings:[{handler:f}]};if(arguments.length>2){if(f){if(!f.bindings)f.bindings=[]}else f={bindings:[]};for(var i=2;i<arguments.length;i++)f.bindings.push({eventType:h,handler:arguments[i]})}return tent.changes.track(d,f)};tent.changes.unbind=function(d,f){var h;if(typeof f=="string"){h=f;f={bindings:[]}}else if(typeof f=="function")f={bindings:[{handler:f}]};else if(typeof f=="object"&&typeof f.handle=="function")f={bindings:[{handler:f}]};if(arguments.length>2){if(f){if(!f.bindings)f.bindings=
[]}else f={bindings:[]};for(var i=2;i<arguments.length;i++)f.bindings.push({eventType:h,handler:arguments[i]})}if(f){if(!f.remove)f.remove=true}else f={remove:true};return tent.changes.track(d,f)}});tent.declare("tent.databinding",function(){var a=function(c,e,g,j,d){var f={};f.handle=function(h){var i=false;if(h.eventType==tent.changes.EventTypes.ADDED||h.eventType==tent.changes.EventTypes.REMOVED||h.eventType==tent.changes.EventTypes.CHANGED)if(d.deep)i=true;else{var k=c;if(h.subject==c)i=true;else for(var l=e.split("."),m=0;m<l.length;m++){var n=l[m];k=k[n];if(k==h.subject){i=true;break}}}else if(h.eventType==tent.changes.EventTypes.MANYCHANGES)i=true;if(i){h=c;k=null;if(e){l=e.split(".");
for(m=0;m<l.length;m++){n=l[m];k=h;h=h[n];if(h==null||typeof h=="undefined")break;else tent.changes.bind(h,{live:d.live,log:d.log,deepStack:[k],bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:this}]})}}l=g;if(n=j){k=j.split(".");for(m=0;m<k.length;m++){n=k[m];tgtParent=l;l=l[n];if(l==null||typeof l=="undefined"){if(m<k.length-1)i=false;break}}l=tgtParent}if(i)if(d.template)tent.databinding.parseTemplate(d.template,h,l,n);else{if(typeof d.format=="function")h=d.format(h);if(l[n]!=h)l[n]=
h}}};return f};tent.databinding.bind=function(c,e,g,j,d){d||(d={});var f=a(c,e,g,j,d);if(d.deep){if(d.bidirectional)throw"cannot use bidirectional databinding when using a deep tracking";tent.changes.bind(c,{deep:true,live:d.live,log:d.log,bindings:[{handler:f}]})}else{if(d.bidirectional){if(d.template)throw"cannot use bidirectional databinding when using a template";var h=a(g,j,c,e,d);tent.changes.bind(g,{live:d.live,log:d.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:h}]})}tent.changes.bind(c,
{live:d.live,log:d.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:f}]})}c=!e?c:c[e];if(d.template)tent.databinding.parseTemplate(d.template,c,g,j);else if(g[j]!=c)g[j]=c};var b={};tent.databinding.parseTemplate=function(c,e,g,j){var d;try{var f=b[c];if(!f){var h="var p=[],print=function (){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").replace(/'(?=[^#]*#>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<#=(.+?)#>/g,"',$1,'").split("<#").join("');").split("#>").join("p.push('")+
"');}return p.join('');";f=new Function("obj",h);b[c]=f}d=f(e)}catch(i){d="< # ERROR: "+i.message+" # >"}if(g)if(j)g[j]=d;else g.innerHTML=d;return d}});tent.declare("tent.changes.reverseProperties",function(){tent.changes.reverseProperties.setReverseProperty=function(b,c,e){e||(e={});e.cardinality=e.cardinality?e.cardinality.toLowerCase():"11";if(!e.reverse)e.reverse=c+"Of";var g={name:e.reverse,cardinality:e.cardinality};if(e.cardinality.substr(0,1)==="n"||e.cardinality.substr(0,1)==="m")g.isArray=true;if(!b.__reverseProperties__)b.__reverseProperties__={};if(e.cardinality.substr(1,1)==="n"||e.cardinality.substr(1,1)==="m"){if(typeof b[c]=="undefined"||
!(b[c]instanceof Array))b[c]=[];b.__reverseProperties__[c]=g;b[c].__parent__=b;b[c].__reverseProperty__=g}else{if(typeof b[c]=="undefined")b[c]=null;b.__reverseProperties__[c]=g}};tent.changes.reverseProperties.setReverseProperties=function(b,c){if(c)for(var e in c)c[e].reverse&&tent.changes.reverseProperties.setReverseProperty(b,e,c[e])};tent.changes.reverseProperties.Set=function(b){this.properties=b};tent.changes.reverseProperties.Set.prototype.create=function(){var b={};this.applyTo(b);return b};
tent.changes.reverseProperties.Set.prototype.applyTo=function(){var b=[];b.bind=function(e){e||(e={});e.reverseProperties=true;for(var g=0;g<this.length;g++){var j=this[g];if(j.__reverseProperties__){tent.changes.bind(j,e);var d=j.__reverseProperties__,f;for(f in d)if(d.hasOwnProperty(f))if(d[f].cardinality&&(d[f].cardinality[1]=="n"||d[f].cardinality[1]=="m")){if(!(j[f]instanceof Array)){j[f]=[];j[f].__parent__=j;j[f].__reverseProperty__=j.__reverseProperties__[f]}tent.changes.bind(j[f],e)}}}};if(this.properties){for(var c=
0;c<arguments.length;c++)tent.changes.reverseProperties.setReverseProperties(arguments[c],this.properties);b.push.apply(b,arguments)}return b};var a;tent.changes.reverseProperties.getHandler=function(){a||(a=function(b){if(b.eventType==tent.changes.EventTypes.ADDED){var c=b.data.items;if(c&&b.subject&&b.subject.__reverseProperty__){var e=b.subject.__reverseProperty__;b=b.subject.__parent__;for(var g=0,j=c.length;g<j;g++){var d=c[g];if(e.isArray){d[e.name]||(d[e.name]=[]);d[e.name].indexOf(b)<0&&d[e.name].push(b)}else if(d[e.name]!=
b){if(typeof d[e.name]!="undefined"&&d[e.name]!=null)throw Error("this."+e.name+" is set. Remove this from its current array before adding it to this array");d[e.name]=b}}}}else if(b.eventType==tent.changes.EventTypes.REMOVED){if((c=b.data.items)&&b.subject&&b.subject.__reverseProperty__){e=b.subject.__reverseProperty__;b=b.subject.__parent__;g=0;for(j=c.length;g<j;g++){d=c[g];if(e.isArray){if(d=d[e.name])for(var f=0,h=d.length;f<h;f++)if(d[f]===b){d.splice(f,1);f--;h--}}else if(d[e.name]===b)d[e.name]=
null}}}else if(b.eventType==tent.changes.EventTypes.CHANGED)if(b.data.propertyName&&b.subject&&b.subject.__reverseProperties__)if(e=b.subject.__reverseProperties__[b.data.propertyName])if(e.isArray){if(d=b.data.oldValue){d=d[e.name];if(d instanceof Array){g=0;for(j=d.length;g<j;g++)if(d[g]===b.subject){d.splice(g,1);g--;j--}}}if(d=b.data.current){d[e.name]||(d[e.name]=[]);d[e.name]instanceof Array&&d[e.name].indexOf(b.subject)<0&&d[e.name].push(b.subject)}}else{if(d=b.data.oldValue)if(d[e.name]==
b.subject)d[e.name]=null;if(d=b.data.current)if(d[e.name]!=b.subject)d[e.name]=b.subject}});return a}});tent.declare("tent.entities",function(){tent.entities.ChangeStates=new tent.coreTypes.Enum("DETACHED,UNCHANGED,ADDED,MODIFIED,DELETED");tent.entities.Type=function(a,b){this.name=a;this.properties=b;if(b instanceof tent.changes.reverseProperties.Set)this.reversePropertySet=b;else if(typeof b=="object")this.reversePropertySet=new tent.changes.reverseProperties.Set(b);else throw"cannot create a Type without properties";};tent.entities.Type.prototype.toString=function(){return"EntityType("+this.name+
")"};tent.entities.Type.prototype.applyTo=function(){this.reversePropertySet.applyTo.apply(this.reversePropertySet,arguments);for(var a=0;a<arguments.length;a++){if(arguments[a].__entityType__!=this)arguments[a].__entityType__=this;for(var b in this.properties){var c=this.properties[b];if(typeof arguments[a][b]=="undefined")arguments[a][b]=!c.cardinality||c.cardinality.substr(1,1)==="1"?null:[]}}};tent.entities.Collection=function(a,b,c){this.context=a;this.type=b;this.name=c||b.name;this.items=[];
tent.arrays.extend(this.items)};tent.entities.Collection.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)this.push.apply(this,arguments[a]);else if(arguments[a].__collection__){if(arguments[a].__collection__!=this)throw"cannot add this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';
}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;this.items.push(arguments[a]);this.context.changeHandler&&this.context.changeHandler.itemAdded(arguments[a]);this.type&&this.context.__cascadePush__(arguments[a])}}return this.items.length};tent.entities.Collection.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays to a Collection";else if(arguments[a].__collection__){if(arguments[a].__collection__!=
this)throw"cannot attach this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;arguments[a].__changeState__!=tent.entities.ChangeStates.DELETED&&this.items.push(arguments[a]);this.context.changeHandler&&
this.context.changeHandler.itemAttached(arguments[a]);this.type&&this.context.__cascadeAttach__(arguments[a])}}return this.items.length};tent.entities.Collection.prototype.remove=function(){for(var a=false,b=0,c=arguments.length;b<c;b++){var e=arguments[b];if(this.items.remove(e)){a=true;this.context.changeHandler&&this.context.changeHandler.itemRemoved(arguments[b]);this.type&&this.context.__cascadeRemove__(e)}}return a};tent.entities.Collection.prototype.detach=function(){for(var a=false,b=0,c=
arguments.length;b<c;b++){var e=arguments[b];if(this.items.remove(e)||e.__changeState__==tent.entities.ChangeStates.DELETED){a=true;this.context.changeHandler&&this.context.changeHandler.itemDetached(e);delete e.__collection__;e.__entityType__&&this.context.__cascadeDetach__(e)}}return a};tent.entities.Collection.prototype.detachAll=function(){if(this.items.length<1)return false;for(var a=this.items.pop();typeof a!="undefined";){this.context.changeHandler&&this.context.changeHandler.itemDetached(a);
delete a.__collection__;a.__entityType__&&this.context.__cascadeDetach__(a);a=this.items.pop()}this.items.length=0;return true};tent.entities.Context=function(a){this.__collections__={};this.__types__={};a===true&&this.trackChanges();this.changes=null};tent.entities.MyContext=new tent.entities.Context;tent.entities.Context.prototype.all=function(){var a=[],b;for(b in this.__collections__)a.push.apply(a,this.__collections__[b].items);return a};tent.entities.Context.prototype.filter=function(a){var b=
[],c;for(c in this.__collections__)b.push.apply(b,this.__collections__[c].items.filter(a));return b};tent.entities.Context.prototype.contains=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b)if(b.__collection__){if(this.__collections__[b.__collection__.name]!=b.__collection__)return false}else if(b instanceof tent.entities.Type){if(this.__types__[b.name]!=b)return false}else if(b instanceof tent.entities.Collection){if(this!=b.context)return false}else return false;else return false}return true};
tent.entities.Context.prototype.createCollection=function(a,b){if(b){if(a&&!a instanceof tent.entities.Type)throw"provided type is not a Type instance";}else if(a)if(a instanceof tent.entities.Type)b=a.name;else if(typeof a=="string"){b=a;a=null}else throw"provide a Type or name to create a Collection";else b="_Object";if(!this.__collections__[b]){this.__collections__[b]=new tent.entities.Collection(this,a,b);for(var c=b;this[c];)c+="_";this[c]=this.__collections__[b]}return this.__collections__[b]};
tent.entities.Context.prototype.pushModel=function(a){if(a)if(a.types)for(var b in a.types)this.push(new tent.entities.Type(b,a.types[b]))};tent.entities.Context.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot push arrays into a Context";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot push this item, it belongs to another Context";}else if(arguments[a]instanceof tent.entities.Type){if(!arguments[a].name)throw"cannot add an EntityType without name";
if(this.__types__[arguments[a].name])if(this.__types__[arguments[a].name]==arguments[a])continue;else throw'EntityType "'+arguments[a].name+'" already exists';this.__types__[arguments[a].name]=arguments[a];this.createCollection(arguments[a])}else if(arguments[a]instanceof tent.entities.Context)throw"cannot add an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+
b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.createCollection(b).push(arguments[a])}};tent.entities.Context.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot attach this item, it belongs to another Context";}else if(arguments[a]instanceof tent.entities.Type)throw"cannot attach EntityTypes";else if(arguments[a]instanceof
tent.entities.Context)throw"cannot attach an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.createCollection(b).attach(arguments[a])}};tent.entities.Context.prototype.remove=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof tent.entities.Type)throw"cannot remove EntityTypes";
else if(arguments[a]instanceof tent.entities.Context)throw"cannot remove an EntityContext from an EntityContext";else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.remove(arguments[a])};tent.entities.Context.prototype.detach=function(){for(var a=0;a<arguments.length;a++){if(arguments[a]instanceof Array)throw"cannot detach arrays";if(arguments[a]instanceof tent.entities.Type)throw"cannot detach EntityTypes";else if(arguments[a]instanceof tent.entities.Context)throw"cannot detach an EntityContext from an EntityContext";
else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.detach(arguments[a])}};tent.entities.Context.prototype.detachAll=function(){for(var a=false,b=0;b<this.__collections__.length;b++)if(this.__collections__[b].detachAll())a=true;return a};tent.entities.Context.prototype.touch=function(){if(this.changeHandler)return this.changeHandler.touch.apply(this.changeHandler,arguments)};tent.entities.Context.prototype.__cascadePush__=function(){for(var a=0;a<arguments.length;a++){var b=
arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var e=b.__entityType__.properties[c];if(e.cascadePush){var g=null;if(e.collection)g=this.__collections__[e.collection]||this.createCollection(e.collection);if(b[c]instanceof Array){if(e.cardinality&&e.cardinality[1]!="1")g?g.push.apply(g,b[c]):this.push.apply(this,b[c])}else g?g.push(b[c]):this.push(b[c])}}}};tent.entities.Context.prototype.__cascadeAttach__=function(){for(var a=0;a<arguments.length;a++){var b=
arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var e=b.__entityType__.properties[c];if(e.cascadeAttach){var g=null;if(e.collection)g=this.__collections__[e.collection]||this.createCollection(e.collection);if(b[c]instanceof Array){if(e.cardinality&&e.cardinality[1]!="1")g?g.attach.apply(g,b[c]):this.attach.apply(this,b[c])}else g?g.attach(b[c]):this.attach(b[c])}}}};tent.entities.Context.prototype.__cascadeRemove__=function(){for(var a=
0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var e=b.__entityType__.properties[c];if(e.cascadeRemove)if(b[c]instanceof Array)e.cardinality&&e.cardinality[1]!="1"&&this.remove.apply(this,b[c]);else this.remove(b[c])}}};tent.entities.Context.prototype.__cascadeDetach__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==
null&&typeof b[c]=="object"){var e=b.__entityType__.properties[c];if(e.cascadeDetach)if(b[c]instanceof Array)e.cardinality&&e.cardinality[1]!="1"&&this.detach.apply(this,b[c]);else this.detach(b[c])}}};tent.entities.Context.prototype.trackChanges=function(){if(!this.changeHandler){this.changeHandler=new tent.entities.ContextChangeHandler(this);this.changeHandler.init()}};tent.entities.Context.prototype.hasChanges=function(){return!!(this.changes&&this.changes.items.length>0)};tent.entities.Context.prototype.acceptAllChanges=
function(){this.changeHandler&&this.changeHandler.acceptAllChanges()};tent.entities.Context.prototype.acceptChanges=function(){this.changeHandler&&this.changeHandler.acceptChanges.apply(this.changeHandler,arguments)};tent.entities.EntityLink=function(a,b,c,e){this.from=a;this.to=b;this.propertyName=c;this.__changeState__=e||tent.entities.ChangeStates.DETACHED};tent.entities.ContextChanges=function(a){this.context=a;this.items=[];tent.arrays.extend(this.items)};tent.entities.ContextChanges.prototype.toString=
function(){for(var a=new tent.coreTypes.NameCounter,b=0,c=this.items.length;b<c;b++)a.add(tent.entities.ChangeStates.getName(this.items[b].__changeState__)+"."+this.items[b].__collection__.name);return a.toString()};tent.entities.ContextChangeHandler=function(a){this.context=a};tent.entities.ContextChangeHandler.prototype.isDetached=function(a){return!a.__changeState__||a.__changeState__==tent.entities.ChangeStates.DETACHED};tent.entities.ContextChangeHandler.prototype.bindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var c=
a.__entityType__.properties[b];if(c.cardinality&&c.cardinality.substr(1,1)!="1"&&a[b]instanceof Array){a[b].__parent__=a;a[b].__propertyName__=b;tent.changes.bind(a[b],this)}}};tent.entities.ContextChangeHandler.prototype.unbindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var c=a.__entityType__.properties[b];c.cardinality&&c.cardinality.substr(1,1)!="1"&&a[b]instanceof Array&&tent.changes.unbind(a[b],this)}};tent.entities.ContextChangeHandler.prototype.setAdded=
function(a){if(a.__changeState__!=tent.entities.ChangeStates.ADDED)if(a.__collection__)if(a.__collection__.context==this.context){a.__changeState__=tent.entities.ChangeStates.ADDED;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else throw"cannot set this item as ADDED, it belongs to another Context";else a.__changeState__=tent.entities.ChangeStates.ADDED};tent.entities.ContextChangeHandler.prototype.setRemoved=
function(a){if(!(this.isDetached(a)||a.__changeState__==tent.entities.ChangeStates.DELETED))if(a.__collection__)if(a.__collection__.context==this.context)if(a.__changeState__==tent.entities.ChangeStates.UNCHANGED||a.__changeState__==tent.entities.ChangeStates.MODIFIED){a.__changeState__=tent.entities.ChangeStates.DELETED;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else{if(a.__changeState__==tent.entities.ChangeStates.ADDED){a.__changeState__=
tent.entities.ChangeStates.DETACHED;delete a.__collection__;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.remove(a)}}else throw"cannot set this item as DELETED, it belongs to another Context";else a.__changeState__=tent.entities.ChangeStates.DELETED};tent.entities.ContextChangeHandler.prototype.touch=function(){for(var a=0,b=arguments.length;a<b;a++)if(arguments[a]&&arguments[a].__changeState__==tent.entities.ChangeStates.UNCHANGED&&
arguments[a].__collection__&&arguments[a].__collection__.context==this.context){if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this);arguments[a].__changeState__=tent.entities.ChangeStates.MODIFIED;this.context.changes.items.pushUnique(arguments[a])}};tent.entities.ContextChangeHandler.prototype.itemAdded=function(a){if(this.isDetached(a))this.setAdded(a);else if(a.__changeState__!=tent.entities.ChangeStates.UNCHANGED){if(!this.context.changes)this.context.changes=
new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}if(a.__changeState__!=tent.entities.ChangeStates.DELETED){tent.changes.bind(a,this);this.bindArrayProperties(a)}};tent.entities.ContextChangeHandler.prototype.itemAttached=function(a){if(this.isDetached(a))a.__changeState__=tent.entities.ChangeStates.UNCHANGED;this.itemAdded(a)};tent.entities.ContextChangeHandler.prototype.itemRemoved=function(a){this.setRemoved(a);tent.changes.unbind(a,this);this.unbindArrayProperties(a)};
tent.entities.ContextChangeHandler.prototype.itemDetached=function(a){var b=this.context.changes;a.__changeState__!=tent.entities.ChangeStates.UNCHANGED&&b&&b.items.remove(a);delete a.__changeState__;tent.changes.unbind(a,this);this.unbindArrayProperties(a)};tent.entities.ContextChangeHandler.prototype.objectLinked=function(a,b,c,e){if(typeof e=="object")if(e instanceof Array){if(e.__parent__!=a){if(e.__parent__)throw"this array already has another parent object";e.__parent__=a}if(e.__propertyName__!=
b)e.__propertyName__=b;tent.changes.bind(e,this);c.onLinkPush&&this.context.attach.push(this.context,e)}else if(e!==null&&typeof e!="undefined"){if(e.__changeState__==tent.entities.ChangeStates.DELETED)throw'cannot link a DELETED object to property "'+c+'"';if(e.__collection__){if(e.__collection__.context!=this.context)throw"cannot link this object, it belongs to another Context";if(c.collection&&e.__collection__.name!=c.collection)throw"cannot link an object of collection "+c.collection+' to property "'+
c+'"';}if(!e.__collection__&&c.onLinkPush){e.__entityType__&&this.context.push(e.__entityType__);if(c.collection){if(!this.context.__collections__[c.collection])throw Error('Collection "'+c.collection+'" not found in this Context');this.context.__collections__[c.collection].push(e)}else this.context.push(e)}if(c.trackLinks){c=null;for(var g=this.context.changes.items.length-1;g>=0;g--){var j=this.context.changes.items[g];if(j instanceof tent.entities.EntityLink&&j.from===a&&j.to===e&&j.propertyName==
b){c=j;break}}if(c){if(c.__changeState__==tent.entities.ChangeStates.DELETED)c.__changeState__=tent.entities.ChangeStates.UNCHANGED}else{c=new tent.entities.EntityLink(a,e,b,tent.entities.ChangeStates.ADDED);this.context.changes.items.push(c)}}}};tent.entities.ContextChangeHandler.prototype.objectUnlinked=function(a,b,c,e){if(typeof e=="object")if(e instanceof Array){delete e.__parent__;delete e.__propertyName__;tent.changes.unbind(e,this);c.onUnlinkRemove&&this.context.remove.apply(this.context,
e)}else if(e!==null&&typeof e!="undefined"){c.onUnlinkRemove&&e.__collection__&&e.__collection__.remove(e);if(c.trackLinks){c=null;for(var g=-1,j=this.context.changes.items.length-1;j>=0;j--){var d=this.context.changes.items[j];if(d instanceof tent.entities.EntityLink&&d.from===a&&d.to===e&&d.propertyName==b){c=d;g=j;break}}if(c)if(c.__changeState__==tent.entities.ChangeStates.ADDED)this.context.changes.items.splice(g,1);else{if(c.__changeState__!=tent.entities.ChangeStates.DELETED)c.__changeState__=
tent.entities.ChangeStates.DELETED}else{c=new tent.entities.EntityLink(a,e,b,tent.entities.ChangeStates.DELETED);this.context.changes.items.push(c)}}}};tent.entities.ContextChangeHandler.prototype.getTrackedProperty=function(a,b){var c;if(a.__entityType__&&a.__changeState__&&a.__changeState__!=tent.entities.ChangeStates.DELETED&&a.__changeState__!=tent.entities.ChangeStates.DETACHED&&a.__collection__&&a.__collection__.context==this.context&&(c=a.__entityType__.properties[b]))return c};tent.entities.ContextChangeHandler.prototype.handle=
function(a){if(a.subject){var b;if(a.eventType==tent.changes.EventTypes.CHANGED)if(a.subject.__entityType__){if(b=this.getTrackedProperty(a.subject,a.data.propertyName)){this.context.touch(a.subject);this.objectUnlinked(a.subject,a.data.propertyName,b,a.data.oldValue);this.objectLinked(a.subject,a.data.propertyName,b,a.data.current)}}else this.context.touch(a.subject);else if(a.eventType==tent.changes.EventTypes.ADDED){var c=a.subject.__parent__;if(c&&(b=this.getTrackedProperty(c,a.data.propertyName)))for(var e=
0,g=a.data.items.length;e<g;e++)this.objectLinked(c,a.data.propertyName,b,a.data.items[e])}else if(a.eventType==tent.changes.EventTypes.REMOVED)if((c=a.subject.__parent__)&&(b=this.getTrackedProperty(c,a.data.propertyName))){e=0;for(g=a.data.items.length;e<g;e++)this.objectUnlinked(c,a.data.propertyName,b,a.data.items[e])}tent.changes.reverseProperties.getHandler()(a)}};tent.entities.ContextChangeHandler.prototype.init=function(){if(this.context.log)var a=new tent.coreTypes.NameCounter;for(var b in this.context.__collections__){for(var c=
this.context.__collections__[b],e=0,g=c.items.length;e<g;e++)this.itemAttached(c.items[e]);a&&a.add(b,c.items.length)}if(this.context.log)a&&a.root._count>0?tent.log.debug("Context: initialized with "+a):tent.log.debug("Context: initialized empty")};tent.entities.ContextChangeHandler.prototype.acceptAllChanges=function(){if(this.context.hasChanges()){this.context.log&&tent.log.debug("Context: accepting changes, "+this.context.changes);for(var a=this.context.changes.items,b=0,c=a.length;b<c;b++)a[b].__changeState__=
tent.entities.ChangeStates.UNCHANGED;a.length=0;this.context.log&&tent.log.debug("Context: all changes accepted")}};tent.entities.ContextChangeHandler.prototype.acceptChanges=function(){for(var a=0,b=arguments.length;a<b;a++){var c=arguments[a],e;if(typeof c=="number"){e=c;if(e<0||this.context.changes.items.length<e-1){c=null;e=-1}else c=this.context.changes.items[e]}else e=this.context.changes.items.lastIndexOf(c);if(e>=0&&c){this.context.changes.items.splice(e,1);if(c.__changeState__==tent.entities.ChangeStates.ADDED)c.__changeState__=
tent.entities.ChangeStates.UNCHANGED;else if(c.__changeState__==tent.entities.ChangeStates.MODIFIED)c.__changeState__=tent.entities.ChangeStates.UNCHANGED;else if(c.__changeState__==tent.entities.ChangeStates.DELETED)c.__changeState__=tent.entities.ChangeStates.DETACHED}}}});tent.declare("tent.persisters.rest",function(){tent.persisters.rest.uriCombine=function(){for(var a="",b=0,c=arguments.length;b<c;b++){var e=arguments[b]+"";if(e)if(e.match(/^[A-Za-z]+\:\/\//))a=e;else a+=a.substr(a.length-1,1)=="/"?e.substr(0,1)=="/"?e.substr(1):e.substr(0,2)=="./"?e.substr(2):e:e.substr(0,1)=="/"?e:e.substr(0,2)=="./"?e.substr(1):"/"+e}return a};tent.persisters.rest.RestPersister=function(){this.baseUri="http://127.0.0.1:5984/mydb";this.saving=false;this.savingErrors=[];this.loadingErrors=
[];this.loadItemMapper=null;this.localItemFinder=function(a,b){return a.filter(function(c){if(typeof b._id!="undefined"&&c._id===b._id||typeof b.id!="undefined"&&c.id===b.id)return true;return false})[0]};this.versionEquals=function(a,b){return a._rev===b._rev};this.updateLocalVersion=function(a,b){a._rev=b.rev||b._rev;if(typeof b.id!="undefined"&&b.id!==a._id)a._id=b.id};this.isDeleted=function(a){return a._deleted};this.bulkSaveUri=this.changeResponseMapper=this.changeSerializer=null};tent.persisters.rest.RestPersister.prototype.load=
function(a,b,c){try{if(!a)throw"a context is required for loading entities";if(!b)throw"an url must be specified to load";if(this.loading)throw"already loading entities";this.loading=true;var e=this;c||(c={});var g=c.complete;c.complete=function(d){e.loading=false;d.error&&e.loadingErrors.push(d.error);g&&g(d)};this.__load__(a,b,c)}catch(j){this.loadingErrors.push(j);this.loading=false;c.complete&&c.complete({error:j})}};tent.persisters.rest.createItemMapper=function(a){a||(a={});return function(b,
c,e){if(b=b instanceof Array?b:c.multi?(c.multiSelector||a.multiSelector||function(h,i){var k=i.multiSelectorProperty||a.multiSelectorProperty;if(k)return h[k];else for(var l in h)if(h[l]instanceof Array)return h[l]})(b,c):(c.singleSelector||a.singleSelector||function(h,i){var k=i.singleSelectorProperty||a.singleSelectorProperty;return k?[h[k]]:[h]})(b,c))for(var g=0,j=b.length;g<j;g++){var d=b[g];if(c.multi)d=(c.multiItemSelector||a.multiItemSelector||function(h,i){var k=i.multiItemSelectorProperty||
a.multiItemSelectorProperty;return k?h[k]:h})(d,c);if(d){var f=c.itemTransformer||a.itemTransformer;if(f)d=f(d,c)}d&&e(d,c)}}};tent.persisters.rest.createChangeSerializer=function(a){a||(a={});return function(b,c){var e=c.itemSerializer||a.itemSerializer||function(h){if(h instanceof tent.entities.EntityLink)return null;var i={},k;for(k in h)if(h.hasOwnProperty(k)&&(k.substr(0,1)!=="_"||k==="_id"||k==="_rev"))i[k]=tent.pget(h,k);if(h.__changeState__===tent.entities.ChangeStates.DELETED)i._deleted=
true;return i};if(b instanceof Array){for(var g=[],j=0,d=b.length;j<d;j++)g.push(e(b[j],c));var f=c.saveWrapperProperty||a.saveWrapperProperty||"docs";return(c.itemsSaveWrapper||a.itemsSaveWrapper||function(h){var i={};i[f]=h;return i})(g,c)}else if(typeof b=="object")return e(b,c)}};tent.persisters.rest.createChangeResponseMapper=function(a){a||(a={});return function(b,c,e){var g;if(g=b instanceof Array?b:(c.resultSelector||a.resultSelector||function(h,i){var k=i.resultSelectorProperty||a.resultSelectorProperty;
if(k)return h[k];else{g=h;for(var l in h)if(h[l]instanceof Array)return h[l]}})(b,c)){b=0;for(var j=g.length;b<j;b++){var d=g[b];if(d=(c.resultItemSelector||a.resultItemSelector||function(h,i){var k=i.resultItemSelectorProperty||a.resultItemSelectorProperty;return k?h[k]:h})(d,c)){var f=c.resultItemTransformer||a.resultItemTransformer;if(f)d=f(d,c)}if(d){f=(c.localChangeFinder||a.localChangeFinder||function(h,i){if(h.hasChanges())for(var k=0,l=h.changes.items.length;k<l;k++){if(typeof i.id!="undefined"&&
h.changes.items[k]._id===i.id)return k;if(typeof i.id!="undefined"&&h.changes.items[k].id===i.id)return k;if(typeof i._id!="undefined"&&h.changes.items[k]._id===i._id)return k;if(typeof i._id!="undefined"&&h.changes.items[k].id===i._id)return k}})(c.context,d,c);typeof f=="number"&&f>=0||c.unorderedResults||a.unorderedResults||(f=0);typeof f=="number"&&f>=0&&e(d,f,c)}}}}};tent.persisters.rest.RestPersister.prototype.__load__=function(a,b,c){if(typeof jQuery=="undefined"||typeof jQuery.ajax=="undefined")throw"jQuery.ajax is required in order to load entities";
b=tent.persisters.rest.uriCombine(this.baseUri,b);jQuery.ajax({context:{persister:this,context:a,options:c},url:b,beforeSend:function(e){if(c.credentials){e.setRequestHeader("Origin",document.location.protocol+"//"+document.location.host);e.setRequestHeader("Authorization","Basic "+c.credentials)}},type:c.method||"GET",cache:!!c.cache,dataType:"json",success:function(e){var g={persister:this,options:c};try{this.persister.__processLoadResponse__(this.context,e,c,g);g.ok=true}catch(j){g.error=j}c.complete&&
c.complete(g)},error:function(e,g,j){e={persister:this,options:c,error:{type:g,errorThrown:j}};c.complete&&c.complete(e)}})};tent.persisters.rest.RestPersister.prototype.__processLoadResponse__=function(a,b,c){if(c.context!==a)c.context=a;if(!this.loadItemMapper)this.loadItemMapper=tent.persisters.rest.createItemMapper();var e=this;this.loadItemMapper(b,c,function(g){var j=e.localItemFinder(a,g._id);if(j)if(j.__changeState__===tent.entities.ChangeStates.MODIFIED||j.__changeState__===tent.entities.ChangeStates.DELETED)e.versionEquals(j,
g)||j.__loadErrors__.push({error:"conflict",reason:"document modified recently by another user"});else{if(e.isDeleted(g)){a.remove(j);a.detach(j)}else tent.pset(j,g,true);j.__loadErrors__&&delete j.__loadErrors__}else a.attach(g)})};tent.persisters.rest.RestPersister.prototype.saveChanges=function(a,b){try{if(!a)throw"a context is required for saving changes";b||(b={});if(!b.context)b.context=a;if(a.hasChanges()){if(this.saving)throw"Already saving changes";this.saving=true;var c=this,e=b.complete;
b.complete=function(j){c.saving=false;if(j.error)c.savingErrors.push(j.error);else if(typeof j.ok=="undefined")j.ok=true;e&&e(j)};this.__persist__(a,b)}else b.complete&&b.complete({ok:true,nochanges:true})}catch(g){this.savingErrors.push(g);this.saving=false;b.complete&&b.complete({error:g})}};tent.persisters.rest.RestPersister.prototype.__persist__=function(a,b){if(typeof jQuery=="undefined"||typeof jQuery.ajax=="undefined")throw"jQuery.ajax is required in order to persist changes";if(this.bulkSaveUri){var c=
tent.persisters.rest.uriCombine(this.baseUri,this.bulkSaveUri),e=this.__getPersistData__(a,b);if(e==null){c={persister:this,ok:true,nochanges:true};b.complete&&b.complete(c)}else jQuery.ajax({context:{persister:this,context:a},url:c,beforeSend:function(g){if(b.credentials){g.setRequestHeader("Origin",document.location.protocol+"//"+document.location.host);g.setRequestHeader("Authorization","Basic "+b.credentials)}},type:"POST",cache:false,data:JSON.stringify(e),dataType:"json",contentType:"application/json",
success:function(g){var j={persister:this};try{this.persister.__processPersistResponse__(this.context,g,b,j);j.ok=true}catch(d){j.error=d}b.complete&&b.complete(j)},error:function(g,j,d){g={persister:this,error:{type:j,errorThrown:d}};b.complete&&b.complete(g)}})}else throw"individual change save not implemented";};tent.persisters.rest.RestPersister.prototype.__getPersistData__=function(a,b){if(!this.changeSerializer)this.changeSerializer=tent.persisters.rest.createChangeSerializer();var c=null;if(a.hasChanges())c=
this.changeSerializer(a.changes.items,b);return c};tent.persisters.rest.RestPersister.prototype.__processPersistResponse__=function(a,b,c){if(a.hasChanges()){if(!this.changeResponseMapper)this.changeResponseMapper=tent.persisters.rest.createChangeResponseMapper();var e=this;this.changeResponseMapper(b,c,function(g,j){var d=a.changes.items[j];if(g.error){if(!d.__saveErrors__)d.__saveErrors__=[];d.__saveErrors__.push({error:g.error,reason:g.reason})}else{e.updateLocalVersion(d,g);d.__saveErrors__&&
delete d.__saveErrors__;a.acceptChanges(j)}})}}});tent.declare("tent.persisters.couchdb",function(){tent.persisters.couchdb.CouchDBPersister=function(){tent.persisters.rest.RestPersister.apply(this,arguments);this.bulkSaveUri="_bulk_docs";this.loadItemMapper=tent.persisters.rest.createItemMapper({multiSelectorProperty:"rows",multiItemSelectorProperty:"doc"})};tent.mixin(tent.persisters.couchdb.CouchDBPersister,tent.persisters.rest.RestPersister)});
