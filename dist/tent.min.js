var tent=tent||{};tent.global=typeof window=="undefined"?this:window;
tent.Namespace=function(a,b){if(!b)if(a){b=a;a=tent.global}else throw"must specify namespace path";if(b===".."){if(a===tent.global)throw"cannot use '..' at top level";return a.parent}var c=b.indexOf(".");c<0||b.indexOf(".",c+1);var f=a===tent.global?"":a.fullname+"";if(f)f+=".";f+=b;if(c<0)if(typeof a[b]=="undefined"){this.fullname=f;this.name=b;this.parent=a;a[b]=this}else if(!a[b]instanceof tent.Namespace)throw'error creating namespace: "'+f+'" is not a Namespace object';else return a[b];else return new tent.Namespace(new tent.Namespace(a,
b.slice(0,c)),b.slice(c+1));return this};tent.__tentTmp=new tent.Namespace("__tentTmp");tent.__tentTmp.Namespace=tent.Namespace;tent.__tentTmp.fullname="tent";tent.__tentTmp.name="tent";tent.__tentTmp.parent=tent.global;tent.__tentTmp.global=tent.global;tent.global.tent=tent.__tentTmp;delete tent.__tentTmp;try{delete tent.global.__tentTmp}catch(ex){}
tent.Namespace.prototype.expand=function(a){if(a instanceof Function)a(this);else if(typeof a=="object")for(var b in a)if(a.hasOwnProperty(b)){if(typeof this[b]!="undefined")throw this.fullname+"."+b+" already exists";this[b]=a[b]}return this};
tent.declare=function(){for(var a,b=0;b<arguments.length;b++){var c=arguments[b];if(c instanceof tent.Namespace)a=c;else if(typeof c=="string")a=a?new tent.Namespace(a,c):new tent.Namespace(c);else if(c instanceof Function||typeof c=="object"){if(!a)throw"no namespace provided";a.expand(c)}else throw"invalid argument type at index "+b+", expected Namespace, string, Function";}return a};
tent.mixin=function(a,b){for(var c in b.prototype)if(b.prototype.hasOwnProperty(c))a.prototype[c]=b.prototype[c];return a};tent.isDOMObject=function(a){if(typeof Node!="undefined"&&a instanceof Node||typeof Element!="undefined"&&a instanceof Element||typeof NodeList!="undefined"&&a instanceof NodeList||a===window||a===document)return true;if(typeof o==="object"&&typeof o.nodeType==="number"&&typeof o.nodeName==="string")return true;return false};
tent.DOMPropertyNames=["nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate","dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter",
"id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin","isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove",
"title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue","onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout",
"aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart","aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all",
"onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name","nextSibling","onresizeend","onrowenter","aria-haspopup","childNodes","ondragleave","canHaveHTML","onbeforepaste","ondragover","onbeforecopy","aria-disabled","onpage","recordNumber","previousSibling","nodeName","onbeforeactivate","accessKey","currentStyle","scrollLeft","onbeforeeditfocus","oncontrolselect","aria-hidden","onblur","hideFocus","clientHeight","style","onbeforedeactivate",
"dir","aria-expanded","onkeydown","nodeType","ondragstart","onscroll","onpropertychange","ondragenter","id","aria-level","onrowsinserted","scopeName","lang","onmouseup","aria-busy","oncontextmenu","language","scrollTop","offsetWidth","onbeforeupdate","onreadystatechange","onmouseenter","filters","onresize","isContentEditable","aria-checked","aria-readonly","oncopy","onselectstart","scrollHeight","onmove","ondragend","onrowexit","lastChild","aria-secret","onactivate","canHaveChildren","onfocus","onfocusin",
"isMultiLine","onmouseover","offsetTop","oncut","parentNode","tagName","className","onmousemove","title","role","behaviorUrns","onfocusout","onfilterchange","disabled","parentTextEdit","ownerDocument","offsetParent","aria-posinset","ondrop","ondblclick","onrowsdelete","tabIndex","onkeypress","aria-relevant","onlosecapture","innerText","aria-live","parentElement","ondeactivate","aria-labelledby","aria-pressed","children","ondatasetchanged","ondataavailable","aria-invalid","onafterupdate","nodeValue",
"onmousewheel","onkeyup","readyState","onmovestart","aria-valuenow","aria-selected","onmouseout","aria-owns","aria-valuemax","onmoveend","contentEditable","document","firstChild","sourceIndex","outerText","isTextEdit","isDisabled","oncellchange","runtimeStyle","scrollWidth","aria-valuemin","onlayoutcomplete","onhelp","attributes","offsetHeight","onerrorupdate","onmousedown","clientTop","aria-setsize","clientWidth","onpaste","tagUrn","onmouseleave","onclick","outerHTML","ondrag","aria-controls","onresizestart",
"aria-flowto","ondatasetcomplete","aria-required","clientLeft","aria-describedby","all","onbeforecut","innerHTML","aria-activedescendant","aria-multiselectable","offsetLeft","dataSrc","dataFld","dataFormatAs","name"];tent.isDOMProperty=function(a){if(!tent.DOMPropertyNames.indexOf)tent.DOMPropertyNames.indexOf=tent.arrays.functions.indexOf;return tent.DOMPropertyNames.indexOf(a)>=0};
tent.clone=function(a,b){if(a===null)return null;else if(typeof a=="undefined")return;else if(typeof a=="object"){if(b&&b.onlyForTracking&&tent.changes.getPropertyInterceptMode()!=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM)return a;if(b){if(b.deep&&!b.deepStack)b.deepStack=tent.arrays.extend([])}else b={};if(a instanceof Array)for(var c=[],f=0;f<a.length;f++)if(typeof a[f]=="object"&&b.deep){b.deepStack.push(a);if(b.deepStack.lastIndexOf(a[f])<0){if(b.attachedObjects!==false||!a[f].__collection__)c.push(tent.clone(a[f],
b))}else if(!b.ignoreCircularReferences)throw"Circular reference when cloning array";b.deepStack.pop()}else c.push(a[f]);else{c=b.dom?document.createElement("span"):{};for(f in a)if(!(b.onlyOwnProperties&&!a.hasOwnProperty(f))){var h=f.substr(0,1)=="_";if(!(b.skipPrivates&&h))if(!b.clonePrivates&&h)typeof a[f]=="object"&&b.attachedObjects===false&&a[f].__collection__||(c[f]=a[f]);else{h=a.__observable__?tent.pget(a,f):a[f];if(b.deep&&typeof h=="object"){if(!(b.attachedObjects===false&&h.__collection__)){b.deepStack.push(a);
if(b.deepStack.indexOf(h)<0)c[f]=tent.clone(h,b);else if(!b.ignoreCircularReferences)throw"Circular reference when cloning object";b.deepStack.pop()}}else c[f]=h}}}return c}return a};tent.declare("tent.arrays",function(){tent.arrays.extend=function(a,b){for(var c in tent.arrays.functions)if(b||!(a[c]instanceof Function))a[c]=tent.arrays.functions[c];return a};tent.arrays.functions={findByProperty:function(a,b){for(var c=0,f=this.length;c<f;c++)if(this[c][a]===b)return this[c];return null},indexByProperty:function(a,b){for(var c=0,f=this.length;c<f;c++)if(this[c][a]===b)return c;return-1},indexOf:function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1},lastIndexOf:function(a){for(var b=
this.length-1;b>0;b--)if(this[b]===a)return b;return-1},filter:function(a){for(var b=[],c=0,f=this.length;c<f;c++)a(this[c])&&b.push(this[c]);return b},remove:function(){for(var a,b=0,c=this.length;b<c;b++)for(var f=0,h=arguments.length;f<h;f++)if(this[b]==arguments[f]){this.splice(b,1);a=true;b--;c--;break}if(a)return true;return false},set:function(a,b){this.splice(a,1,b)},pushUnique:function(){if(arguments.length==1){for(var a=false,b=0,c=this.length;b<c;b++)if(this[b]==arguments[0]){a=true;break}a||
this.push(arguments[0])}else{a=[];b=0;for(c=this.length;b<c;b++)for(var f=0,h=arguments.length;f<h;f++)if(this[b]==arguments[f])a[f]=true;f=0;for(h=arguments.length;f<h;f++)a[f]||this.push(arguments[f])}return this.length},clone:function(){var a=[];Array.prototype.push.apply(a,this);return a},isCloneOf:function(a){if(!a)return false;if(this.length!=a.length)return false;if(this===a)return false;for(var b=this.length;b>=0;b--)if(this[b]!==a[b])return false;return true}}});tent.declare("tent.coreTypes",function(){tent.coreTypes.Enum=function(){this.__names__=[];this.__values__={};this.__flags__=false;this.__enum=true;arguments.length>0&&this.add.apply(this,arguments)};tent.coreTypes.Enum.prototype.getName=function(c){if(this.__names__)if(this.__names__[c])return this.__names__[c];else if(this.__flags__){c=c;var f="",h;for(h in this.__values__)if(this.__values__[h]&&(this.__values__[h]&c)===this.__values__[h]){c-=this.__values__[h];if(f)f+="|";f+=h}if(f&&c===0)return f;
else if(f)return f+"|"+c}};tent.coreTypes.Enum.prototype.__freeValue__=function(){var c=typeof this.__maxValue__=="undefined"?1:this.__maxValue__+1;if(this.__values__&&typeof this.__values__[c]!="undefined")for(var f in this.__values__)if(this.__values__[f]>=c){this.__maxValue__=this.__values__[f];c=this.__values__[f]+1}if(this.__flags__)c=c<1?1:Math.pow(2,Math.ceil(Math.log(c)/Math.log(2)));return c};tent.coreTypes.Enum.prototype.useFlags=function(c){this.__flags__=c;return this};var a=function(c,
f,h){c[f]=h;c.__values__[f]=h;if(typeof c.__names__[h]=="undefined")c.__names__[h]=f;if(typeof c.__maxValue__=="undefined"||c.__maxValue__<h)c.__maxValue__=h};tent.coreTypes.Enum.prototype.add=function(){if(arguments.length<1)return this;for(var c,f,h=0,j=arguments.length;h<j;h++){c=arguments[h];if(c instanceof Array)this.add.apply(this,c);else if(typeof c=="object")for(f in c)if(c.hasOwnProperty(f)){var d=this.__values__[f];if(!d instanceof Number||typeof this.__names__[d]!="undefined")d=this.__freeValue__();
a(this,f,d)}if(typeof c=="string")if(c){c=c.split(",");d=0;for(var e=c.length;d<e;d++){f=c[d].replace(/^\s+/g,"").replace(/\s+$/g,"");if(f=="_FLAGS")this.useFlags(true);else{if(typeof this.__values__[f]!="undefined")if(this.__values__[f]instanceof Number)throw"Enum duplicate name found: "+f;else throw"Enum invalid name (reserved): "+f;if(d==e-1&&h<j-1&&typeof arguments[h+1]=="number"){a(this,f,arguments[h+1]);h++}else a(this,f,this.__freeValue__())}}}}return this};var b=function(){var c=this._name+
(this._count>1?"("+this._count+")":"");if(this._childrenCount){c+="{";var f=0,h;for(h in this)if(h.substr(0,1)!="_"&&typeof this[h]=="object"){if(f>0)c+=", ";c+=this[h];f++}c+="}"}return c};tent.coreTypes.NameCounter=function(c){this.root={_name:c||"",_count:0,toString:b}};tent.coreTypes.NameCounter.prototype.__nodeAdd__=function(c,f){c._count=(c._count||0)+f;if(c._parent){if(c._count==0&&!c._childrenCount){c._parent._childrenCount&&c._parent._childrenCount--;delete c._parent[c._name]}this.__nodeAdd__(c._parent,
f)}};tent.coreTypes.NameCounter.prototype.add=function(c,f){if(typeof f!="number")f=1;for(var h=c.split("."),j=this.root,d=0;d<h.length;d++){if(typeof j[h[d]]=="undefined"){j._childrenCount=(j._childrenCount||0)+1;j[h[d]]={_parent:j,_name:h[d],_count:0,toString:b}}j=j[h[d]]}this.__nodeAdd__(j,f)};tent.coreTypes.NameCounter.prototype.reset=function(){this.root={_name:this.root._name,_count:0,toString:b}};tent.coreTypes.NameCounter.prototype.toString=function(){return b.apply(this.root)}});tent.declare("tent.logging",function(){tent.logging.Levels=new tent.coreTypes.Enum("TRACE,DEBUG,INFO,WARN,ERROR,FATAL");tent.logging.Log=function(){this.listeners=[]};tent.logging.Log.prototype.bindToConsole=function(a){typeof console!="undefined"&&this.bind(tent.logging.consoleLogger,a);return this};tent.logging.Log.prototype.bindToAlert=function(a){this.bind(tent.logging.alertLogger,a);return this};tent.logging.Log.prototype.bindToHtml=function(a,b){this.bind(tent.logging.createHtmlAppendLogger(a),
b);return this};tent.logging.Log.prototype.unbindConsole=function(){typeof console!="undefined"&&this.unbind(tent.logging.consoleLogger);return this};tent.logging.Log.prototype.unbindAlert=function(){this.unbind(tent.logging.alertLogger,level);return this};tent.logging.Log.prototype.unbindHtml=function(a){for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback.outputElement===a&&this.listeners.splice(b,1);return this};tent.logging.Log.prototype.bind=function(a,b){if(!a instanceof Function)throw"a callback Function must be provided";
var c=b;if(typeof c!="number")c=typeof c=="undefined"?tent.logging.Levels.TRACE:tent.logging.Levels[c]||tent.logging.Levels.TRACE;for(var f=false,h=this.listeners.length-1;h>=0;h--){var j=this.listeners[h];if(j.callback===a){j.level=c;f=true}}f||this.listeners.push({callback:a,level:c});return this};tent.logging.Log.prototype.unbind=function(a){if(!a instanceof Function)throw"a callback Function must be provided";for(var b=this.listeners.length;b>=0;b--)this.listeners[b].callback===a&&this.listeners.splice(b,
1);return this};tent.logging.Log.prototype.notify=function(a,b){var c=b;if(typeof c!="number")c=c?tent.logging.Levels[c]||tent.logging.Levels.INFO:tent.logging.Levels.INFO;for(var f=0,h=this.listeners.length;f<h;f++){var j=this.listeners[f];if(j.callback)if(typeof j.level=="undefined"||j.level<=c)j.callback(a,b)}};tent.logging.Log.prototype.trace=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.TRACE)};tent.logging.Log.prototype.debug=function(){this.notify(this.stringOrStringify.apply(this,
arguments),tent.logging.Levels.DEBUG)};tent.logging.Log.prototype.info=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.INFO)};tent.logging.Log.prototype.warn=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.WARN)};tent.logging.Log.prototype.error=function(){this.notify(this.stringOrStringify.apply(this,arguments),tent.logging.Levels.ERROR)};tent.logging.Log.prototype.fatal=function(){this.notify(this.stringOrStringify.apply(this,
arguments),tent.logging.Levels.FATAL)};tent.logging.Log.prototype.stringify=function(){var a="";try{var b=arguments.length>0&&arguments[arguments.length-1]&&arguments[arguments.length-1]._options?arguments[arguments.length-1]:{_options:true};if(!b.deepStack){b.deepStack=[];tent.arrays.extend(b.deepStack)}for(var c=0,f=arguments.length;c<f;c++)if(!(arguments[c]&&typeof arguments[c]=="object"&&arguments[c]._options))if(!(arguments[c]instanceof Function)){if(a)a+=", ";if(b.deepStack.length>3||b.deepStack.lastIndexOf(arguments[c])>=
0)a+="#";else if(typeof arguments[c]=="undefined")a+="undefined";else if(arguments[c]==null)a+="null";else if(arguments[c]instanceof Array){var h=tent.arrays.functions.clone.apply(arguments[c]).filter(function(g){if(g instanceof Function)return false;if(b.deepStack.lastIndexOf(g>=0))return false;return true});h.push(b);b.deepStack.push(arguments[c]);a+="[";if(b.deepStack.length<4)a+=this.stringify.apply(this,h);b.deepStack.pop();a+="]"}else if(typeof arguments[c]=="string")a+='"'+arguments[c]+'"';
else if(arguments[c]instanceof Date)a+='"'+arguments[c]+'"';else if(typeof arguments[c]=="object"){var j="";b.deepStack.push(arguments[c]);if(b.deepStack.length<4)for(var d in arguments[c])if(!(arguments[c][d]instanceof Function))if(!(b.deepStack.lastIndexOf(arguments[c][d])>=0)){if(j)j+=", ";j+='"'+d+'": '+this.stringify.apply(this,[arguments[c][d],b])}b.deepStack.pop();a+="{"+j+"}"}else a+=arguments[c]}}catch(e){return"#err#"}return a};tent.logging.Log.prototype.stringOrStringify=function(){return arguments.length==
1&&typeof arguments[0]=="string"?arguments[0]:this.stringify.apply(this,arguments)};tent.logging.consoleLogger=function(a,b){if(b==tent.logging.Levels.TRACE)console.trace?console.trace(a):console.info(a);if(b==tent.logging.Levels.DEBUG)console.debug?console.debug(a):console.info(a);b==tent.logging.Levels.INFO&&console.info(a);if(b==tent.logging.Levels.WARN)console.warn?console.warn(a):console.info(a);b==tent.logging.Levels.ERROR&&console.error(a);b==tent.logging.Levels.FATAL&&console.error(a)};tent.logging.alertLogger=
function(a){alert(a)};tent.logging.createHtmlAppendLogger=function(a){var b=null;b=a.tagName=="INPUT"?function(c,f){a.value+="\n["+tent.logging.Levels.getName(f)+"] "+c}:a.tagName=="UL"?function(c,f){var h=document.createElement("li");h.innerHTML="["+tent.logging.Levels.getName(f)+"] "+c;a.appendChild(h)}:a.tagName=="TABLE"?function(c,f){var h=document.createElement("tr"),j=document.createElement("td");j.setAttribute("class","eventType");j.innerHTML=tent.logging.Levels.getName(f);h.appendChild(j);
j=document.createElement("td");j.setAttribute("class","eventMessage");j.innerHTML=c.replace(/(\<)/g,"&lt;").replace(/(\>)/g,"&gt;").replace(/(\&)/g,"&amp;").replace(/(\s)/g,"&nbsp;");h.appendChild(j);a.tBodies[0].appendChild(h)}:function(c,f){a.innerHTML+="<br/>["+tent.logging.Levels.getName(f)+"] "+c};b.outputElement=a;return b};tent.log=(new tent.logging.Log).bindToConsole()});tent.declare("tent.changes",function(){tent.changes.EventTypes=new tent.coreTypes.Enum("ANY,MANYCHANGES,CHANGING,CHANGED,ADDING,ADDED,REMOVING,REMOVED");tent.changes.InterceptorTypes=new tent.coreTypes.Enum("PROPERTY,FUNCTION");tent.changes.PropertyInterceptModes=new tent.coreTypes.Enum("NONE,DEFINESETTER,DEFINEPROPERTY,DEFINEPROPERTYONLYDOM");var a;tent.changes.getPropertyInterceptMode=function(){if(typeof a=="undefined"){var d={};if(Object.defineProperty)try{Object.defineProperty(d,"myproperty",
{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINEPROPERTY}catch(e){if(document&&document.createElement){d=document.createElement("span");try{Object.defineProperty(d,"myproperty",{get:function(){return this._myproperty},set:function(k){this._myproperty=k}});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM}catch(g){}}}if(typeof a==
"undefined"){d={};if(d.__defineSetter__)try{d.__defineGetter__("myproperty",function(){return this._myproperty});d.__defineSetter__("myproperty",function(k){this._myproperty=k});d.myproperty="my value";if(d.myproperty==="my value"&&d._myproperty==="my value")a=tent.changes.PropertyInterceptModes.DEFINESETTER}catch(i){}}if(typeof a=="undefined")a=tent.changes.PropertyInterceptModes.NONE}return a};tent.changes.getPropertyInterceptModeName=function(){return tent.changes.PropertyInterceptModes.getName(tent.changes.getPropertyInterceptMode())};
tent.changes.Change=function(d,e,g){this.subject=d;this.eventType=e;this.data=g};tent.changes.ChangeStringifiers=[];tent.changes.Change.prototype.toString=function(){if(typeof tent.changes.ChangeStringifiers[this.eventType]!="undefined")tent.changes.ChangeStringifiers[this.eventType](this);else{var d=tent.changes.EventTypes.getName(this.eventType);if(this.eventType==tent.changes.EventTypes.MANYCHANGES){d+=": ";if(this.data.length<=3)for(var e=0,g=this.data.length;e<g;e++)d+=this.data[e].toString()+
",";else{var i={};e=0;for(g=this.data.length;e<g;e++)i[this.data[e].eventType]=(i[this.data[e].eventType]||0)+1;for(var k in i)d+=tent.changes.EventTypes.getName(k)+"("+i[k]+"),"}}else{if(this.data.propertyName){d+=" "+this.data.propertyName;if(this.eventType==tent.changes.EventTypes.CHANGING)d+=" from "+this.data.current+" to "+this.data.newValue;else if(this.eventType==tent.changes.EventTypes.CHANGED)d+=" from "+this.data.oldValue+" to "+this.data.current;d+=" (on "+this.subject+")"}if(this.data.items){e=
this.data.items;d+=" "+e.length+(e.length>1?" items":" item");if(typeof this.data.index!="undefined")d+=" at index "+this.data.index;d+=this.data.propertyName?" ("+this.subject.__parent__+"."+this.data.propertyName+")":" (["+e+"])"}}return"[Change: "+d+"]"}};tent.changes.Observable=function(d){this.subject=d;this.handlers={};this.interceptors={};this.suspended=false;this.changesWhileSuspended=null};tent.changes.Observable.prototype.interceptFunction=function(d,e){if(!this.interceptors[d]){var g="_"+
d,i={name:d,_name:g,type:tent.changes.InterceptorTypes.FUNCTION};this.subject[g]=this.subject[d];this.subject[d]=e;this.interceptors[d]=i}};tent.pset=function(d,e,g,i){if(typeof e=="object"){for(var k in e)e.hasOwnProperty(k)&&tent.pset(d,k,e[k],g);return d}else{if(d.__observable__&&d.__observable__.interceptors&&d.__observable__.interceptors[e])if(i)d[d.__observable__.interceptors[e]._name||e]=g;else d.__observable__.interceptors[e].newsetter.call(d,g);else d[e]=g;return g}};tent.pget=function(d,
e){return d.__observable__&&d.__observable__.interceptors&&d.__observable__.interceptors[e]?d.__observable__.interceptors[e].newgetter.call(d):d[e]};tent.changes.Observable.prototype.interceptProperty=function(d,e,g,i){if(this.interceptors[d])return this.interceptors[d];var k={name:d,type:tent.changes.InterceptorTypes.PROPERTY,newsetter:i,newgetter:g};if(e){e="_"+d;try{this.subject[e]=this.subject[d]}catch(l){this.subject[e]=null}k._name=e}e=tent.changes.getPropertyInterceptMode();if(e==tent.changes.PropertyInterceptModes.DEFINEPROPERTY||
e==tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject)){try{k.descriptor=Object.getOwnPropertyDescriptor(this.subject,d)}catch(m){}e={};if(g)e.get=g;if(i)e.set=i;try{Object.defineProperty(this.subject,d,e)}catch(n){tent.log.warn("Object.defineProperty for property '"+d+"' failed: "+n)}}else if(e==tent.changes.PropertyInterceptModes.DEFINESETTER){try{k.getter=this.subject.__lookupGetter__(d);k.setter=this.subject.__lookupSetter__(d)}catch(p){}if(g)try{this.subject.__defineGetter__(d,
g)}catch(q){tent.log.warn("Object.__defineGetter__ for property '"+d+"' failed: "+q)}if(i)try{this.subject.__defineSetter__(d,i)}catch(r){tent.log.warn("Object.__defineSetter__ for property '"+d+"' failed: "+r)}}if(k)this.interceptors[d]=k;return k};tent.changes.Observable.prototype.shouldNotifyParent=function(){return!!(this.parentObject&&this.parentObject!==this&&this.parentObjectPropertyName&&this.parentObject.__observable__&&this.parentObject.__observable__.interceptors&&this.parentObject.__observable__.interceptors[this.parentObjectPropertyName])};
tent.changes.Observable.prototype.notifyParentChanging=function(d){d.subject=this.subject;this.parentObject.__observable__.notifyChange(tent.changes.EventTypes.CHANGING,{propertyName:this.parentObjectPropertyName,innerChange:d})};tent.changes.Observable.prototype.notifyParentChanged=function(d){d.subject=this.subject;this.parentObject.__observable__.notifyChange(tent.changes.EventTypes.CHANGED,{propertyName:this.parentObjectPropertyName,innerChange:d})};var b=function(d,e){return function(g){var i=
this[e];if(i!=g){this.__observable__.notifyChange(tent.changes.EventTypes.CHANGING,{propertyName:d,current:i,newValue:g});var k=this.__observable__.shouldNotifyParent();k&&this.__observable__.notifyParentChanging({propertyName:d,current:i,newValue:g});this[e]=g;this.__observable__.notifyChange(tent.changes.EventTypes.CHANGED,{propertyName:d,current:g,oldValue:i});k&&this.__observable__.notifyParentChanged({propertyName:d,current:g,oldValue:i})}}},c=function(d,e){return function(){return this[e]}},
f=function(d,e){return e.substr(0,1)!="_"};tent.changes.Observable.prototype.interceptProperties=function(d){d||(d={});var e=d.propertyFilter||f,g=d.backPropertyPrefix||"_";!d.trackDomProperties&&this.isDOMObject();for(var i in this.subject)if(!tent.isDOMProperty(i))try{if(typeof this.subject[i]!="function"&&e(this.subject,i)){d=g+i;this.interceptProperty(i,d,c(i,d),b(i,d))}}catch(k){tent.log.warn("Error intercepting property '"+i+"': "+k)}return this};tent.changes.Observable.prototype.isDOMObject=
function(){if(typeof this._isDomObject=="undefined")this._isDOMObject=tent.isDOMObject(this.subject);return this._isDOMObject};tent.changes.Observable.prototype.interceptArrayModifiers=function(){if(!this.subject instanceof Array)return this;var d=this.subject;this.subject.setLength=function(e){if(this.length>e)this.splice(e,this.length-e);else this.lengh=e};this.interceptFunction("push",function(){var e=this.length,g=g=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,
{items:g,index:e,propertyName:this.__propertyName__});var i=this.__observable__.shouldNotifyParent();i&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.ADDING,data:{items:g,index:e,propertyName:this.__propertyName__}});this._push.apply(this,arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:g,index:e,propertyName:this.__propertyName__});i&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.ADDED,data:{items:g,index:e,propertyName:this.__propertyName__}})});
this.interceptFunction("unshift",function(){var e=e=Array.prototype.slice.call(arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,{items:e,index:0,propertyName:this.__propertyName__});var g=this.__observable__.shouldNotifyParent();g&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.ADDING,data:{items:e,index:0,propertyName:this.__propertyName__}});this._unshift.apply(this,arguments);this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:e,
index:0,propertyName:this.__propertyName__});g&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.ADDED,data:{items:e,index:0,propertyName:this.__propertyName__}})});this.interceptFunction("pop",function(){var e=this.length-1;this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:[this[e]],index:e,propertyName:this.__propertyName__});var g=this.__observable__.shouldNotifyParent();g&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.REMOVING,
data:{items:[this[e]],index:e,propertyName:this.__propertyName__}});var i=this._pop();this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:[i],index:e,propertyName:this.__propertyName__});g&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.REMOVED,data:{items:[i],index:e,propertyName:this.__propertyName__}});return i});this.interceptFunction("shift",function(){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:[this[0]],index:0,propertyName:this.__propertyName__});
var e=this.__observable__.shouldNotifyParent();e&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.REMOVING,data:{items:[this[0]],index:0,propertyName:this.__propertyName__}});var g=this._shift();this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:[g],index:0,propertyName:this.__propertyName__});e&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.REMOVED,data:{items:[g],index:0,propertyName:this.__propertyName__}});return g});this.interceptFunction("splice",
function(e,g){var i,k=this.__observable__.shouldNotifyParent();if(g&&g>0){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVING,{items:this.slice(e,e+g),index:e,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.REMOVING,data:{items:this.slice(e,e+g),index:e,propertyName:this.__propertyName__}})}if(arguments.length>2){i=Array.prototype.slice.call(arguments,2);this.__observable__.notifyChange(tent.changes.EventTypes.ADDING,{items:i,
index:e,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanging({type:tent.changes.EventTypes.ADDING,data:{items:i,index:e,propertyName:this.__propertyName__}})}if(i&&i.length>0){var l=i.slice(0);l.unshift(e,g);l=this._splice.apply(this,l)}else l=this._splice(e,g);if(l&&l.length>0){this.__observable__.notifyChange(tent.changes.EventTypes.REMOVED,{items:l,index:e,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.REMOVED,
data:{items:l,index:e,propertyName:this.__propertyName__}})}if(arguments.length>2){this.__observable__.notifyChange(tent.changes.EventTypes.ADDED,{items:i,index:e,propertyName:this.__propertyName__});k&&this.__observable__.notifyParentChanged({type:tent.changes.EventTypes.ADDED,data:{items:i,index:e,propertyName:this.__propertyName__}})}return l});d.remove=tent.arrays.functions.remove;d.set=tent.arrays.functions.set;if(!d.indexOf)d.indexOf=tent.arrays.functions.indexOf;if(!d.lastIndexOf)d.lastIndexOf=
tent.arrays.functions.lastIndexOf;return this};tent.changes.Observable.prototype.removeInterceptor=function(d){var e=this.interceptors[d];if(e._name){if(e.type!=tent.changes.InterceptorTypes.FUNCTION){try{delete this.subject[e.name]}catch(g){tent.log.warn("Error deleting property interceptor '"+e.name+"': "+g)}var i=tent.changes.getPropertyInterceptMode();if(i==tent.changes.PropertyInterceptModes.DEFINEPROPERTY||i==tent.changes.PropertyInterceptModes.DEFINEPROPERTYONLYDOM&&tent.isDOMObject(this.subject))e.descriptor&&
e.descriptor.name&&Object.defineProperty(this.subject,d,e.descriptor);else if(i==tent.changes.PropertyInterceptModes.DEFINESETTER){e.getter&&this.subject.__defineGetter__(d,e.getter);e.setter&&this.subject.__defineSetter__(d,e.setter)}}try{this.subject[e.name]=this.subject[e._name]}catch(k){(i=tent.isDOMObject(this.subject))||tent.log.warn("Error restoring property '"+e.name+"' value: "+k)}try{delete this.subject[e._name]}catch(l){tent.log.warn("Error deleting back storage property '"+e._name+"': "+
l)}}else if(e.type!=tent.changes.InterceptorTypes.FUNCTION){i=this.subject[e.name];delete this.subject[e.name];this.subject[e.name]=i}delete e[d]};tent.changes.Observable.prototype.removeInterceptors=function(){for(var d in this.interceptors)try{this.removeInterceptor(d)}catch(e){tent.log.warn("Error removing interceptor from property '"+d+"': "+e)}this.interceptors={}};tent.changes.Observable.prototype.suspend=function(){this.suspended=true};tent.changes.Observable.prototype.resume=function(){this.suspended=
false;if(this.changesWhileSuspended){if(this.changesWhileSuspended.length<5)for(var d=0,e=this.changesWhileSuspended.length;d<e;d++)this.notifyChange(this.changesWhileSuspended[d]);else this.changesWhileSuspended.length>1&&this.notifyChange(tent.changes.EventTypes.MANYCHANGES,this.changesWhileSuspended);delete this.changesWhileSuspended}};tent.changes.Observable.prototype.isValidHandler=function(d){if(!d)return false;if(typeof d=="function"||typeof d=="object"&&typeof d.handle=="function")return true;
return false};tent.changes.Observable.prototype.bind=function(d,e){if(!e)if(this.isValidHandler(d)){e=d;d=tent.changes.EventTypes.ANY}else throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!this.isValidHandler(e))throw"must specify a handler: function (Change) or and object with a handle(Change) function";if(!d)d=tent.changes.EventTypes.ANY;var g=this.handlers[d];g||(g=this.handlers[d]=[]);for(var i=0;i<g.length;i++)if(g[i]==e)return false;this.handlers[d].push(e);
return true};tent.changes.Observable.prototype.unbind=function(d,e){if(!e)if(this.isValidHandler(d)){e=d;d=tent.changes.EventTypes.ANY}else throw"must specify a handler to remove";if(!this.isValidHandler(e))throw"must specify a handler to remove";if(!d)d=tent.changes.EventTypes.ANY;var g=this.handlers[d],i=false;if(g)for(var k=0,l=g.length;k<l;k++)if(g[k]==e){g.splice(k,1);k--;l--;i=true}return i};tent.changes.Observable.prototype.unbindWhere=function(d){var e=false,g;for(g in this.handlers)for(var i=
this.handlers[g],k=0,l=i.length;k<l;k++)if(d(i[k])){i.splice(k,1);k--;l--;e=true}return e};tent.changes.Observable.prototype.notifyHandler=function(d,e){try{return typeof e=="function"?e.call(this.subject,d):e.handle(d)}catch(g){var i="";if(g.stack)i+=g.stack;else if(g.message)i+=g.message;tent.log.error("Change Handler Error: "+g+(i?"\n"+i:""));return g}};tent.changes.Observable.prototype.notifyChange=function(d,e){if(this.suspended){if(!this.changesWhileSuspended){this.changesWhileSuspended=[];
if(!this.changesWhileSuspended.filter)this.changesWhileSuspended.filter=tent.arrays.functions.filter;this.changesWhileSuspended.findByEventType=function(){for(var m=0,n=this.length;m<n;m++)for(var p=0,q=arguments.length;p<q;p++)if(this[m].eventType==arguments[p])return this[m]};this.changesWhileSuspended.findPropertyChanged=function(m,n){for(var p=0,q=this.length;p<q;p++)if(this[p].subject==m&&this[p].eventType==tent.changes.EventTypes.CHANGED&&this[p].data.propertyName==n)return this[p]};this.changesWhileSuspended.findArrayChanged=
function(){for(var m=0,n=this.length;m<n;m++)if(this[m].subject==subject&&(this[m].eventType==tent.changes.EventTypes.ADDED||this[m].eventType==tent.changes.EventTypes.REMOVED))return this[m]}}this.changesWhileSuspended.push(new tent.changes.Change(this.subject,d,e))}else{var g;g=d instanceof tent.changes.Change?d:new tent.changes.Change(this.subject,d,e);var i=this.handlers[d];if(i)for(var k=0,l=i.length;k<l;k++)this.notifyHandler(g,i[k]);if(i=this.handlers[tent.changes.EventTypes.ANY]){k=0;for(l=
i.length;k<l;k++)this.notifyHandler(g,i[k])}}};var h;tent.changes.Observable.prototype.log=function(d){if(typeof d=="undefined")d=true;if(d){h||(h=new tent.changes.LogHandler);return this.bind(h)}else if(h)return this.unbind(h);return false};tent.changes.LogHandler=function(d){if(typeof d=="undefined")d="";else if(d&&d[d.length-1]!=" ")d+=" ";this.prefix=d};tent.changes.LogHandler.prototype.handle=function(d){tent.log.info(this.prefix+d.toString())};var j=function(d){var e={};for(opName in d)if(opName!=
"deepStack"&&opName!="liveHandler")e[opName]=d[opName];d=function(g){if(g.eventType==tent.changes.EventTypes.CHANGED){if(typeof g.data.current=="object")if(e.deepOverDOM||!tent.isDOMObject(g.data.current)){e.deepStack=[g.data.subject];tent.changes.track(g.data.current,e);delete e.deepStack}}else if(g.eventType==tent.changes.EventTypes.ADDED)for(var i=0,k=g.data.items.length;i<k;i++)if(typeof g.data.items[i]=="object")if(e.deepOverDOM||!tent.isDOMObject(g.data.current)){e.deepStack=[g.data.subject];
tent.changes.track(g.data.items[i],e);delete e.deepStack}};d.isLivePropagator=true;return d};tent.changes.track=function(d,e){e||(e={});if(typeof d!="object"){if(!e.deepStack)throw"Cannot track changes of "+typeof d;return false}else if(d==null){if(!e.deepStack)throw"Cannot track changes of null";return false}if(e.attachedObjects===false&&d.__collection__)return false;var g=d instanceof Array,i=false;if(!e.remove&&!e.removeAll&&!d.__observable__){if(e.observable&&(!e.observable.subject||e.observable.subject==
d)){d.__observable__=e.observable;d.__observable__.subject=d}else d.__observable__=new tent.changes.Observable(d);i=true;if(!e.interceptOptions)e.interceptOptions={};g?d.__observable__.interceptArrayModifiers(e.interceptOptions):d.__observable__.interceptProperties(e.interceptOptions)}if(e.parentObject&&typeof e.parentObjectPropertyName){if(d.__observable__.parentObject!==e.parentObject){d.__observable__.parentObject=e.parentObject;i=true}if(d.__observable__.parentObjectPropertyName!==e.parentObjectPropertyName){d.__observable__.parentObjectPropertyName=
e.parentObjectPropertyName;i=true}}else if(e.parentObject===false){if(typeof d.__observable__.parentObject!="undefined"){delete d.__observable__.parentObject;i=true}if(d.__observable__.parentObjectPropertyName!="undefined"){delete d.__observable__.parentObjectPropertyName;i=true}}if(e.bindings)for(var k=0,l=e.bindings.length;k<l;k++){var m=e.bindings[k];if(g&&m.bindArrays!=false||!g&&m.bindObjects!=false)if(e.remove){if(d.__observable__&&d.__observable__.unbind(m.eventType,m.handler))i=true}else if(d.__observable__.bind(m.eventType,
m.handler))i=true}if(e.log)if(d.__observable__&&d.__observable__.log(!e.remove))i=true;if(e.reverseProperties)if(e.remove){if(d.__observable__&&d.__observable__.unbind(tent.changes.reverseProperties.getHandler()))i=true}else if(d.__observable__.bind(tent.changes.reverseProperties.getHandler()))i=true;if(e.removeAll&&d.__observable__){d.__observable__.removeInterceptors();delete d.__observable__.subject;delete d.__observable__;i=true}if(e.deep&&e.live&&!e.remove)if(e.remove){if(d.__observable__.unbindWhere(function(p){return p.isLivePropagator}))i=
true}else{if(!e.liveHandler)e.liveHandler=j(e);if(d.__observable__.bind(e.liveHandler))i=true}if(e.deep){if(e.deepStack)e.deepStack.push(d);else{e.deepStack=[d];if(!e.deepStack.lastIndexOf)e.deepStack.lastIndexOf=tent.arrays.functions.lastIndexOf}if(g){k=0;for(l=d.length;k<l;k++)if((g=d[k])&&typeof g=="object"&&e.deepStack.lastIndexOf(g)<0)if(tent.changes.track(g,e))i=true}else{k=e.propertyFilter||f;for(var n in d)if(typeof d[n]!="function"&&k(d,n)){g=d[n];if(e.deepOverDOM||!tent.isDOMObject(g))if(typeof g==
"object"&&e.deepStack.lastIndexOf(g)<0)if(tent.changes.track(g,e))i=true}}e.deepStack.pop()}return i};tent.changes.untrack=function(d,e){if(e){if(!e.removeAll)e.removeAll=true}else e={removeAll:true};return tent.changes.track(d,e)};tent.changes.isTracked=function(d){return d.__observable__&&d.__observable__ instanceof tent.changes.Observable};tent.changes.bind=function(d,e){var g;if(typeof e=="string"){g=e;e={bindings:[]}}else if(typeof e=="function")e={bindings:[{handler:e}]};else if(typeof e=="object"&&
typeof e.handle=="function")e={bindings:[{handler:e}]};if(arguments.length>2){if(e){if(!e.bindings)e.bindings=[]}else e={bindings:[]};for(var i=2;i<arguments.length;i++)e.bindings.push({eventType:g,handler:arguments[i]})}return tent.changes.track(d,e)};tent.changes.unbind=function(d,e){var g;if(typeof e=="string"){g=e;e={bindings:[]}}else if(typeof e=="function")e={bindings:[{handler:e}]};else if(typeof e=="object"&&typeof e.handle=="function")e={bindings:[{handler:e}]};if(arguments.length>2){if(e){if(!e.bindings)e.bindings=
[]}else e={bindings:[]};for(var i=2;i<arguments.length;i++)e.bindings.push({eventType:g,handler:arguments[i]})}if(e){if(!e.remove)e.remove=true}else e={remove:true};return tent.changes.track(d,e)}});tent.declare("tent.databinding",function(){var a=function(c,f,h,j,d){var e={};e.handle=function(g){var i=false;if(g.eventType==tent.changes.EventTypes.ADDED||g.eventType==tent.changes.EventTypes.REMOVED||g.eventType==tent.changes.EventTypes.CHANGED)if(d.deep)i=true;else{var k=c;if(g.subject==c)i=true;else for(var l=f.split("."),m=0;m<l.length;m++){var n=l[m];k=k[n];if(k==g.subject){i=true;break}}}else if(g.eventType==tent.changes.EventTypes.MANYCHANGES)i=true;if(i){g=c;k=null;if(f){l=f.split(".");
for(m=0;m<l.length;m++){n=l[m];k=g;g=g[n];if(g==null||typeof g=="undefined")break;else tent.changes.bind(g,{live:d.live,log:d.log,deepStack:[k],bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:this}]})}}l=h;if(n=j){k=j.split(".");for(m=0;m<k.length;m++){n=k[m];tgtParent=l;l=l[n];if(l==null||typeof l=="undefined"){if(m<k.length-1)i=false;break}}l=tgtParent}if(i)if(d.template)tent.databinding.parseTemplate(d.template,g,l,n);else{if(typeof d.format=="function")g=d.format(g);if(l[n]!=g)l[n]=
g}}};return e};tent.databinding.bind=function(c,f,h,j,d){d||(d={});var e=a(c,f,h,j,d);if(d.deep){if(d.bidirectional)throw"cannot use bidirectional databinding when using a deep tracking";tent.changes.bind(c,{deep:true,live:d.live,log:d.log,bindings:[{handler:e}]})}else{if(d.bidirectional){if(d.template)throw"cannot use bidirectional databinding when using a template";var g=a(h,j,c,f,d);tent.changes.bind(h,{live:d.live,log:d.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:g}]})}tent.changes.bind(c,
{live:d.live,log:d.log,bindings:[{eventType:tent.changes.EventTypes.CHANGED,handler:e}]})}c=!f?c:c[f];if(d.template)tent.databinding.parseTemplate(d.template,c,h,j);else if(h[j]!=c)h[j]=c};var b={};tent.databinding.parseTemplate=function(c,f,h,j){var d;try{var e=b[c];if(!e){var g="var p=[],print=function (){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").replace(/'(?=[^#]*#>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<#=(.+?)#>/g,"',$1,'").split("<#").join("');").split("#>").join("p.push('")+
"');}return p.join('');";e=new Function("obj",g);b[c]=e}d=e(f)}catch(i){d="< # ERROR: "+i.message+" # >"}if(h)if(j)h[j]=d;else h.innerHTML=d;return d}});tent.declare("tent.changes.reverseProperties",function(){tent.changes.reverseProperties.setReverseProperty=function(b,c,f){f||(f={});f.cardinality=f.cardinality?f.cardinality.toLowerCase():"11";if(!f.reverse)f.reverse=c+"Of";var h={name:f.reverse,cardinality:f.cardinality};if(f.cardinality.substr(0,1)==="n"||f.cardinality.substr(0,1)==="m")h.isArray=true;if(!b.__reverseProperties__)b.__reverseProperties__={};if(f.cardinality.substr(1,1)==="n"||f.cardinality.substr(1,1)==="m"){if(typeof b[c]=="undefined"||
!(b[c]instanceof Array))b[c]=[];b.__reverseProperties__[c]=h;b[c].__parent__=b;b[c].__reverseProperty__=h}else{if(typeof b[c]=="undefined")b[c]=null;b.__reverseProperties__[c]=h}};tent.changes.reverseProperties.setReverseProperties=function(b,c){if(c)for(var f in c)c[f].reverse&&tent.changes.reverseProperties.setReverseProperty(b,f,c[f])};tent.changes.reverseProperties.Set=function(b){this.properties=b};tent.changes.reverseProperties.Set.prototype.create=function(){var b={};this.applyTo(b);return b};
tent.changes.reverseProperties.Set.prototype.applyTo=function(){var b=[];b.bind=function(f){f||(f={});f.reverseProperties=true;for(var h=0;h<this.length;h++){var j=this[h];if(j.__reverseProperties__){tent.changes.bind(j,f);var d=j.__reverseProperties__,e;for(e in d)if(d.hasOwnProperty(e))if(d[e].cardinality&&(d[e].cardinality[1]=="n"||d[e].cardinality[1]=="m")){if(!(j[e]instanceof Array)){j[e]=[];j[e].__parent__=j;j[e].__reverseProperty__=j.__reverseProperties__[e]}tent.changes.bind(j[e],f)}}}};if(this.properties){for(var c=
0;c<arguments.length;c++)tent.changes.reverseProperties.setReverseProperties(arguments[c],this.properties);b.push.apply(b,arguments)}return b};var a;tent.changes.reverseProperties.getHandler=function(){a||(a=function(b){if(b.eventType==tent.changes.EventTypes.ADDED){var c=b.data.items;if(c&&b.subject&&b.subject.__reverseProperty__){var f=b.subject.__reverseProperty__;b=b.subject.__parent__;for(var h=0,j=c.length;h<j;h++){var d=c[h];if(f.isArray){d[f.name]||(d[f.name]=[]);d[f.name].indexOf(b)<0&&d[f.name].push(b)}else if(d[f.name]!=
b){if(typeof d[f.name]!="undefined"&&d[f.name]!=null)throw Error("this."+f.name+" is set. Remove this from its current array before adding it to this array");d[f.name]=b}}}}else if(b.eventType==tent.changes.EventTypes.REMOVED){if((c=b.data.items)&&b.subject&&b.subject.__reverseProperty__){f=b.subject.__reverseProperty__;b=b.subject.__parent__;h=0;for(j=c.length;h<j;h++){d=c[h];if(f.isArray){if(d=d[f.name])for(var e=0,g=d.length;e<g;e++)if(d[e]===b){d.splice(e,1);e--;g--}}else if(d[f.name]===b)d[f.name]=
null}}}else if(b.eventType==tent.changes.EventTypes.CHANGED)if(b.data.propertyName&&b.subject&&b.subject.__reverseProperties__)if(f=b.subject.__reverseProperties__[b.data.propertyName])if(f.isArray){if(d=b.data.oldValue){d=d[f.name];if(d instanceof Array){h=0;for(j=d.length;h<j;h++)if(d[h]===b.subject){d.splice(h,1);h--;j--}}}if(d=b.data.current){d[f.name]||(d[f.name]=[]);d[f.name]instanceof Array&&d[f.name].indexOf(b.subject)<0&&d[f.name].push(b.subject)}}else{if(d=b.data.oldValue)if(d[f.name]==
b.subject)d[f.name]=null;if(d=b.data.current)if(d[f.name]!=b.subject)d[f.name]=b.subject}});return a}});tent.declare("tent.entities",function(){tent.entities.ChangeStates=new tent.coreTypes.Enum("DETACHED,UNCHANGED,ADDED,MODIFIED,DELETED");tent.entities.Type=function(a,b){this.name=a;this.properties=b;if(b instanceof tent.changes.reverseProperties.Set)this.reversePropertySet=b;else if(typeof b=="object")this.reversePropertySet=new tent.changes.reverseProperties.Set(b);else throw"cannot create a Type without properties";};tent.entities.Type.prototype.toString=function(){return"EntityType("+this.name+
")"};tent.entities.Type.prototype.applyTo=function(){this.reversePropertySet.applyTo.apply(this.reversePropertySet,arguments);for(var a=0;a<arguments.length;a++){if(arguments[a].__entityType__!=this)arguments[a].__entityType__=this;for(var b in this.properties){var c=this.properties[b];if(typeof arguments[a][b]=="undefined")arguments[a][b]=!c.cardinality||c.cardinality.substr(1,1)==="1"?null:[]}}};tent.entities.Collection=function(a,b,c){this.context=a;this.type=b;this.name=c||b.name;this.items=[];
tent.arrays.extend(this.items)};tent.entities.Collection.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)this.push.apply(this,arguments[a]);else if(arguments[a].__collection__){if(arguments[a].__collection__!=this)throw"cannot add this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';
}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;this.items.push(arguments[a]);this.context.changeHandler&&this.context.changeHandler.itemAdded(arguments[a]);this.type&&this.context.__cascadePush__(arguments[a])}}return this.items.length};tent.entities.Collection.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays to a Collection";else if(arguments[a].__collection__){if(arguments[a].__collection__!=
this)throw"cannot attach this object, it already belongs to another Collection";}else{if(arguments[a].__entityType__){if(arguments[a].__entityType__!=this.type)throw'cannot add an object with EntityType "'+arguments[a].__entityType__.name+'" to this collection';}else this.type&&this.type.applyTo(arguments[a]);if(this.items.lastIndexOf(arguments[a])<0){arguments[a].__collection__=this;arguments[a].__changeState__!=tent.entities.ChangeStates.DELETED&&this.items.push(arguments[a]);this.context.changeHandler&&
this.context.changeHandler.itemAttached(arguments[a]);this.type&&this.context.__cascadeAttach__(arguments[a])}}return this.items.length};tent.entities.Collection.prototype.remove=function(){for(var a=false,b=0,c=arguments.length;b<c;b++){var f=arguments[b];if(this.items.remove(f)){a=true;this.context.changeHandler&&this.context.changeHandler.itemRemoved(arguments[b]);this.type&&this.context.__cascadeRemove__(f)}}return a};tent.entities.Collection.prototype.detach=function(){for(var a=false,b=0,c=
arguments.length;b<c;b++){var f=arguments[b];if(this.items.remove(f)||f.__changeState__==tent.entities.ChangeStates.DELETED){a=true;this.context.changeHandler&&this.context.changeHandler.itemDetached(f);delete f.__collection__;f.__entityType__&&this.context.__cascadeDetach__(f)}}return a};tent.entities.Collection.prototype.detachAll=function(){if(this.items.length<1)return false;for(var a=this.items.pop();typeof a!="undefined";){this.context.changeHandler&&this.context.changeHandler.itemDetached(a);
delete a.__collection__;a.__entityType__&&this.context.__cascadeDetach__(a);a=this.items.pop()}this.items.length=0;return true};tent.entities.Context=function(a){this.__collections__={};this.__types__={};a===true&&this.trackChanges();this.changes=null};tent.entities.MyContext=new tent.entities.Context;tent.entities.Context.prototype.all=function(){var a=[],b;for(b in this.__collections__)a.push.apply(a,this.__collections__[b].items);return a};tent.entities.Context.prototype.filter=function(a){var b=
[],c;for(c in this.__collections__)b.push.apply(b,this.__collections__[c].items.filter(a));return b};tent.entities.Context.prototype.contains=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b)if(b.__collection__){if(this.__collections__[b.__collection__.name]!=b.__collection__)return false}else if(b instanceof tent.entities.Type){if(this.__types__[b.name]!=b)return false}else if(b instanceof tent.entities.Collection){if(this!=b.context)return false}else return false;else return false}return true};
tent.entities.Context.prototype.createCollection=function(a,b){if(b){if(a&&!a instanceof tent.entities.Type)throw"provided type is not a Type instance";}else if(a)if(a instanceof tent.entities.Type)b=a.name;else if(typeof a=="string"){b=a;a=null}else throw"provide a Type or name to create a Collection";else b="_Object";if(!this.__collections__[b]){this.__collections__[b]=new tent.entities.Collection(this,a,b);for(var c=b;this[c];)c+="_";this[c]=this.__collections__[b]}return this.__collections__[b]};
tent.entities.Context.prototype.pushModel=function(a){if(a)if(a.types)for(var b in a.types)this.push(new tent.entities.Type(b,a.types[b]))};tent.entities.Context.prototype.push=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot push arrays into a Context";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot push this item, it belongs to another Context";}else if(arguments[a]instanceof tent.entities.Type){if(!arguments[a].name)throw"cannot add an EntityType without name";
if(this.__types__[arguments[a].name])if(this.__types__[arguments[a].name]==arguments[a])continue;else throw'EntityType "'+arguments[a].name+'" already exists';this.__types__[arguments[a].name]=arguments[a];this.createCollection(arguments[a])}else if(arguments[a]instanceof tent.entities.Context)throw"cannot add an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+
b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.createCollection(b).push(arguments[a])}};tent.entities.Context.prototype.attach=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof Array)throw"cannot attach arrays";else if(arguments[a].__collection__){if(arguments[a].__collection__.context!=this)throw"cannot attach this item, it belongs to another Context";}else if(arguments[a]instanceof tent.entities.Type)throw"cannot attach EntityTypes";else if(arguments[a]instanceof
tent.entities.Context)throw"cannot attach an EntityContext to an EntityContext";else if(typeof arguments[a]=="object"){var b=arguments[a].__entityType__;if(b)if(this.__types__[b.name]){if(this.__types__[b.name]!=b)throw'cannot add, object EntityType "'+b.name+'" differs from the Context one';}else this.__types__[b.name]=b;this.createCollection(b).attach(arguments[a])}};tent.entities.Context.prototype.remove=function(){for(var a=0;a<arguments.length;a++)if(arguments[a]instanceof tent.entities.Type)throw"cannot remove EntityTypes";
else if(arguments[a]instanceof tent.entities.Context)throw"cannot remove an EntityContext from an EntityContext";else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.remove(arguments[a])};tent.entities.Context.prototype.detach=function(){for(var a=0;a<arguments.length;a++){if(arguments[a]instanceof Array)throw"cannot detach arrays";if(arguments[a]instanceof tent.entities.Type)throw"cannot detach EntityTypes";else if(arguments[a]instanceof tent.entities.Context)throw"cannot detach an EntityContext from an EntityContext";
else typeof arguments[a]=="object"&&arguments[a].__collection__&&arguments[a].__collection__.detach(arguments[a])}};tent.entities.Context.prototype.detachAll=function(){for(var a=false,b=0;b<this.__collections__.length;b++)if(this.__collections__[b].detachAll())a=true;return a};tent.entities.Context.prototype.touch=function(){if(this.changeHandler)return this.changeHandler.touch.apply(this.changeHandler,arguments)};tent.entities.Context.prototype.__cascadePush__=function(){for(var a=0;a<arguments.length;a++){var b=
arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var f=b.__entityType__.properties[c];if(f.cascadePush){var h=null;if(f.collection)h=this.__collections__[f.collection]||this.createCollection(f.collection);if(b[c]instanceof Array){if(f.cardinality&&f.cardinality[1]!="1")h?h.push.apply(h,b[c]):this.push.apply(this,b[c])}else h?h.push(b[c]):this.push(b[c])}}}};tent.entities.Context.prototype.__cascadeAttach__=function(){for(var a=0;a<arguments.length;a++){var b=
arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var f=b.__entityType__.properties[c];if(f.cascadeAttach){var h=null;if(f.collection)h=this.__collections__[f.collection]||this.createCollection(f.collection);if(b[c]instanceof Array){if(f.cardinality&&f.cardinality[1]!="1")h?h.attach.apply(h,b[c]):this.attach.apply(this,b[c])}else h?h.attach(b[c]):this.attach(b[c])}}}};tent.entities.Context.prototype.__cascadeRemove__=function(){for(var a=
0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==null&&typeof b[c]=="object"){var f=b.__entityType__.properties[c];if(f.cascadeRemove)if(b[c]instanceof Array)f.cardinality&&f.cardinality[1]!="1"&&this.remove.apply(this,b[c]);else this.remove(b[c])}}};tent.entities.Context.prototype.__cascadeDetach__=function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.__entityType__)for(var c in b.__entityType__.properties)if(b[c]!==
null&&typeof b[c]=="object"){var f=b.__entityType__.properties[c];if(f.cascadeDetach)if(b[c]instanceof Array)f.cardinality&&f.cardinality[1]!="1"&&this.detach.apply(this,b[c]);else this.detach(b[c])}}};tent.entities.Context.prototype.trackChanges=function(){if(!this.changeHandler){this.changeHandler=new tent.entities.ContextChangeHandler(this);this.changeHandler.init()}};tent.entities.Context.prototype.hasChanges=function(){return!!(this.changes&&this.changes.items.length>0)};tent.entities.Context.prototype.acceptAllChanges=
function(){this.changeHandler&&this.changeHandler.acceptAllChanges()};tent.entities.Context.prototype.acceptChanges=function(){this.changeHandler&&this.changeHandler.acceptChanges.apply(this.changeHandler,arguments)};tent.entities.EntityLink=function(a,b,c,f){this.from=a;this.to=b;this.propertyName=c;this.__changeState__=f||tent.entities.ChangeStates.DETACHED};tent.entities.ContextChanges=function(a){this.context=a;this.items=[];tent.arrays.extend(this.items)};tent.entities.ContextChanges.prototype.toString=
function(){for(var a=new tent.coreTypes.NameCounter,b=0,c=this.items.length;b<c;b++)a.add(tent.entities.ChangeStates.getName(this.items[b].__changeState__)+"."+this.items[b].__collection__.name);return a.toString()};tent.entities.ContextChangeHandler=function(a){this.context=a};tent.entities.ContextChangeHandler.prototype.isDetached=function(a){return!a.__changeState__||a.__changeState__==tent.entities.ChangeStates.DETACHED};tent.entities.ContextChangeHandler.prototype.bindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var c=
a.__entityType__.properties[b];if(c.cardinality&&c.cardinality.substr(1,1)!="1"&&a[b]instanceof Array){a[b].__parent__=a;a[b].__propertyName__=b;tent.changes.bind(a[b],this)}}};tent.entities.ContextChangeHandler.prototype.unbindArrayProperties=function(a){if(a.__entityType__)for(var b in a.__entityType__.properties){var c=a.__entityType__.properties[b];c.cardinality&&c.cardinality.substr(1,1)!="1"&&a[b]instanceof Array&&tent.changes.unbind(a[b],this)}};tent.entities.ContextChangeHandler.prototype.trackComplexProperties=
function(a){if(a.__entityType__)for(var b in a.__entityType__.properties)a.__entityType__.properties[b].complex&&typeof a[b]=="object"&&tent.changes.track(a[b],{deep:true,attachedObjects:false,parentObject:a,parentObjectPropertyName:b});else for(b in a)b.substr(0,1)!=="_"&&a.hasOwnProperty(b)&&typeof a[b]=="object"&&tent.changes.track(a[b],{deep:true,attachedObjects:false,parentObject:a,parentObjectPropertyName:b})};tent.entities.ContextChangeHandler.prototype.setAdded=function(a){if(a.__changeState__!=
tent.entities.ChangeStates.ADDED)if(a.__collection__)if(a.__collection__.context==this.context){a.__changeState__=tent.entities.ChangeStates.ADDED;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else throw"cannot set this item as ADDED, it belongs to another Context";else a.__changeState__=tent.entities.ChangeStates.ADDED};tent.entities.ContextChangeHandler.prototype.setRemoved=function(a){if(!(this.isDetached(a)||
a.__changeState__==tent.entities.ChangeStates.DELETED))if(a.__collection__)if(a.__collection__.context==this.context)if(a.__changeState__==tent.entities.ChangeStates.UNCHANGED||a.__changeState__==tent.entities.ChangeStates.MODIFIED){a.__changeState__=tent.entities.ChangeStates.DELETED;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.pushUnique(a)}else{if(a.__changeState__==tent.entities.ChangeStates.ADDED){a.__changeState__=tent.entities.ChangeStates.DETACHED;
delete a.__collection__;if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);this.context.changes.items.remove(a)}}else throw"cannot set this item as DELETED, it belongs to another Context";else a.__changeState__=tent.entities.ChangeStates.DELETED};tent.entities.ContextChangeHandler.prototype.touch=function(){for(var a=0,b=arguments.length;a<b;a++)if(arguments[a]&&arguments[a].__changeState__==tent.entities.ChangeStates.UNCHANGED&&arguments[a].__collection__&&
arguments[a].__collection__.context==this.context){if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this);arguments[a].__changeState__=tent.entities.ChangeStates.MODIFIED;this.context.changes.items.pushUnique(arguments[a])}};tent.entities.ContextChangeHandler.prototype.itemAdded=function(a){if(this.isDetached(a))this.setAdded(a);else if(a.__changeState__!=tent.entities.ChangeStates.UNCHANGED){if(!this.context.changes)this.context.changes=new tent.entities.ContextChanges(this.context);
this.context.changes.items.pushUnique(a)}if(a.__changeState__!=tent.entities.ChangeStates.DELETED){tent.changes.bind(a,this);this.bindArrayProperties(a);this.trackComplexProperties(a)}};tent.entities.ContextChangeHandler.prototype.itemAttached=function(a){if(this.isDetached(a))a.__changeState__=tent.entities.ChangeStates.UNCHANGED;this.itemAdded(a)};tent.entities.ContextChangeHandler.prototype.itemRemoved=function(a){this.setRemoved(a);tent.changes.unbind(a,this);this.unbindArrayProperties(a)};tent.entities.ContextChangeHandler.prototype.itemDetached=
function(a){var b=this.context.changes;a.__changeState__!=tent.entities.ChangeStates.UNCHANGED&&b&&b.items.remove(a);delete a.__changeState__;tent.changes.unbind(a,this);this.unbindArrayProperties(a)};tent.entities.ContextChangeHandler.prototype.objectLinked=function(a,b,c,f){if(typeof f=="object")if(f instanceof Array){if(f.__parent__!=a){if(f.__parent__)throw"this array already has another parent object";f.__parent__=a}if(f.__propertyName__!=b)f.__propertyName__=b;tent.changes.bind(f,this);c.onLinkPush&&
this.context.attach.push(this.context,f)}else if(f!==null&&typeof f!="undefined"){if(f.__changeState__==tent.entities.ChangeStates.DELETED)throw'cannot link a DELETED object to property "'+c+'"';if(f.__collection__){if(f.__collection__.context!=this.context)throw"cannot link this object, it belongs to another Context";if(c.collection&&f.__collection__.name!=c.collection)throw"cannot link an object of collection "+c.collection+' to property "'+c+'"';}if(!f.__collection__&&c.onLinkPush){f.__entityType__&&
this.context.push(f.__entityType__);if(c.collection){if(!this.context.__collections__[c.collection])throw Error('Collection "'+c.collection+'" not found in this Context');this.context.__collections__[c.collection].push(f)}else this.context.push(f)}if(c.trackLinks){c=null;for(var h=this.context.changes.items.length-1;h>=0;h--){var j=this.context.changes.items[h];if(j instanceof tent.entities.EntityLink&&j.from===a&&j.to===f&&j.propertyName==b){c=j;break}}if(c){if(c.__changeState__==tent.entities.ChangeStates.DELETED)c.__changeState__=
tent.entities.ChangeStates.UNCHANGED}else{c=new tent.entities.EntityLink(a,f,b,tent.entities.ChangeStates.ADDED);this.context.changes.items.push(c)}}}};tent.entities.ContextChangeHandler.prototype.objectUnlinked=function(a,b,c,f){if(typeof f=="object")if(f instanceof Array){delete f.__parent__;delete f.__propertyName__;tent.changes.unbind(f,this);c.onUnlinkRemove&&this.context.remove.apply(this.context,f)}else if(f!==null&&typeof f!="undefined"){c.onUnlinkRemove&&f.__collection__&&f.__collection__.remove(f);
if(c.trackLinks){c=null;for(var h=-1,j=this.context.changes.items.length-1;j>=0;j--){var d=this.context.changes.items[j];if(d instanceof tent.entities.EntityLink&&d.from===a&&d.to===f&&d.propertyName==b){c=d;h=j;break}}if(c)if(c.__changeState__==tent.entities.ChangeStates.ADDED)this.context.changes.items.splice(h,1);else{if(c.__changeState__!=tent.entities.ChangeStates.DELETED)c.__changeState__=tent.entities.ChangeStates.DELETED}else{c=new tent.entities.EntityLink(a,f,b,tent.entities.ChangeStates.DELETED);
this.context.changes.items.push(c)}}}};tent.entities.ContextChangeHandler.prototype.getTrackedProperty=function(a,b){var c;if(a.__entityType__&&a.__changeState__&&a.__changeState__!=tent.entities.ChangeStates.DELETED&&a.__changeState__!=tent.entities.ChangeStates.DETACHED&&a.__collection__&&a.__collection__.context==this.context&&(c=a.__entityType__.properties[b]))return c};tent.entities.ContextChangeHandler.prototype.handle=function(a){if(a.subject){var b;if(a.eventType==tent.changes.EventTypes.CHANGED)if(a.subject.__entityType__){if(b=
this.getTrackedProperty(a.subject,a.data.propertyName)){this.context.touch(a.subject);this.objectUnlinked(a.subject,a.data.propertyName,b,a.data.oldValue);this.objectLinked(a.subject,a.data.propertyName,b,a.data.current)}}else this.context.touch(a.subject);else if(a.eventType==tent.changes.EventTypes.ADDED){var c=a.subject.__parent__;if(c&&(b=this.getTrackedProperty(c,a.data.propertyName)))for(var f=0,h=a.data.items.length;f<h;f++)this.objectLinked(c,a.data.propertyName,b,a.data.items[f])}else if(a.eventType==
tent.changes.EventTypes.REMOVED)if((c=a.subject.__parent__)&&(b=this.getTrackedProperty(c,a.data.propertyName))){f=0;for(h=a.data.items.length;f<h;f++)this.objectUnlinked(c,a.data.propertyName,b,a.data.items[f])}tent.changes.reverseProperties.getHandler()(a)}};tent.entities.ContextChangeHandler.prototype.init=function(){if(this.context.log)var a=new tent.coreTypes.NameCounter;for(var b in this.context.__collections__){for(var c=this.context.__collections__[b],f=0,h=c.items.length;f<h;f++)this.itemAttached(c.items[f]);
a&&a.add(b,c.items.length)}if(this.context.log)a&&a.root._count>0?tent.log.debug("Context: initialized with "+a):tent.log.debug("Context: initialized empty")};tent.entities.ContextChangeHandler.prototype.acceptAllChanges=function(){if(this.context.hasChanges()){this.context.log&&tent.log.debug("Context: accepting changes, "+this.context.changes);for(var a=this.context.changes.items,b=0,c=a.length;b<c;b++)a[b].__changeState__=tent.entities.ChangeStates.UNCHANGED;a.length=0;this.context.log&&tent.log.debug("Context: all changes accepted")}};
tent.entities.ContextChangeHandler.prototype.acceptChanges=function(){for(var a=0,b=arguments.length;a<b;a++){var c=arguments[a],f;if(typeof c=="number"){f=c;if(f<0||this.context.changes.items.length<f-1){c=null;f=-1}else c=this.context.changes.items[f]}else f=this.context.changes.items.lastIndexOf(c);if(f>=0&&c){this.context.changes.items.splice(f,1);if(c.__changeState__==tent.entities.ChangeStates.ADDED)c.__changeState__=tent.entities.ChangeStates.UNCHANGED;else if(c.__changeState__==tent.entities.ChangeStates.MODIFIED)c.__changeState__=
tent.entities.ChangeStates.UNCHANGED;else if(c.__changeState__==tent.entities.ChangeStates.DELETED)c.__changeState__=tent.entities.ChangeStates.DETACHED}}}});tent.declare("tent.persisters.rest",function(){tent.persisters.rest.uriCombine=function(){for(var a="",b=0,c=arguments.length;b<c;b++){var f=arguments[b]+"";if(f)if(f.match(/^[A-Za-z]+\:\/\//))a=f;else a+=a.substr(a.length-1,1)=="/"?f.substr(0,1)=="/"?f.substr(1):f.substr(0,2)=="./"?f.substr(2):f:f.substr(0,1)=="/"?f:f.substr(0,2)=="./"?f.substr(1):"/"+f}return a};tent.persisters.rest.createItemMapper=function(a){a||(a={});return function(b,c,f){if(b=b instanceof Array?b:c.multi?(c.multiSelector||
a.multiSelector||function(g,i){var k=i.multiSelectorProperty||a.multiSelectorProperty;if(k)return g[k];else for(var l in g)if(g[l]instanceof Array)return g[l]})(b,c):(c.singleSelector||a.singleSelector||function(g,i){var k=i.singleSelectorProperty||a.singleSelectorProperty;return k?[g[k]]:[g]})(b,c))for(var h=0,j=b.length;h<j;h++){var d=b[h];if(c.multi)d=(c.multiItemSelector||a.multiItemSelector||function(g,i){var k=i.multiItemSelectorProperty||a.multiItemSelectorProperty;return k?g[k]:g})(d,c);if(d){var e=
c.itemTransformer||a.itemTransformer;if(e)d=e(d,c)}d&&f(d,c)}}};tent.persisters.rest.createChangeSerializer=function(a){a||(a={});return function(b,c){var f=c.itemSerializer||a.itemSerializer||function(g){if(g instanceof tent.entities.EntityLink)return null;var i;if(g.__changeState__===tent.entities.ChangeStates.DELETED){i={};if(g.id)i._id=tent.pget(g,"id");if(g.rev)i.rev=tent.pget(g,"rev")}else i=tent.clone(g,{deep:true,onlyOwnProperties:true,attachedObjects:false,skipPrivates:true});if(g._id)i._id=
tent.pget(g,"_id");if(g._rev)i._rev=tent.pget(g,"_rev");if(g.__changeState__===tent.entities.ChangeStates.DELETED)i._deleted=true;return i};if(b instanceof Array)if(c.bulk){var h=[],j=c.batch||a.batch||0,d=j;if(!j||j<1)d=b.length;d=(c.offset||0)+d;if(c.limit&&c.limit<d)d=c.limit;j=c.offset||0;for(d=d;j<d;j++)h.push(f(b[j],c));var e=c.saveWrapperProperty||a.saveWrapperProperty||"docs";return(c.itemsSaveWrapper||a.itemsSaveWrapper||function(g){var i={};i[e]=g;return i})(h,c)}else return f(b[c.offset||
0],c);else if(typeof b=="object")return f(b,c)}};tent.persisters.rest.createChangeResponseMapper=function(a){a||(a={});return function(b,c,f){if(b=b instanceof Array?b:(c.resultSelector||a.resultSelector||function(g,i){if(!c.bulk)return[g];var k=i.resultSelectorProperty||a.resultSelectorProperty;if(k)return g[k];else for(var l in g)if(g[l]instanceof Array)return g[l]})(b,c))for(var h=0,j=b.length;h<j;h++){var d=b[h];if(d=(c.resultItemSelector||a.resultItemSelector||function(g,i){if(!i.bulk)return g;
var k=i.resultItemSelectorProperty||a.resultItemSelectorProperty;return k?g[k]:g})(d,c)){var e=c.resultItemTransformer||a.resultItemTransformer;if(e)d=e(d,c)}if(d){e=(c.localChangeFinder||a.localChangeFinder||function(g,i){if(g.hasChanges())for(var k=0,l=g.changes.items.length;k<l;k++){if(typeof i.id!="undefined"&&g.changes.items[k]._id===i.id)return k;if(typeof i.id!="undefined"&&g.changes.items[k].id===i.id)return k;if(typeof i._id!="undefined"&&g.changes.items[k]._id===i._id)return k;if(typeof i._id!=
"undefined"&&g.changes.items[k].id===i._id)return k}})(c.context,d,c);typeof e=="number"&&e>=0||c.unorderedResults||a.unorderedResults||(e=c.offset||0);typeof e=="number"&&e>=0&&f(d,e,c)}}}};tent.persisters.rest.RestPersister=function(){this.baseUri="http://127.0.0.1:5984/mydb";this.saving=false;this.savingErrors=[];this.loadingErrors=[];this.loadItemMapper=null;this.localItemFinder=function(a,b){return a.filter(function(c){if(typeof b._id!="undefined"&&c._id===b._id||typeof b.id!="undefined"&&c.id===
b.id)return true;return false})[0]};this.versionEquals=function(a,b){return a._rev===b._rev};this.updateLocalVersion=function(a,b){a._rev=b.rev||b._rev;if(typeof b.id!="undefined"&&b.id!==a._id)a._id=b.id};this.isDeleted=function(a){return a._deleted};this.bulkSaveUri=this.changeResponseMapper=this.changeSerializer=null;this.getChangeItemUri=function(a){if(a instanceof tent.entities.EntityLink)return null;var b=a._id||a.id||"/";if(a.__changeState__==tent.entities.ChangeStates.DELETED)if(a._rev)b+=
"?rev="+a._rev;else if(a.rev)b+="?rev="+a.rev;return b};this.getChangeItemMethod=function(a){if(a.__changeState__===tent.entities.ChangeStates.DELETED)return"DELETE";if(a.__changeState__===tent.entities.ChangeStates.MODIFIED)return"PUT";if(a._id||a.id)return"PUT";return"POST"}};tent.persisters.rest.RestPersister.prototype.load=function(a,b,c){try{if(!a)throw"a context is required for loading entities";if(!b)throw"an url must be specified to load";if(this.loading)throw"already loading entities";this.loading=
true;var f=this;c||(c={});var h=c.complete;c.complete=function(d){f.loading=false;d.error&&f.loadingErrors.push(d.error);h&&h(d)};this.__load__(a,b,c)}catch(j){this.loadingErrors.push(j);this.loading=false;c.complete&&c.complete({error:j})}};tent.persisters.rest.RestPersister.prototype.__load__=function(a,b,c){if(typeof jQuery=="undefined"||typeof jQuery.ajax=="undefined")throw"jQuery.ajax is required in order to load entities";b=tent.persisters.rest.uriCombine(this.baseUri,b);jQuery.ajax({context:{persister:this,
context:a,options:c},url:b,beforeSend:function(f){if(c.credentials){f.setRequestHeader("Origin",document.location.protocol+"//"+document.location.host);f.setRequestHeader("Authorization","Basic "+c.credentials)}},type:c.method||"GET",cache:!!c.cache,dataType:"json",success:function(f){var h={persister:this,options:c};try{this.persister.__processLoadResponse__(this.context,f,c,h);h.ok=true}catch(j){h.error=j}c.complete&&c.complete(h)},error:function(f,h,j){f={persister:this,options:c,error:{type:h,
errorThrown:j}};c.complete&&c.complete(f)}})};tent.persisters.rest.RestPersister.prototype.__processLoadResponse__=function(a,b,c){if(c.context!==a)c.context=a;if(!this.loadItemMapper)this.loadItemMapper=tent.persisters.rest.createItemMapper();var f=this;this.loadItemMapper(b,c,function(h){var j=f.localItemFinder(a,h);if(j)if(j.__changeState__===tent.entities.ChangeStates.MODIFIED||j.__changeState__===tent.entities.ChangeStates.DELETED)f.versionEquals(j,h)||j.__loadErrors__.push({error:"conflict",
reason:"document modified recently by another user"});else{if(f.isDeleted(h)){a.remove(j);a.detach(j)}else{tent.pset(j,h,true);a.changeHandler&&a.changeHandler.trackComplexProperties(j)}j.__loadErrors__&&delete j.__loadErrors__}else a.attach(h)})};tent.persisters.rest.RestPersister.prototype.saveChanges=function(a,b,c){try{if(!a)throw"a context is required for saving changes";b||(b={});if(b.context!==a)b.context=a;if(a.hasChanges()){if(this.saving)throw"Already saving changes";this.saving=true;var f=
this,h=b.complete;b.complete=function(d){f.saving=false;if(d.error)f.savingErrors.push(d.error);else if(typeof d.ok=="undefined")d.ok=true;if(d.ok&&!d.error&&b.context.hasChanges()&&(!b.maxcount||b.maxcount>d.count))f.saveChanges(b.context,b,d.count);else h&&h(d)};this.__persist__(a,b,c)}else b.complete&&b.complete({ok:true,nochanges:true})}catch(j){this.savingErrors.push(j);this.saving=false;b.complete&&b.complete({persister:this,options:b,error:j})}};tent.persisters.rest.RestPersister.prototype.__persist__=
function(a,b,c){if(typeof jQuery=="undefined"||typeof jQuery.ajax=="undefined")throw"jQuery.ajax is required in order to persist changes";var f,h,j,d;if(b.bulk){f=b.uri||this.bulkSaveUri;if(!f)throw"no bulk save uri provided";f=tent.persisters.rest.uriCombine(this.baseUri,f);j=this.__getPersistData__(a,b)}else{d=a.changes.items[b.offset||0];h=this.getChangeItemMethod(d);if(d=this.getChangeItemUri(d)){f=tent.persisters.rest.uriCombine(this.baseUri,d);j=this.__getPersistData__(a,b)}}if(j==null){a={persister:this,
options:b,ok:true,nochanges:true};b.complete&&b.complete(a)}else jQuery.ajax({context:{persister:this,context:a,options:b,prevCount:c},url:f,beforeSend:function(e){if(b.credentials){e.setRequestHeader("Origin",document.location.protocol+"//"+document.location.host);e.setRequestHeader("Authorization","Basic "+b.credentials)}},type:h||b.method||"POST",cache:false,data:JSON.stringify(j),dataType:"json",contentType:"application/json",success:function(e){var g={persister:this.persister,options:this.options};
try{this.persister.__processPersistResponse__(this.context,e,b,g);if(this.prevCount)g.count+=this.prevCount;g.ok=true}catch(i){g.error=i}b.complete&&b.complete(g)},error:function(e,g,i){e={persister:this.persister,options:this.options,error:{type:g,errorThrown:i}};if(this.prevCount)e.count+=this.prevCount;b.complete&&b.complete(e)}})};tent.persisters.rest.RestPersister.prototype.__getPersistData__=function(a,b){if(!this.changeSerializer)this.changeSerializer=tent.persisters.rest.createChangeSerializer();
var c=null;if(a.hasChanges())c=this.changeSerializer(a.changes.items,b);return c};tent.persisters.rest.RestPersister.prototype.__processPersistResponse__=function(a,b,c,f){if(a.hasChanges()){if(!this.changeResponseMapper)this.changeResponseMapper=tent.persisters.rest.createChangeResponseMapper();var h=this;this.changeResponseMapper(b,c,function(j,d){var e=a.changes.items[d];if(j.error){if(!e.__saveErrors__)e.__saveErrors__=[];e.__saveErrors__.push({error:j.error,reason:j.reason})}else{h.updateLocalVersion(e,
j);e.__saveErrors__&&delete e.__saveErrors__;a.acceptChanges(d);f.count=(f.count||0)+1}})}}});tent.declare("tent.persisters.couchdb",function(){tent.persisters.couchdb.CouchDBPersister=function(){tent.persisters.rest.RestPersister.apply(this,arguments);this.bulkSaveUri="_bulk_docs";this.loadItemMapper=tent.persisters.rest.createItemMapper({multiSelectorProperty:"rows",multiItemSelectorProperty:"doc"})};tent.mixin(tent.persisters.couchdb.CouchDBPersister,tent.persisters.rest.RestPersister)});
